---
phase: 07-e-invoicing-transmission
plan: 04
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - web-erp-app/backend/src/services/einvoice/tdd/tdd.types.ts
  - web-erp-app/backend/src/services/einvoice/tdd/tdd-builder.service.ts
  - web-erp-app/backend/src/services/einvoice/tdd/__tests__/tdd-builder.service.test.ts
  - web-erp-app/backend/src/services/einvoice/tdd/index.ts
autonomous: true

must_haves:
  truths:
    - "TDD extracts all FTA-mandatory tax fields from PINT-AE XML"
    - "Supplier TRN is extracted and validated (15 digits starting with 100)"
    - "Tax breakdown includes category code, taxable amount, tax amount, rate"
    - "Invoice hash (SHA-256) is included in TDD"
    - "TDD can be serialized to JSON for transmission"
  artifacts:
    - path: "web-erp-app/backend/src/services/einvoice/tdd/tdd-builder.service.ts"
      provides: "Tax Data Document builder service"
      exports: ["TddBuilderService"]
      min_lines: 300
    - path: "web-erp-app/backend/src/services/einvoice/tdd/tdd.types.ts"
      provides: "TDD type definitions"
      exports: ["TaxDataDocument", "TddTaxSubtotal", "TddDocumentType", "TddTransactionType"]
  key_links:
    - from: "tdd-builder.service.ts"
      to: "einvoice-archive.service.ts"
      via: "Reads archived XML content"
      pattern: "getArchive|xmlContent"
    - from: "tdd-builder.service.ts"
      to: "fast-xml-parser"
      via: "Parses PINT-AE XML"
      pattern: "XMLParser|parse"
---

<objective>
Create the TDD (Tax Data Dictionary) Builder Service that extracts tax-relevant data from PINT-AE e-invoices for FTA reporting.

Purpose: EINV-07 requires TDD compliance - the TDD is a tax-relevant subset of the full e-invoice that gets reported to FTA by ASPs. This service extracts mandatory fields from archived e-invoices.

Output:
- TDD type definitions matching FTA requirements
- TddBuilderService that parses PINT-AE XML and extracts TDD fields
- Unit tests covering extraction logic and edge cases
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-e-invoicing-transmission/07-CONTEXT.md
@.planning/phases/07-e-invoicing-transmission/07-RESEARCH.md
@web-erp-app/backend/src/services/einvoice/pint-ae-builder.service.ts
@web-erp-app/backend/src/services/einvoice/einvoice-archive.service.ts
@web-erp-app/backend/src/types/einvoice.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TDD Type Definitions</name>
  <files>web-erp-app/backend/src/services/einvoice/tdd/tdd.types.ts</files>
  <action>
Create directory and TDD type definitions:

```bash
mkdir -p web-erp-app/backend/src/services/einvoice/tdd
```

Define types based on 07-RESEARCH.md TDD structure:

1. **TddDocumentType enum**: INVOICE, CREDIT_NOTE, DEBIT_NOTE

2. **TddTransactionType enum**: STANDARD, REVERSE_CHARGE, EXEMPT, ZERO_RATED, OUT_OF_SCOPE

3. **TddTaxCategoryCode enum**: S (Standard), Z (Zero), E (Exempt), O (Out of scope), AE (Reverse charge)

4. **TddSupplier interface**:
   - trn: string (15-digit TRN, MANDATORY)
   - name: string (legal name)
   - nameArabic?: string (optional)
   - countryCode: string ('AE')
   - address?: object (street, city, postalCode, emirate)

5. **TddBuyer interface**:
   - trn?: string (TRN if B2B)
   - name: string (legal name)
   - nameArabic?: string
   - countryCode?: string

6. **TddAmounts interface**:
   - currencyCode: string (MANDATORY, 'AED')
   - taxExclusiveAmount: number (IBT-109)
   - taxAmount: number (IBT-110)
   - taxInclusiveAmount: number (IBT-112)
   - payableAmount: number (IBT-115)

7. **TddTaxSubtotal interface**:
   - taxCategoryCode: TddTaxCategoryCode
   - taxableAmount: number
   - taxAmount: number
   - taxPercent: number
   - exemptionReason?: string
   - exemptionReasonCode?: string

8. **TddClassification interface**:
   - transactionType: TddTransactionType
   - reverseCharge: boolean
   - freeZoneTransaction: boolean
   - exportTransaction: boolean

9. **TaxDataDocument interface** (main TDD):
   - tddId: string (UUID)
   - einvoiceReference: string
   - archiveId: string
   - documentType: TddDocumentType
   - documentNumber: string (IBT-001)
   - issueDate: string (IBT-002)
   - issueTime?: string
   - invoiceTypeCode: string (380, 381, 389)
   - dueDate?: string
   - taxPointDate?: string
   - billingReferences?: array (for credit notes)
   - supplier: TddSupplier
   - buyer: TddBuyer
   - amounts: TddAmounts
   - taxBreakdown: TddTaxSubtotal[]
   - classification: TddClassification
   - invoiceHash: string (SHA-256)
   - reportedBy: 'SENDER_ASP' | 'RECEIVER_ASP' | 'DIRECT'
   - reportedAt: Date
   - companyId: string

10. **TddBuildOptions interface**: includeOptionalFields, reportedBy

11. **TddBuildResult interface**: success, tdd?, errors?, warnings?

12. **TDD_XPATH_MAPPINGS constant**: Maps PINT-AE XPath to TDD fields

Also create index.ts for exports.
  </action>
  <verify>
    - `npx tsc --noEmit` compiles successfully
    - All types exported from index.ts
    - XPath mappings cover all mandatory PINT-AE fields
  </verify>
  <done>TDD types created with TaxDataDocument, TddSupplier, TddBuyer, TddTaxSubtotal, and XPath mappings for PINT-AE extraction</done>
</task>

<task type="auto">
  <name>Task 2: Create TDD Builder Service</name>
  <files>web-erp-app/backend/src/services/einvoice/tdd/tdd-builder.service.ts</files>
  <action>
Create the TDD Builder Service with these methods:

1. **buildFromArchive(archive, options)**: Main method
   - Parse XML using fast-xml-parser (removeNSPrefix: true for easier access)
   - Detect document type (Invoice vs CreditNote root)
   - Extract supplier info (TRN validation: /^100\d{12}$/)
   - Extract buyer info (warn if no TRN for B2B)
   - Extract amounts from LegalMonetaryTotal and TaxTotal
   - Extract tax breakdown from TaxSubtotal elements
   - Determine classification from tax categories
   - Include invoice hash from archive or calculate SHA-256
   - Return TddBuildResult with TaxDataDocument or errors

2. **buildFromXml(xml, metadata, options)**: Convenience wrapper
   - Create synthetic archive record
   - Call buildFromArchive

3. **Private helper methods**:
   - extractSupplier(invoice, errors): TddSupplier | null
   - extractBuyer(invoice, errors, warnings): TddBuyer | null
   - extractAmounts(invoice, errors): TddAmounts | null
   - extractTaxBreakdown(invoice, warnings): TddTaxSubtotal[]
   - determineClassification(invoice, taxBreakdown): TddClassification
   - extractBillingReferences(invoice): array | undefined
   - extractTrn(party): string | null
   - extractLegalName(party): string | null
   - extractArabicName(party): string | undefined
   - extractAddress(party): address | undefined
   - mapTaxCategory(code): TddTaxCategoryCode
   - calculateHash(content): string (SHA-256 hex)
   - getNestedValue(obj, path): unknown (dot notation)
   - getString(obj, key): string | null
   - getNumber(obj, key): number | null
   - extractAmount(obj, key): number | null (handles UBL amount format with currencyID)

Use @injectable() decorator for DI. Log success/failure with logger.

Error codes:
- TDD-001: Invalid XML (no Invoice/CreditNote root)
- TDD-010: Missing AccountingSupplierParty
- TDD-011: Missing supplier TRN
- TDD-012: Invalid TRN format
- TDD-020: Missing AccountingCustomerParty
- TDD-021: Missing buyer TRN (warning for B2C)
- TDD-030: Missing TaxExclusiveAmount
- TDD-040: Missing TaxTotal (warning)
- TDD-999: Unexpected error
  </action>
  <verify>
    - `npx tsc --noEmit` compiles successfully
    - Service is @injectable()
    - buildFromArchive returns TddBuildResult
    - TRN validation regex: /^100\d{12}$/
    - Hash calculation uses crypto.createHash('sha256')
  </verify>
  <done>TddBuilderService created with XML parsing, field extraction, TRN validation, classification detection, and hash calculation</done>
</task>

<task type="auto">
  <name>Task 3: Create TDD Builder Unit Tests</name>
  <files>web-erp-app/backend/src/services/einvoice/tdd/__tests__/tdd-builder.service.test.ts</files>
  <action>
Create comprehensive unit tests:

**Test fixtures**:
- createValidInvoiceXml(overrides): Helper to generate PINT-AE Invoice XML
- createValidCreditNoteXml(): Helper for CreditNote XML with BillingReference

**Test suites**:

1. **buildFromArchive - Happy Path**:
   - Should build TDD from valid invoice XML
   - Should extract supplier TRN correctly (100123456789012)
   - Should extract buyer information
   - Should extract amounts (taxExclusive, taxAmount, taxInclusive, payable)
   - Should extract tax breakdown (category, taxable, tax, percent)
   - Should classify standard transaction correctly
   - Should include invoice hash from archive
   - Should calculate hash if not provided (64 chars, hex)

2. **buildFromArchive - Credit Notes**:
   - Should detect credit note document type
   - Should set invoiceTypeCode to 381
   - Should extract billing references

3. **buildFromArchive - Validation Errors**:
   - Should fail for missing supplier TRN (TDD-011)
   - Should fail for invalid TRN format (TDD-012)
   - Should fail for invalid XML structure (TDD-001)
   - Should warn for missing buyer TRN (TDD-021) but succeed

4. **buildFromArchive - Tax Categories**:
   - Should detect reverse charge (AE category)
   - Should detect zero-rated (Z category)
   - Should detect exempt (E category)

5. **buildFromXml**:
   - Should build TDD from raw XML
   - Should accept custom reportedBy option

6. **TDD serialization**:
   - Should produce JSON-serializable TDD
   - Parsed JSON should have correct values

Each test should:
- Create service instance with new TddBuilderService()
- Use sample XML with valid PINT-AE structure
- Assert on result.success and result.tdd fields
  </action>
  <verify>
    - Run `npm test -- --testPathPattern=tdd-builder.service.test.ts`
    - All tests pass
    - Coverage includes extraction, validation, classification
  </verify>
  <done>Unit tests created covering TDD extraction from PINT-AE XML, credit notes, validation errors, tax category detection, and JSON serialization</done>
</task>

</tasks>

<verification>
1. TDD types: All TDD interfaces and enums defined
2. TDD Builder: Service parses PINT-AE XML and extracts all mandatory fields
3. Supplier TRN: Extracted and validated (15 digits starting with 100)
4. Amounts: Tax exclusive, tax amount, tax inclusive, payable extracted correctly
5. Tax breakdown: Category codes, taxable amounts, rates extracted
6. Classification: Transaction type determined from tax categories
7. Credit notes: Billing references extracted for credit/debit notes
8. Hash: Invoice hash included (from archive or calculated)
9. Tests: All unit tests pass
</verification>

<success_criteria>
1. TddBuilderService.buildFromArchive() parses PINT-AE XML and returns TaxDataDocument
2. Supplier TRN extracted and validated (error if missing or invalid format)
3. Tax breakdown includes all category codes with amounts and rates
4. Classification detects STANDARD, REVERSE_CHARGE, EXEMPT, ZERO_RATED transactions
5. Credit notes extract billing references to original invoice
6. Invoice hash (SHA-256) included in TDD for integrity
7. TDD can be serialized to JSON for transmission
8. Unit tests cover extraction, validation, and edge cases
</success_criteria>

<output>
After completion, create `.planning/phases/07-e-invoicing-transmission/07-04-SUMMARY.md`
</output>
