---
phase: 07-e-invoicing-transmission
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web-erp-app/backend/prisma/schema.prisma
  - web-erp-app/backend/prisma/migrations/YYYYMMDD_einvoice_transmission/migration.sql
  - web-erp-app/backend/src/types/einvoice-transmission.types.ts
autonomous: true

must_haves:
  truths:
    - "Transmission queue tracks e-invoice submission lifecycle"
    - "Credentials stored encrypted with AES-256-GCM"
    - "Status transitions enforce valid state machine"
    - "Transmission history retained for 7-year FTA compliance"
  artifacts:
    - path: "web-erp-app/backend/prisma/schema.prisma"
      provides: "Transmission models"
      contains: "model einvoice_transmissions"
    - path: "web-erp-app/backend/src/types/einvoice-transmission.types.ts"
      provides: "Transmission type definitions"
      exports: ["EInvoiceTransmissionStatus", "TransmissionMode", "ITransmissionProvider"]
  key_links:
    - from: "einvoice_transmissions"
      to: "einvoice_archives"
      via: "archiveId foreign key"
      pattern: "archiveId.*einvoice_archives"
    - from: "einvoice_credentials"
      to: "companies"
      via: "companyId foreign key"
      pattern: "companyId.*companies"
---

<objective>
Create transmission schema and types for e-invoice DCTCE/ASP integration. Schema supports queue management, status tracking, credential storage (encrypted), and transmission history.

Purpose: Foundation for EINV-07 through EINV-10 - enables transmission queue, status tracking, and credential management for UAE e-invoicing pilot.

Output: Prisma schema models and TypeScript types for e-invoice transmission.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-e-invoicing-transmission/07-CONTEXT.md
@.planning/phases/07-e-invoicing-transmission/07-RESEARCH.md
@web-erp-app/backend/src/types/einvoice.types.ts
@web-erp-app/backend/src/services/einvoice/asp-client.interface.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create transmission types and interfaces</name>
  <files>web-erp-app/backend/src/types/einvoice-transmission.types.ts</files>
  <action>
Create comprehensive TypeScript types for e-invoice transmission:

```typescript
/**
 * E-Invoice Transmission Types
 * Phase: 07-e-invoicing-transmission
 * Requirements: EINV-07 through EINV-10
 *
 * Types for DCTCE/ASP transmission, queue management, and credential storage.
 */

// ============================================================================
// TRANSMISSION STATUS (State Machine)
// ============================================================================

/**
 * E-invoice transmission status enum
 * Matches FTA DCTCE status vocabulary for clarity
 *
 * Flow: DRAFT -> QUEUED -> TRANSMITTING -> PENDING_CLEARANCE -> CLEARED/REJECTED/FAILED
 */
export enum EInvoiceTransmissionStatus {
  DRAFT = 'DRAFT',                    // Generated, not yet submitted
  QUEUED = 'QUEUED',                  // In transmission queue
  TRANSMITTING = 'TRANSMITTING',      // Currently being sent to DCTCE/ASP
  PENDING_CLEARANCE = 'PENDING_CLEARANCE', // Received by FTA, awaiting clearance
  CLEARED = 'CLEARED',                // Successfully cleared by FTA
  REJECTED = 'REJECTED',              // Rejected with validation errors
  FAILED = 'FAILED',                  // Transmission failure (network, auth, etc.)
}

/**
 * Valid status transitions - enforces state machine
 */
export const TRANSMISSION_STATUS_TRANSITIONS: Record<EInvoiceTransmissionStatus, EInvoiceTransmissionStatus[]> = {
  [EInvoiceTransmissionStatus.DRAFT]: [
    EInvoiceTransmissionStatus.QUEUED,
  ],
  [EInvoiceTransmissionStatus.QUEUED]: [
    EInvoiceTransmissionStatus.TRANSMITTING,
    EInvoiceTransmissionStatus.FAILED, // Queue processing failure
  ],
  [EInvoiceTransmissionStatus.TRANSMITTING]: [
    EInvoiceTransmissionStatus.PENDING_CLEARANCE,
    EInvoiceTransmissionStatus.REJECTED,
    EInvoiceTransmissionStatus.FAILED,
  ],
  [EInvoiceTransmissionStatus.PENDING_CLEARANCE]: [
    EInvoiceTransmissionStatus.CLEARED,
    EInvoiceTransmissionStatus.REJECTED,
  ],
  [EInvoiceTransmissionStatus.CLEARED]: [], // Terminal state
  [EInvoiceTransmissionStatus.REJECTED]: [], // Terminal - requires new submission after correction
  [EInvoiceTransmissionStatus.FAILED]: [
    EInvoiceTransmissionStatus.QUEUED, // Can retry
  ],
};

/**
 * Check if status transition is valid
 */
export function isValidTransmissionTransition(
  from: EInvoiceTransmissionStatus,
  to: EInvoiceTransmissionStatus
): boolean {
  return TRANSMISSION_STATUS_TRANSITIONS[from]?.includes(to) ?? false;
}

// ============================================================================
// TRANSMISSION MODE
// ============================================================================

/**
 * Transmission mode - tenant configuration choice
 */
export enum TransmissionMode {
  DIRECT_DCTCE = 'DIRECT_DCTCE',   // Direct FTA DCTCE connection
  ASP_PROVIDER = 'ASP_PROVIDER',   // Route through Accredited Service Provider
  SANDBOX = 'SANDBOX',             // FTA sandbox for testing
}

/**
 * Transmission environment
 */
export enum TransmissionEnvironment {
  SANDBOX = 'SANDBOX',
  PRODUCTION = 'PRODUCTION',
}

// ============================================================================
// TRANSMISSION PROVIDER INTERFACE
// ============================================================================

/**
 * Transmission result from provider
 */
export interface TransmissionResult {
  success: boolean;
  transmissionId: string;
  status: EInvoiceTransmissionStatus;
  ftaReferenceNumber?: string;      // FTA clearance reference
  clearanceNumber?: string;         // Final clearance number
  tddReference?: string;            // Tax Data Document reference
  mlsStatus?: string;               // Message Level Status
  errors?: TransmissionError[];
  warnings?: TransmissionError[];
  rawResponse?: unknown;            // Full response for debugging
  respondedAt?: Date;
}

/**
 * Transmission error structure
 */
export interface TransmissionError {
  code: string;
  message: string;
  field?: string;                   // Mapped to invoice field if possible
  severity: 'ERROR' | 'WARNING';
  ftaErrorCode?: string;            // Original FTA error code
}

/**
 * Transmission status check result
 */
export interface TransmissionStatusResult {
  transmissionId: string;
  status: EInvoiceTransmissionStatus;
  ftaReferenceNumber?: string;
  clearanceNumber?: string;
  tddReference?: string;
  mlsStatus?: string;
  lastUpdated: Date;
  errors?: TransmissionError[];
}

/**
 * Credential requirements for a provider
 */
export interface CredentialRequirement {
  field: string;
  label: string;
  type: 'text' | 'password' | 'certificate' | 'url';
  required: boolean;
  description: string;
  validation?: RegExp;
}

/**
 * Provider credentials (stored encrypted)
 */
export interface ProviderCredentials {
  provider: TransmissionMode;
  environment: TransmissionEnvironment;

  // DCTCE Direct credentials (OAuth 2.0)
  clientId?: string;
  clientSecret?: string;            // ENCRYPTED
  tokenEndpoint?: string;
  apiEndpoint?: string;

  // ASP credentials (API key)
  apiKey?: string;                  // ENCRYPTED
  aspEndpoint?: string;
  aspIdentifier?: string;

  // Cached OAuth token (auto-refreshed)
  accessToken?: string;             // ENCRYPTED
  tokenExpiresAt?: Date;
  refreshToken?: string;            // ENCRYPTED
}

/**
 * Transmission provider interface - implemented by DctceProvider, AspProvider, SandboxProvider
 */
export interface ITransmissionProvider {
  /**
   * Provider identifier
   */
  readonly providerId: TransmissionMode;

  /**
   * Transmit an e-invoice to DCTCE/ASP
   */
  transmit(archiveId: string, xml: string, metadata: TransmissionMetadata): Promise<TransmissionResult>;

  /**
   * Check status of a previous transmission
   */
  checkStatus(transmissionId: string): Promise<TransmissionStatusResult>;

  /**
   * Cancel a pending transmission (if supported)
   */
  cancelTransmission?(transmissionId: string): Promise<{ success: boolean; message?: string }>;

  /**
   * Get required credentials for this provider
   */
  getCredentialRequirements(): CredentialRequirement[];

  /**
   * Validate stored credentials are valid
   */
  validateCredentials(credentials: ProviderCredentials): Promise<boolean>;

  /**
   * Test provider connectivity
   */
  testConnection(): Promise<{ connected: boolean; latencyMs?: number; error?: string }>;

  /**
   * Check if provider supports the environment
   */
  supportsEnvironment(env: TransmissionEnvironment): boolean;

  /**
   * Check if provider is configured
   */
  isConfigured(): boolean;
}

/**
 * Metadata passed with transmission
 */
export interface TransmissionMetadata {
  companyId: string;
  einvoiceNumber: string;
  invoiceType: 'INVOICE' | 'CREDIT_NOTE' | 'DEBIT_NOTE';
  supplierTrn: string;
  recipientTrn?: string;
  totalAmount: string;
  vatAmount: string;
  currency: string;
  issueDate: string;
}

// ============================================================================
// QUEUE MANAGEMENT
// ============================================================================

/**
 * Queue item for batch processing
 */
export interface QueueItem {
  id: string;
  archiveId: string;
  companyId: string;
  status: EInvoiceTransmissionStatus;
  priority: number;                 // Higher = processed first
  retryCount: number;
  maxRetries: number;
  nextRetryAt?: Date;
  queuedAt: Date;
  lastAttemptAt?: Date;
  errorMessage?: string;
}

/**
 * Queue processing options
 */
export interface QueueProcessingOptions {
  batchSize: number;                // Items per batch (default: 50)
  concurrency: number;              // Parallel transmissions (default: 5)
  maxRetries: number;               // Max retry attempts (default: 3)
  retryDelayMs: number;             // Base retry delay (default: 1000)
  retryBackoffMultiplier: number;   // Backoff multiplier (default: 4)
  maxRetryWindowMs: number;         // Max retry window (default: 24 hours)
}

/**
 * Default queue processing options
 */
export const DEFAULT_QUEUE_OPTIONS: QueueProcessingOptions = {
  batchSize: 50,
  concurrency: 5,
  maxRetries: 3,
  retryDelayMs: 1000,               // 1s -> 4s -> 16s
  retryBackoffMultiplier: 4,
  maxRetryWindowMs: 24 * 60 * 60 * 1000, // 24 hours
};

// ============================================================================
// EXPORT TYPES
// ============================================================================

/**
 * Export format options
 */
export enum ExportFormat {
  XML = 'XML',                      // PINT-AE XML (FTA standard)
  JSON = 'JSON',                    // UBL-mapped JSON for API consumers
}

/**
 * Export filter options
 */
export interface ExportFilter {
  companyId: string;
  startDate?: Date;
  endDate?: Date;
  status?: EInvoiceTransmissionStatus[];
  format: ExportFormat;
  includeArchived?: boolean;
}

/**
 * Export result
 */
export interface ExportResult {
  success: boolean;
  format: ExportFormat;
  count: number;
  data?: string | object[];         // XML string or JSON array
  filename?: string;
  errors?: string[];
}

// ============================================================================
// TDD (TAX DATA DICTIONARY) TYPES - EINV-07
// ============================================================================

/**
 * TDD field definition
 */
export interface TddField {
  id: string;                       // TDD field ID (e.g., 'BT-1')
  name: string;                     // Field name
  path: string;                     // XPath in UBL
  required: boolean;
  dataType: 'string' | 'decimal' | 'date' | 'code';
  format?: string;                  // Format pattern
  maxLength?: number;
}

/**
 * TDD validation result
 */
export interface TddValidationResult {
  valid: boolean;
  errors: TddValidationError[];
  warnings: TddValidationError[];
}

/**
 * TDD validation error
 */
export interface TddValidationError {
  fieldId: string;
  fieldName: string;
  message: string;
  value?: string;
  severity: 'ERROR' | 'WARNING';
}

// ============================================================================
// MLS (MESSAGE LEVEL STATUS) TYPES - EINV-08
// ============================================================================

/**
 * MLS response status codes
 */
export enum MlsStatusCode {
  RECEIVED = 'RECEIVED',            // Message received by ASP/DCTCE
  PROCESSING = 'PROCESSING',        // Being processed
  VALIDATED = 'VALIDATED',          // Passed validation
  PENDING_CLEARANCE = 'PENDING_CLEARANCE', // Awaiting FTA clearance
  CLEARED = 'CLEARED',              // Cleared by FTA
  REJECTED = 'REJECTED',            // Rejected with errors
  FAILED = 'FAILED',                // Processing failed
}

/**
 * MLS response from ASP/DCTCE
 */
export interface MlsResponse {
  messageId: string;
  status: MlsStatusCode;
  timestamp: Date;
  ftaReferenceNumber?: string;
  clearanceNumber?: string;
  errors?: MlsError[];
  warnings?: MlsError[];
  rawResponse?: string;
}

/**
 * MLS error detail
 */
export interface MlsError {
  code: string;
  message: string;
  messageArabic?: string;           // Arabic error message for display
  field?: string;
  location?: string;                // XPath location in document
}

// ============================================================================
// CREDENTIAL ENCRYPTION CONSTANTS
// ============================================================================

/**
 * Credential encryption settings
 */
export const CREDENTIAL_ENCRYPTION = {
  ALGORITHM: 'aes-256-gcm',
  KEY_LENGTH: 32,                   // 256 bits
  IV_LENGTH: 16,                    // 128 bits
  AUTH_TAG_LENGTH: 16,              // 128 bits
} as const;

// ============================================================================
// RETENTION CONSTANTS
// ============================================================================

/**
 * FTA retention requirements
 */
export const TRANSMISSION_RETENTION = {
  YEARS: 7,                         // FTA 7-year retention
  WARNING_MONTHS: 6,                // Warn 6 months before expiry
} as const;
```
  </action>
  <verify>
    - `npx tsc --noEmit` compiles successfully
    - All enums and interfaces exported
    - State machine transitions defined
    - Provider interface complete
  </verify>
  <done>Transmission types and interfaces created with complete state machine and provider interface</done>
</task>

<task type="auto">
  <name>Task 2: Add transmission models to Prisma schema</name>
  <files>web-erp-app/backend/prisma/schema.prisma</files>
  <action>
Add the following models to the existing Prisma schema. Add after the existing `einvoice_archives` model:

```prisma
// ============================================================================
// E-INVOICE TRANSMISSION (Phase 7)
// ============================================================================

/// E-Invoice Transmission Status
enum EInvoiceTransmissionStatus {
  DRAFT
  QUEUED
  TRANSMITTING
  PENDING_CLEARANCE
  CLEARED
  REJECTED
  FAILED
}

/// Transmission Mode (tenant configuration)
enum TransmissionMode {
  DIRECT_DCTCE    // Direct FTA DCTCE connection
  ASP_PROVIDER    // Route through Accredited Service Provider
  SANDBOX         // FTA sandbox for testing
}

/// Transmission Environment
enum TransmissionEnvironment {
  SANDBOX
  PRODUCTION
}

/// E-Invoice Transmission record - tracks submission to DCTCE/ASP
model einvoice_transmissions {
  id                   String                      @id @default(uuid()) @db.Uuid
  companyId            String                      @map("company_id") @db.Uuid
  archiveId            String                      @map("archive_id") @db.Uuid

  // Transmission details
  transmissionMode     TransmissionMode            @default(SANDBOX) @map("transmission_mode")
  environment          TransmissionEnvironment     @default(SANDBOX)
  status               EInvoiceTransmissionStatus  @default(DRAFT)

  // Queue management
  priority             Int                         @default(0)
  retryCount           Int                         @default(0) @map("retry_count")
  maxRetries           Int                         @default(3) @map("max_retries")
  nextRetryAt          DateTime?                   @map("next_retry_at")
  queuedAt             DateTime?                   @map("queued_at")
  lastAttemptAt        DateTime?                   @map("last_attempt_at")

  // FTA/ASP response
  ftaReferenceNumber   String?                     @map("fta_reference_number")
  clearanceNumber      String?                     @map("clearance_number")
  tddReference         String?                     @map("tdd_reference")
  mlsStatus            String?                     @map("mls_status")

  // Error tracking
  errorCode            String?                     @map("error_code")
  errorMessage         String?                     @map("error_message")
  errorDetails         Json?                       @map("error_details")

  // Raw response for debugging
  rawRequest           String?                     @map("raw_request") @db.Text
  rawResponse          String?                     @map("raw_response") @db.Text

  // Timestamps
  transmittedAt        DateTime?                   @map("transmitted_at")
  clearedAt            DateTime?                   @map("cleared_at")
  rejectedAt           DateTime?                   @map("rejected_at")
  createdAt            DateTime                    @default(now()) @map("created_at")
  updatedAt            DateTime                    @updatedAt @map("updated_at")

  // User tracking
  submittedById        String?                     @map("submitted_by_id") @db.Uuid

  // Relations
  company              companies                   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  archive              einvoice_archives           @relation(fields: [archiveId], references: [id], onDelete: Restrict)
  submittedBy          users?                      @relation("TransmissionSubmitter", fields: [submittedById], references: [id])
  statusHistory        einvoice_transmission_history[]

  // Indexes
  @@index([companyId])
  @@index([archiveId])
  @@index([status])
  @@index([queuedAt])
  @@index([nextRetryAt])
  @@index([transmittedAt])
  @@map("einvoice_transmissions")
}

/// E-Invoice Transmission Status History - audit trail for status changes
model einvoice_transmission_history {
  id              String                      @id @default(uuid()) @db.Uuid
  transmissionId  String                      @map("transmission_id") @db.Uuid

  // Status change
  fromStatus      EInvoiceTransmissionStatus? @map("from_status")
  toStatus        EInvoiceTransmissionStatus  @map("to_status")

  // Context
  reason          String?
  errorCode       String?                     @map("error_code")
  errorMessage    String?                     @map("error_message")

  // User and timestamp
  changedById     String?                     @map("changed_by_id") @db.Uuid
  changedAt       DateTime                    @default(now()) @map("changed_at")

  // Relations
  transmission    einvoice_transmissions      @relation(fields: [transmissionId], references: [id], onDelete: Cascade)
  changedBy       users?                      @relation("TransmissionHistoryChanger", fields: [changedById], references: [id])

  @@index([transmissionId])
  @@index([changedAt])
  @@map("einvoice_transmission_history")
}

/// E-Invoice Credentials - encrypted ASP/DCTCE credentials per company
model einvoice_credentials {
  id                      String                  @id @default(uuid()) @db.Uuid
  companyId               String                  @unique @map("company_id") @db.Uuid

  // Mode configuration
  transmissionMode        TransmissionMode        @default(SANDBOX) @map("transmission_mode")
  activeEnvironment       TransmissionEnvironment @default(SANDBOX) @map("active_environment")

  // DCTCE credentials (encrypted)
  dctceClientId           String?                 @map("dctce_client_id")
  dctceClientSecretEnc    String?                 @map("dctce_client_secret_enc") @db.Text
  dctceTokenEndpoint      String?                 @map("dctce_token_endpoint")
  dctceApiEndpoint        String?                 @map("dctce_api_endpoint")

  // ASP credentials (encrypted)
  aspApiKeyEnc            String?                 @map("asp_api_key_enc") @db.Text
  aspEndpoint             String?                 @map("asp_endpoint")
  aspIdentifier           String?                 @map("asp_identifier")
  aspProviderName         String?                 @map("asp_provider_name")

  // Cached OAuth token (encrypted, auto-refreshed)
  accessTokenEnc          String?                 @map("access_token_enc") @db.Text
  tokenExpiresAt          DateTime?               @map("token_expires_at")
  refreshTokenEnc         String?                 @map("refresh_token_enc") @db.Text

  // Encryption metadata
  encryptionIv            String?                 @map("encryption_iv")
  encryptionAuthTag       String?                 @map("encryption_auth_tag")

  // Configuration metadata
  configuredById          String?                 @map("configured_by_id") @db.Uuid
  configuredAt            DateTime?               @map("configured_at")
  lastValidatedAt         DateTime?               @map("last_validated_at")
  isValid                 Boolean                 @default(false) @map("is_valid")

  // Connection health
  lastConnectionTestAt    DateTime?               @map("last_connection_test_at")
  lastConnectionSuccess   Boolean?                @map("last_connection_success")
  lastConnectionError     String?                 @map("last_connection_error")

  // Timestamps
  createdAt               DateTime                @default(now()) @map("created_at")
  updatedAt               DateTime                @updatedAt @map("updated_at")

  // Relations
  company                 companies               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  configuredBy            users?                  @relation("CredentialConfigurer", fields: [configuredById], references: [id])

  @@map("einvoice_credentials")
}

/// E-Invoice Transmission Configuration - queue and retry settings per company
model einvoice_transmission_config {
  id                       String                  @id @default(uuid()) @db.Uuid
  companyId                String                  @unique @map("company_id") @db.Uuid

  // Queue settings
  batchSize                Int                     @default(50) @map("batch_size")
  concurrency              Int                     @default(5)
  maxRetries               Int                     @default(3) @map("max_retries")
  retryDelayMs             Int                     @default(1000) @map("retry_delay_ms")
  retryBackoffMultiplier   Int                     @default(4) @map("retry_backoff_multiplier")
  maxRetryWindowHours      Int                     @default(24) @map("max_retry_window_hours")

  // Rate limiting
  maxTransmissionsPerHour  Int                     @default(100) @map("max_transmissions_per_hour")
  maxTransmissionsPerDay   Int                     @default(1000) @map("max_transmissions_per_day")

  // Notification settings
  notifyOnRejection        Boolean                 @default(true) @map("notify_on_rejection")
  notifyOnFailure          Boolean                 @default(true) @map("notify_on_failure")
  notifyOnClearance        Boolean                 @default(false) @map("notify_on_clearance")
  notificationEmail        String?                 @map("notification_email")

  // Feature flags
  autoSubmitEnabled        Boolean                 @default(false) @map("auto_submit_enabled")
  bulkSubmitEnabled        Boolean                 @default(false) @map("bulk_submit_enabled")

  // Timestamps
  createdAt                DateTime                @default(now()) @map("created_at")
  updatedAt                DateTime                @updatedAt @map("updated_at")

  // Relations
  company                  companies               @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("einvoice_transmission_config")
}
```

Also add these relation fields to the `companies` model:

```prisma
// In the companies model, add:
einvoiceTransmissions      einvoice_transmissions[]
einvoiceCredentials        einvoice_credentials?
einvoiceTransmissionConfig einvoice_transmission_config?
```

Add these relation fields to the `users` model:

```prisma
// In the users model, add:
transmissionsSubmitted     einvoice_transmissions[] @relation("TransmissionSubmitter")
transmissionHistoryChanges einvoice_transmission_history[] @relation("TransmissionHistoryChanger")
credentialsConfigured      einvoice_credentials[] @relation("CredentialConfigurer")
```

Add this relation field to the `einvoice_archives` model:

```prisma
// In the einvoice_archives model, add:
transmissions              einvoice_transmissions[]
```
  </action>
  <verify>
    - `npx prisma validate` passes without errors
    - `npx prisma format` formats schema correctly
    - All relations properly defined
  </verify>
  <done>Transmission models added to Prisma schema with proper relations</done>
</task>

<task type="auto">
  <name>Task 3: Generate Prisma client and create migration</name>
  <files>web-erp-app/backend/prisma/migrations/</files>
  <action>
Generate Prisma client and create migration:

1. Generate Prisma client to validate schema:
```bash
cd web-erp-app/backend
npx prisma generate
```

2. Create migration (do NOT run db push - just create the migration file):
```bash
npx prisma migrate dev --create-only --name einvoice_transmission
```

3. Review the generated migration SQL for:
   - `einvoice_transmissions` table with all columns
   - `einvoice_transmission_history` table for audit trail
   - `einvoice_credentials` table with encrypted fields
   - `einvoice_transmission_config` table for settings
   - All indexes created
   - All foreign key constraints

4. The migration should include:
   - CREATE TYPE statements for new enums
   - CREATE TABLE statements for all 4 new tables
   - CREATE INDEX statements for performance
   - ALTER TABLE for foreign key relations

Note: Migration should NOT be applied yet (use --create-only). It will be applied during deployment.
  </action>
  <verify>
    - `npx prisma generate` succeeds
    - Migration file created in `prisma/migrations/`
    - Migration SQL includes all 4 tables
    - No errors in Prisma validation
  </verify>
  <done>Prisma client generated and migration created (not applied)</done>
</task>

</tasks>

<verification>
1. Types compile: `npx tsc --noEmit` passes
2. Schema valid: `npx prisma validate` passes
3. Client generated: `npx prisma generate` succeeds
4. Migration created: Migration file exists in `prisma/migrations/`
5. State machine: `TRANSMISSION_STATUS_TRANSITIONS` defines valid transitions
6. Encryption constants: AES-256-GCM settings defined
7. Relations: All foreign keys properly defined
</verification>

<success_criteria>
1. `EInvoiceTransmissionStatus` enum defines 7 states matching FTA workflow
2. `ITransmissionProvider` interface defines contract for DCTCE/ASP providers
3. `einvoice_transmissions` model tracks queue lifecycle with retry support
4. `einvoice_credentials` model stores encrypted ASP/DCTCE credentials
5. `einvoice_transmission_history` provides audit trail for status changes
6. `einvoice_transmission_config` allows per-company queue settings
7. All relations to `companies`, `users`, `einvoice_archives` properly defined
8. Indexes on frequently queried columns (status, companyId, queuedAt)
</success_criteria>

<output>
After completion, create `.planning/phases/07-e-invoicing-transmission/07-01-SUMMARY.md`
</output>
