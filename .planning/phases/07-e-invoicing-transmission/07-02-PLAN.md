---
phase: 07-e-invoicing-transmission
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - web-erp-app/backend/src/types/einvoice-transmission-permissions.ts
  - web-erp-app/backend/src/middleware/einvoice-transmission.middleware.ts
  - web-erp-app/backend/prisma/seeds/einvoice-transmission-permissions.seed.ts
autonomous: true

must_haves:
  truths:
    - "22 granular permissions defined across 6 categories"
    - "6 role bundles map permissions to organizational roles"
    - "SoD conflicts prevent dangerous permission combinations"
    - "MFA requirements enforced for sensitive operations"
    - "Permission middleware integrates with pack-role system"
  artifacts:
    - path: "web-erp-app/backend/src/types/einvoice-transmission-permissions.ts"
      provides: "Transmission permission constants and role bundles"
      exports: ["EINVOICE_TRANSMISSION_PERMISSIONS", "EINVOICE_TRANSMISSION_PERMISSION_BUNDLES", "EINVOICE_SOD_CONFLICTS", "MFA_REQUIRED_OPERATIONS"]
      min_lines: 300
    - path: "web-erp-app/backend/src/middleware/einvoice-transmission.middleware.ts"
      provides: "Transmission permission middleware"
      exports: ["requireEInvoiceTransmissionPermission", "requireMfaForTransmission", "checkSodConflicts"]
    - path: "web-erp-app/backend/prisma/seeds/einvoice-transmission-permissions.seed.ts"
      provides: "Transmission permissions seed"
      exports: ["seedEInvoiceTransmissionPermissions"]
  key_links:
    - from: "einvoice-transmission.middleware.ts"
      to: "EINVOICE_TRANSMISSION_PERMISSIONS"
      via: "permission constant import"
      pattern: "import.*EINVOICE_TRANSMISSION_PERMISSIONS"
    - from: "einvoice-transmission-permissions.seed.ts"
      to: "permissions table"
      via: "prisma upsert"
      pattern: "prisma\\.permissions\\.upsert"
---

<objective>
Create comprehensive permission system for e-invoice transmission with 22 granular permissions, 6 role bundles, SoD conflict detection, and MFA requirements for sensitive operations.

Purpose: Access control foundation per superuser-access-management-framework.md and 07-RESEARCH.md - ensures proper separation of duties and credential security.

Output: Permission constants, middleware, and seed script for e-invoice transmission.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-e-invoicing-transmission/07-CONTEXT.md
@.planning/phases/07-e-invoicing-transmission/07-RESEARCH.md
@web-erp-app/backend/src/types/wps-permissions.ts
@web-erp-app/backend/src/middleware/wps-permissions.middleware.ts
@web-erp-app/backend/src/types/einvoice-permissions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create transmission permissions constants</name>
  <files>web-erp-app/backend/src/types/einvoice-transmission-permissions.ts</files>
  <action>
Create comprehensive permission constants following the WPS/VAT patterns:

```typescript
/**
 * E-Invoice Transmission Permission Types
 * Phase: 07-e-invoicing-transmission
 * Requirements: EINV-07 through EINV-10
 *
 * Defines 22 granular permissions across 6 categories for e-invoice transmission.
 * Includes role bundles, SoD conflicts, and MFA requirements per superuser framework.
 *
 * Permission format: einvoicing:{resource}:{action}
 *
 * @module einvoice-transmission-permissions
 */

// ============================================================================
// PERMISSION CONSTANTS (22 total)
// ============================================================================

/**
 * E-Invoice Transmission Permissions
 *
 * Categories:
 * 1. Queue Management (4 permissions)
 * 2. Transmission Operations (3 permissions)
 * 3. Credential Management (2 permissions) - Superuser scope
 * 4. Configuration (3 permissions)
 * 5. Export (3 permissions)
 * 6. Audit (2 permissions)
 * 7. Status & Monitoring (5 permissions - bonus category)
 */
export const EINVOICE_TRANSMISSION_PERMISSIONS = {
  // ============================================
  // 1. QUEUE MANAGEMENT
  // ============================================
  /** View transmission queue */
  QUEUE_VIEW: 'einvoicing:queue:view',
  /** Submit invoices to queue */
  QUEUE_SUBMIT: 'einvoicing:queue:submit',
  /** Retry failed transmissions */
  QUEUE_RETRY: 'einvoicing:queue:retry',
  /** Cancel queued transmissions */
  QUEUE_CANCEL: 'einvoicing:queue:cancel',

  // ============================================
  // 2. TRANSMISSION OPERATIONS
  // ============================================
  /** Submit to FTA sandbox */
  TRANSMIT_SANDBOX: 'einvoicing:transmit:sandbox',
  /** Submit to FTA production */
  TRANSMIT_PRODUCTION: 'einvoicing:transmit:production',
  /** Bulk submission operations */
  TRANSMIT_BULK: 'einvoicing:transmit:bulk',

  // ============================================
  // 3. CREDENTIAL MANAGEMENT (Superuser scope)
  // ============================================
  /** View credential status (not values) */
  CREDENTIALS_VIEW: 'einvoicing:credentials:view',
  /** Configure ASP/DCTCE credentials */
  CREDENTIALS_MANAGE: 'einvoicing:credentials:manage',

  // ============================================
  // 4. CONFIGURATION
  // ============================================
  /** View transmission settings */
  CONFIG_VIEW: 'einvoicing:config:view',
  /** Edit transmission settings */
  CONFIG_EDIT: 'einvoicing:config:edit',
  /** Switch sandbox/production mode */
  MODE_SWITCH: 'einvoicing:mode:switch',

  // ============================================
  // 5. EXPORT (EINV-10)
  // ============================================
  /** Export as PINT-AE XML */
  EXPORT_XML: 'einvoicing:export:xml',
  /** Export as JSON */
  EXPORT_JSON: 'einvoicing:export:json',
  /** Bulk export operations */
  EXPORT_BULK: 'einvoicing:export:bulk',

  // ============================================
  // 6. AUDIT (FTA Compliance)
  // ============================================
  /** View transmission audit logs */
  AUDIT_VIEW: 'einvoicing:audit:view',
  /** Export audit logs for FTA */
  AUDIT_EXPORT: 'einvoicing:audit:export',

  // ============================================
  // 7. STATUS & MONITORING
  // ============================================
  /** View transmission status */
  STATUS_VIEW: 'einvoicing:status:view',
  /** Export status reports */
  STATUS_EXPORT: 'einvoicing:status:export',
  /** Test connection to DCTCE/ASP */
  CONNECTION_TEST: 'einvoicing:connection:test',
  /** View dashboard widgets */
  DASHBOARD_VIEW: 'einvoicing:dashboard:view',
  /** Receive status notifications */
  NOTIFICATIONS_MANAGE: 'einvoicing:notifications:manage',
} as const;

/**
 * Type for transmission permission codes
 */
export type EInvoiceTransmissionPermission =
  (typeof EINVOICE_TRANSMISSION_PERMISSIONS)[keyof typeof EINVOICE_TRANSMISSION_PERMISSIONS];

/**
 * All transmission permission codes as array
 */
export const ALL_TRANSMISSION_PERMISSIONS = Object.values(EINVOICE_TRANSMISSION_PERMISSIONS);

// ============================================================================
// ROLE-BASED PERMISSION BUNDLES (6 roles)
// ============================================================================

/**
 * Role-based permission bundles for e-invoice transmission
 *
 * Follows separation of duties principle per FTA and superuser framework.
 */
export const EINVOICE_TRANSMISSION_PERMISSION_BUNDLES = {
  /**
   * E-INVOICE CLERK - Basic queue and status viewing
   *
   * Responsibilities:
   * - View queue and status
   * - Export individual invoices
   * - View audit logs
   *
   * Cannot: Submit, retry, configure, manage credentials
   */
  EINVOICE_CLERK: [
    EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.STATUS_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_XML,
    EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_JSON,
    EINVOICE_TRANSMISSION_PERMISSIONS.AUDIT_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.DASHBOARD_VIEW,
  ],

  /**
   * E-INVOICE OPERATOR - Can submit to sandbox, retry failed
   *
   * Responsibilities:
   * - All Clerk permissions
   * - Submit to queue
   * - Retry failed transmissions
   * - Submit to sandbox environment
   * - View configuration
   *
   * Cannot: Production submission, bulk operations, credentials, mode switch
   */
  EINVOICE_OPERATOR: [
    EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_SUBMIT,
    EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_RETRY,
    EINVOICE_TRANSMISSION_PERMISSIONS.STATUS_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_SANDBOX,
    EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_XML,
    EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_JSON,
    EINVOICE_TRANSMISSION_PERMISSIONS.AUDIT_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.CONFIG_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.CONNECTION_TEST,
    EINVOICE_TRANSMISSION_PERMISSIONS.DASHBOARD_VIEW,
  ],

  /**
   * E-INVOICE MANAGER - Full transmission authority except credentials
   *
   * Responsibilities:
   * - All Operator permissions
   * - Cancel queue items
   * - Production submission
   * - Bulk operations
   * - Export bulk data
   * - Export audit logs
   *
   * Cannot: Manage credentials, switch environments
   */
  EINVOICE_MANAGER: [
    EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_SUBMIT,
    EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_RETRY,
    EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_CANCEL,
    EINVOICE_TRANSMISSION_PERMISSIONS.STATUS_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.STATUS_EXPORT,
    EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_SANDBOX,
    EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_PRODUCTION,
    EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_BULK,
    EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_XML,
    EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_JSON,
    EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_BULK,
    EINVOICE_TRANSMISSION_PERMISSIONS.CONFIG_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.AUDIT_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.AUDIT_EXPORT,
    EINVOICE_TRANSMISSION_PERMISSIONS.CONNECTION_TEST,
    EINVOICE_TRANSMISSION_PERMISSIONS.DASHBOARD_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.NOTIFICATIONS_MANAGE,
  ],

  /**
   * FINANCE ADMIN - Full access including credentials and mode switch
   *
   * Responsibilities:
   * - All Manager permissions
   * - Manage ASP/DCTCE credentials
   * - Edit configuration
   * - Switch sandbox/production mode
   */
  FINANCE_ADMIN: [
    ...Object.values(EINVOICE_TRANSMISSION_PERMISSIONS),
  ],

  /**
   * CFO - Full access (approves production mode switch)
   *
   * Same as Finance Admin - both have ultimate authority.
   * CFO typically approves initial production mode switch.
   */
  CFO: [
    ...Object.values(EINVOICE_TRANSMISSION_PERMISSIONS),
  ],

  /**
   * AUDITOR - Read-only access to all transmission data and logs
   *
   * Responsibilities:
   * - View queue, status, configuration
   * - Export data for audit
   * - View and export audit logs
   *
   * Cannot: Submit, retry, cancel, configure, manage credentials
   */
  AUDITOR: [
    EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.STATUS_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.STATUS_EXPORT,
    EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_XML,
    EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_JSON,
    EINVOICE_TRANSMISSION_PERMISSIONS.CONFIG_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.CREDENTIALS_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.AUDIT_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.AUDIT_EXPORT,
    EINVOICE_TRANSMISSION_PERMISSIONS.DASHBOARD_VIEW,
  ],
} as const;

/**
 * Type for transmission role bundle names
 */
export type EInvoiceTransmissionRoleBundle = keyof typeof EINVOICE_TRANSMISSION_PERMISSION_BUNDLES;

// ============================================================================
// SEPARATION OF DUTIES (SoD) CONFLICTS
// ============================================================================

/**
 * SoD conflict definition
 */
export interface SodConflict {
  roleA: EInvoiceTransmissionPermission[];
  roleB: EInvoiceTransmissionPermission[];
  reason: string;
  severity: 'ERROR' | 'WARNING';
}

/**
 * SoD conflicts for e-invoice transmission
 *
 * These permission combinations should NEVER be held by the same user.
 */
export const EINVOICE_SOD_CONFLICTS: SodConflict[] = [
  {
    roleA: ['einvoice:generate:create' as EInvoiceTransmissionPermission], // From Phase 6
    roleB: [EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_PRODUCTION],
    reason: 'Invoice creation must be separate from production submission - prevents self-approval',
    severity: 'ERROR',
  },
  {
    roleA: [EINVOICE_TRANSMISSION_PERMISSIONS.CREDENTIALS_MANAGE],
    roleB: [EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_PRODUCTION],
    reason: 'Credential management must be separate from transmission authority - prevents credential misuse',
    severity: 'ERROR',
  },
  {
    roleA: [EINVOICE_TRANSMISSION_PERMISSIONS.MODE_SWITCH],
    roleB: [EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_BULK],
    reason: 'Mode switching must be separate from bulk operations - prevents unauthorized production bulk submissions',
    severity: 'ERROR',
  },
  {
    roleA: [EINVOICE_TRANSMISSION_PERMISSIONS.CONFIG_EDIT],
    roleB: [EINVOICE_TRANSMISSION_PERMISSIONS.AUDIT_EXPORT],
    reason: 'Configuration authority should be separate from audit evidence export - prevents evidence tampering',
    severity: 'WARNING',
  },
];

/**
 * Check if a user's permissions have SoD conflicts
 */
export function checkSodConflicts(
  userPermissions: string[]
): { hasConflicts: boolean; conflicts: SodConflict[] } {
  const conflicts: SodConflict[] = [];

  for (const sodRule of EINVOICE_SOD_CONFLICTS) {
    const hasRoleA = sodRule.roleA.some((p) => userPermissions.includes(p));
    const hasRoleB = sodRule.roleB.some((p) => userPermissions.includes(p));

    if (hasRoleA && hasRoleB) {
      conflicts.push(sodRule);
    }
  }

  return {
    hasConflicts: conflicts.length > 0,
    conflicts,
  };
}

// ============================================================================
// MFA REQUIREMENTS
// ============================================================================

/**
 * Operations requiring MFA per superuser framework
 */
export const MFA_REQUIRED_OPERATIONS: EInvoiceTransmissionPermission[] = [
  EINVOICE_TRANSMISSION_PERMISSIONS.CREDENTIALS_MANAGE,
  EINVOICE_TRANSMISSION_PERMISSIONS.MODE_SWITCH,
  EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_PRODUCTION, // First submission only
  EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_BULK, // Always for bulk
];

/**
 * Check if operation requires MFA
 */
export function requiresMfa(permission: EInvoiceTransmissionPermission): boolean {
  return MFA_REQUIRED_OPERATIONS.includes(permission);
}

// ============================================================================
// PERMISSION METADATA
// ============================================================================

/**
 * Permission metadata for UI and documentation
 */
export interface TransmissionPermissionInfo {
  code: EInvoiceTransmissionPermission;
  name: string;
  description: string;
  category: string;
  requiresMfa: boolean;
  isSuperuser: boolean;
}

/**
 * Permission info for all transmission permissions
 */
export const TRANSMISSION_PERMISSION_INFO: Record<EInvoiceTransmissionPermission, TransmissionPermissionInfo> = {
  // Queue Management
  [EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_VIEW]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_VIEW,
    name: 'View Transmission Queue',
    description: 'View the list of queued e-invoices pending transmission',
    category: 'Queue Management',
    requiresMfa: false,
    isSuperuser: false,
  },
  [EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_SUBMIT]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_SUBMIT,
    name: 'Submit to Queue',
    description: 'Add e-invoices to the transmission queue',
    category: 'Queue Management',
    requiresMfa: false,
    isSuperuser: false,
  },
  [EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_RETRY]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_RETRY,
    name: 'Retry Failed Transmissions',
    description: 'Retry e-invoices that failed to transmit',
    category: 'Queue Management',
    requiresMfa: false,
    isSuperuser: false,
  },
  [EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_CANCEL]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_CANCEL,
    name: 'Cancel Queued Transmissions',
    description: 'Cancel e-invoices waiting in the transmission queue',
    category: 'Queue Management',
    requiresMfa: false,
    isSuperuser: false,
  },

  // Transmission Operations
  [EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_SANDBOX]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_SANDBOX,
    name: 'Transmit to Sandbox',
    description: 'Submit e-invoices to FTA sandbox environment for testing',
    category: 'Transmission Operations',
    requiresMfa: false,
    isSuperuser: false,
  },
  [EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_PRODUCTION]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_PRODUCTION,
    name: 'Transmit to Production',
    description: 'Submit e-invoices to FTA production environment',
    category: 'Transmission Operations',
    requiresMfa: true,
    isSuperuser: false,
  },
  [EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_BULK]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_BULK,
    name: 'Bulk Transmission',
    description: 'Submit multiple e-invoices in a single batch',
    category: 'Transmission Operations',
    requiresMfa: true,
    isSuperuser: false,
  },

  // Credential Management (Superuser)
  [EINVOICE_TRANSMISSION_PERMISSIONS.CREDENTIALS_VIEW]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.CREDENTIALS_VIEW,
    name: 'View Credential Status',
    description: 'View ASP/DCTCE credential configuration status (not actual values)',
    category: 'Credential Management',
    requiresMfa: false,
    isSuperuser: true,
  },
  [EINVOICE_TRANSMISSION_PERMISSIONS.CREDENTIALS_MANAGE]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.CREDENTIALS_MANAGE,
    name: 'Manage Credentials',
    description: 'Configure ASP/DCTCE credentials for e-invoice transmission',
    category: 'Credential Management',
    requiresMfa: true,
    isSuperuser: true,
  },

  // Configuration
  [EINVOICE_TRANSMISSION_PERMISSIONS.CONFIG_VIEW]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.CONFIG_VIEW,
    name: 'View Configuration',
    description: 'View transmission settings and queue configuration',
    category: 'Configuration',
    requiresMfa: false,
    isSuperuser: false,
  },
  [EINVOICE_TRANSMISSION_PERMISSIONS.CONFIG_EDIT]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.CONFIG_EDIT,
    name: 'Edit Configuration',
    description: 'Modify transmission settings such as retry limits and batch sizes',
    category: 'Configuration',
    requiresMfa: false,
    isSuperuser: false,
  },
  [EINVOICE_TRANSMISSION_PERMISSIONS.MODE_SWITCH]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.MODE_SWITCH,
    name: 'Switch Environment Mode',
    description: 'Switch between sandbox and production transmission modes',
    category: 'Configuration',
    requiresMfa: true,
    isSuperuser: true,
  },

  // Export
  [EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_XML]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_XML,
    name: 'Export XML',
    description: 'Export e-invoices in PINT-AE XML format',
    category: 'Export',
    requiresMfa: false,
    isSuperuser: false,
  },
  [EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_JSON]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_JSON,
    name: 'Export JSON',
    description: 'Export e-invoices in JSON format for API integration',
    category: 'Export',
    requiresMfa: false,
    isSuperuser: false,
  },
  [EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_BULK]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_BULK,
    name: 'Bulk Export',
    description: 'Export multiple e-invoices with date range and status filters',
    category: 'Export',
    requiresMfa: false,
    isSuperuser: false,
  },

  // Audit
  [EINVOICE_TRANSMISSION_PERMISSIONS.AUDIT_VIEW]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.AUDIT_VIEW,
    name: 'View Audit Logs',
    description: 'View transmission audit logs for FTA compliance',
    category: 'Audit',
    requiresMfa: false,
    isSuperuser: false,
  },
  [EINVOICE_TRANSMISSION_PERMISSIONS.AUDIT_EXPORT]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.AUDIT_EXPORT,
    name: 'Export Audit Logs',
    description: 'Export audit logs for FTA submission or external review',
    category: 'Audit',
    requiresMfa: false,
    isSuperuser: false,
  },

  // Status & Monitoring
  [EINVOICE_TRANSMISSION_PERMISSIONS.STATUS_VIEW]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.STATUS_VIEW,
    name: 'View Status',
    description: 'View transmission status and FTA clearance details',
    category: 'Status & Monitoring',
    requiresMfa: false,
    isSuperuser: false,
  },
  [EINVOICE_TRANSMISSION_PERMISSIONS.STATUS_EXPORT]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.STATUS_EXPORT,
    name: 'Export Status Reports',
    description: 'Export transmission status reports',
    category: 'Status & Monitoring',
    requiresMfa: false,
    isSuperuser: false,
  },
  [EINVOICE_TRANSMISSION_PERMISSIONS.CONNECTION_TEST]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.CONNECTION_TEST,
    name: 'Test Connection',
    description: 'Test connectivity to DCTCE/ASP endpoints',
    category: 'Status & Monitoring',
    requiresMfa: false,
    isSuperuser: false,
  },
  [EINVOICE_TRANSMISSION_PERMISSIONS.DASHBOARD_VIEW]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.DASHBOARD_VIEW,
    name: 'View Dashboard',
    description: 'View transmission dashboard widgets and statistics',
    category: 'Status & Monitoring',
    requiresMfa: false,
    isSuperuser: false,
  },
  [EINVOICE_TRANSMISSION_PERMISSIONS.NOTIFICATIONS_MANAGE]: {
    code: EINVOICE_TRANSMISSION_PERMISSIONS.NOTIFICATIONS_MANAGE,
    name: 'Manage Notifications',
    description: 'Configure transmission status notification preferences',
    category: 'Status & Monitoring',
    requiresMfa: false,
    isSuperuser: false,
  },
};

// ============================================================================
// PERMISSION GROUPS (for UI categorization)
// ============================================================================

/**
 * Permission groups for UI display and batch operations
 */
export const TRANSMISSION_PERMISSION_GROUPS: Record<string, EInvoiceTransmissionPermission[]> = {
  'Queue Management': [
    EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_SUBMIT,
    EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_RETRY,
    EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_CANCEL,
  ],
  'Transmission Operations': [
    EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_SANDBOX,
    EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_PRODUCTION,
    EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_BULK,
  ],
  'Credential Management': [
    EINVOICE_TRANSMISSION_PERMISSIONS.CREDENTIALS_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.CREDENTIALS_MANAGE,
  ],
  'Configuration': [
    EINVOICE_TRANSMISSION_PERMISSIONS.CONFIG_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.CONFIG_EDIT,
    EINVOICE_TRANSMISSION_PERMISSIONS.MODE_SWITCH,
  ],
  'Export': [
    EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_XML,
    EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_JSON,
    EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_BULK,
  ],
  'Audit': [
    EINVOICE_TRANSMISSION_PERMISSIONS.AUDIT_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.AUDIT_EXPORT,
  ],
  'Status & Monitoring': [
    EINVOICE_TRANSMISSION_PERMISSIONS.STATUS_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.STATUS_EXPORT,
    EINVOICE_TRANSMISSION_PERMISSIONS.CONNECTION_TEST,
    EINVOICE_TRANSMISSION_PERMISSIONS.DASHBOARD_VIEW,
    EINVOICE_TRANSMISSION_PERMISSIONS.NOTIFICATIONS_MANAGE,
  ],
};

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

/**
 * Check if a value is a valid transmission permission
 */
export function isTransmissionPermission(value: string): value is EInvoiceTransmissionPermission {
  return Object.values(EINVOICE_TRANSMISSION_PERMISSIONS).includes(value as EInvoiceTransmissionPermission);
}

/**
 * Get permissions for a role bundle
 */
export function getPermissionsForRole(role: EInvoiceTransmissionRoleBundle): EInvoiceTransmissionPermission[] {
  return [...EINVOICE_TRANSMISSION_PERMISSION_BUNDLES[role]];
}

/**
 * Get permission info
 */
export function getPermissionInfo(permission: EInvoiceTransmissionPermission): TransmissionPermissionInfo {
  return TRANSMISSION_PERMISSION_INFO[permission];
}

/**
 * Get superuser-only permissions
 */
export function getSuperuserPermissions(): EInvoiceTransmissionPermission[] {
  return Object.values(EINVOICE_TRANSMISSION_PERMISSIONS).filter(
    (p) => TRANSMISSION_PERMISSION_INFO[p]?.isSuperuser
  );
}
```
  </action>
  <verify>
    - `npx tsc --noEmit` compiles successfully
    - 22 permissions exported in EINVOICE_TRANSMISSION_PERMISSIONS
    - 6 role bundles defined in EINVOICE_TRANSMISSION_PERMISSION_BUNDLES
    - SoD conflicts defined with checkSodConflicts function
    - MFA_REQUIRED_OPERATIONS array includes 4 sensitive operations
  </verify>
  <done>Transmission permissions constants created with 22 permissions, 6 roles, SoD, and MFA requirements</done>
</task>

<task type="auto">
  <name>Task 2: Create transmission permission middleware</name>
  <files>web-erp-app/backend/src/middleware/einvoice-transmission.middleware.ts</files>
  <action>
Create permission middleware following the WPS middleware pattern:

```typescript
/**
 * E-Invoice Transmission Permission Middleware
 * Phase: 07-e-invoicing-transmission
 *
 * Middleware for checking transmission permissions, MFA, and SoD.
 *
 * @module einvoice-transmission.middleware
 */

import { Request, Response, NextFunction } from 'express';
import { AuthRequest } from '../types/express';
import {
  EINVOICE_TRANSMISSION_PERMISSIONS,
  EInvoiceTransmissionPermission,
  requiresMfa,
  checkSodConflicts,
  TRANSMISSION_PERMISSION_INFO,
} from '../types/einvoice-transmission-permissions';
import logger from '../services/logger.service';
import prisma from '../config/database';

// ============================================================================
// PERMISSION MIDDLEWARE
// ============================================================================

/**
 * Require specific e-invoice transmission permission
 */
export function requireEInvoiceTransmissionPermission(permission: EInvoiceTransmissionPermission) {
  return async (req: Request, res: Response, next: NextFunction) => {
    try {
      const authReq = req as AuthRequest;
      const userId = authReq.user?.id;
      const companyId = authReq.query.companyId as string || authReq.body?.companyId;

      if (!userId) {
        return res.status(401).json({
          success: false,
          message: 'Authentication required',
        });
      }

      // Check permission using pack-role system
      const hasPermission = await checkUserTransmissionPermission(userId, permission, companyId);

      if (!hasPermission) {
        logger.security('[E-Invoice Transmission] Permission denied', {
          userId,
          companyId,
          permission,
          path: req.path,
          method: req.method,
        });

        return res.status(403).json({
          success: false,
          message: `Permission denied: ${permission} required`,
          permissionInfo: TRANSMISSION_PERMISSION_INFO[permission],
        });
      }

      // Check package validity
      const packageValid = await checkUaeCompliancePackageValid(companyId);
      if (!packageValid) {
        logger.security('[E-Invoice Transmission] Package expired', {
          userId,
          companyId,
          permission,
        });

        return res.status(403).json({
          success: false,
          message: 'UAE_COMPLIANCE package not active or expired',
          code: 'PACKAGE_EXPIRED',
        });
      }

      next();
    } catch (error) {
      logger.error('[E-Invoice Transmission] Permission check error:', error);
      res.status(500).json({
        success: false,
        message: 'Permission check failed',
      });
    }
  };
}

/**
 * Require any of the specified transmission permissions
 */
export function requireAnyTransmissionPermission(permissions: EInvoiceTransmissionPermission[]) {
  return async (req: Request, res: Response, next: NextFunction) => {
    try {
      const authReq = req as AuthRequest;
      const userId = authReq.user?.id;
      const companyId = authReq.query.companyId as string || authReq.body?.companyId;

      if (!userId) {
        return res.status(401).json({
          success: false,
          message: 'Authentication required',
        });
      }

      for (const permission of permissions) {
        const hasPermission = await checkUserTransmissionPermission(userId, permission, companyId);
        if (hasPermission) {
          // Also check package validity
          const packageValid = await checkUaeCompliancePackageValid(companyId);
          if (packageValid) {
            return next();
          }
        }
      }

      logger.security('[E-Invoice Transmission] Permission denied (any)', {
        userId,
        companyId,
        permissions,
        path: req.path,
      });

      return res.status(403).json({
        success: false,
        message: `Permission denied: one of [${permissions.join(', ')}] required`,
      });
    } catch (error) {
      logger.error('[E-Invoice Transmission] Permission check error:', error);
      res.status(500).json({
        success: false,
        message: 'Permission check failed',
      });
    }
  };
}

/**
 * Require all specified transmission permissions
 */
export function requireAllTransmissionPermissions(permissions: EInvoiceTransmissionPermission[]) {
  return async (req: Request, res: Response, next: NextFunction) => {
    try {
      const authReq = req as AuthRequest;
      const userId = authReq.user?.id;
      const companyId = authReq.query.companyId as string || authReq.body?.companyId;

      if (!userId) {
        return res.status(401).json({
          success: false,
          message: 'Authentication required',
        });
      }

      for (const permission of permissions) {
        const hasPermission = await checkUserTransmissionPermission(userId, permission, companyId);
        if (!hasPermission) {
          logger.security('[E-Invoice Transmission] Permission denied (all)', {
            userId,
            companyId,
            missingPermission: permission,
            path: req.path,
          });

          return res.status(403).json({
            success: false,
            message: `Permission denied: ${permission} required`,
          });
        }
      }

      // Check package validity
      const packageValid = await checkUaeCompliancePackageValid(companyId);
      if (!packageValid) {
        return res.status(403).json({
          success: false,
          message: 'UAE_COMPLIANCE package not active or expired',
          code: 'PACKAGE_EXPIRED',
        });
      }

      next();
    } catch (error) {
      logger.error('[E-Invoice Transmission] Permission check error:', error);
      res.status(500).json({
        success: false,
        message: 'Permission check failed',
      });
    }
  };
}

// ============================================================================
// MFA MIDDLEWARE
// ============================================================================

/**
 * Require MFA verification for sensitive operations
 *
 * Must be used AFTER requireEInvoiceTransmissionPermission
 */
export function requireMfaForTransmission(permission: EInvoiceTransmissionPermission) {
  return async (req: Request, res: Response, next: NextFunction) => {
    try {
      // Check if this operation requires MFA
      if (!requiresMfa(permission)) {
        return next();
      }

      const authReq = req as AuthRequest;
      const userId = authReq.user?.id;
      const mfaToken = req.headers['x-mfa-token'] as string;
      const mfaVerified = authReq.user?.mfaVerified;

      // Check if MFA was already verified in this session
      if (mfaVerified) {
        return next();
      }

      // Check if MFA token provided
      if (!mfaToken) {
        logger.security('[E-Invoice Transmission] MFA required but not provided', {
          userId,
          permission,
          path: req.path,
        });

        return res.status(403).json({
          success: false,
          message: 'MFA verification required for this operation',
          code: 'MFA_REQUIRED',
          permissionInfo: TRANSMISSION_PERMISSION_INFO[permission],
        });
      }

      // Verify MFA token (integrate with existing MFA service)
      const mfaValid = await verifyMfaToken(userId, mfaToken);
      if (!mfaValid) {
        logger.security('[E-Invoice Transmission] MFA verification failed', {
          userId,
          permission,
          path: req.path,
        });

        return res.status(403).json({
          success: false,
          message: 'MFA verification failed',
          code: 'MFA_INVALID',
        });
      }

      // Log successful MFA verification for audit
      logger.info('[E-Invoice Transmission] MFA verification successful', {
        userId,
        permission,
        path: req.path,
      });

      next();
    } catch (error) {
      logger.error('[E-Invoice Transmission] MFA check error:', error);
      res.status(500).json({
        success: false,
        message: 'MFA verification failed',
      });
    }
  };
}

// ============================================================================
// SOD MIDDLEWARE
// ============================================================================

/**
 * Check SoD conflicts before allowing permission assignment
 *
 * Used when assigning roles/permissions to users
 */
export async function checkSodConflictsMiddleware(
  req: Request,
  res: Response,
  next: NextFunction
) {
  try {
    const authReq = req as AuthRequest;
    const { userId, permissionsToAdd } = req.body;

    if (!userId || !permissionsToAdd) {
      return next(); // Not a permission assignment request
    }

    // Get user's current permissions
    const currentPermissions = await getUserPermissions(userId);

    // Check combined permissions for SoD conflicts
    const allPermissions = [...currentPermissions, ...permissionsToAdd];
    const { hasConflicts, conflicts } = checkSodConflicts(allPermissions);

    if (hasConflicts) {
      const errorConflicts = conflicts.filter((c) => c.severity === 'ERROR');
      const warningConflicts = conflicts.filter((c) => c.severity === 'WARNING');

      if (errorConflicts.length > 0) {
        logger.security('[E-Invoice Transmission] SoD conflict detected', {
          targetUserId: userId,
          performedBy: authReq.user?.id,
          conflicts: errorConflicts,
        });

        return res.status(400).json({
          success: false,
          message: 'Separation of Duties conflict detected',
          code: 'SOD_CONFLICT',
          conflicts: errorConflicts.map((c) => ({
            reason: c.reason,
            conflictingPermissions: {
              roleA: c.roleA,
              roleB: c.roleB,
            },
          })),
        });
      }

      // Log warnings but allow
      if (warningConflicts.length > 0) {
        logger.warn('[E-Invoice Transmission] SoD warning (allowed)', {
          targetUserId: userId,
          performedBy: authReq.user?.id,
          conflicts: warningConflicts,
        });
      }
    }

    next();
  } catch (error) {
    logger.error('[E-Invoice Transmission] SoD check error:', error);
    res.status(500).json({
      success: false,
      message: 'SoD validation failed',
    });
  }
}

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

/**
 * Check if user has transmission permission via pack-role system
 */
async function checkUserTransmissionPermission(
  userId: string,
  permission: string,
  companyId?: string
): Promise<boolean> {
  try {
    // Query pack-role system for permission
    const result = await prisma.$queryRaw<{ count: bigint }[]>`
      SELECT COUNT(*) as count
      FROM permissions p
      JOIN "rolePermission" rp ON p.id = rp."permissionId"
      JOIN "userRole_New" ur ON rp."roleId" = ur."roleId"
      WHERE ur."userId" = ${userId}::uuid
        AND p.code = ${permission}
        AND p."isActive" = true
    `;

    return Number(result[0]?.count || 0) > 0;
  } catch (error) {
    logger.error('[E-Invoice Transmission] Permission query error:', error);
    return false;
  }
}

/**
 * Check if company's UAE_COMPLIANCE package is valid
 */
async function checkUaeCompliancePackageValid(companyId?: string): Promise<boolean> {
  if (!companyId) {
    return false;
  }

  try {
    const result = await prisma.$queryRaw<{ count: bigint }[]>`
      SELECT COUNT(*) as count
      FROM "company_packages" cp
      JOIN packages pkg ON cp."packageId" = pkg.id
      WHERE cp."companyId" = ${companyId}::uuid
        AND pkg.code = 'UAE_COMPLIANCE'
        AND pkg."isActive" = true
        AND (cp."expiresAt" IS NULL OR cp."expiresAt" > NOW())
    `;

    return Number(result[0]?.count || 0) > 0;
  } catch (error) {
    logger.error('[E-Invoice Transmission] Package check error:', error);
    return false;
  }
}

/**
 * Verify MFA token
 */
async function verifyMfaToken(userId: string, token: string): Promise<boolean> {
  // TODO: Integrate with actual MFA service
  // For now, implement basic TOTP verification
  try {
    // This should call the actual MFA verification service
    // Example: return await mfaService.verifyTotp(userId, token);

    // Placeholder - return true in development
    if (process.env.NODE_ENV === 'development') {
      return true;
    }

    return false;
  } catch (error) {
    logger.error('[E-Invoice Transmission] MFA verification error:', error);
    return false;
  }
}

/**
 * Get all permissions for a user
 */
async function getUserPermissions(userId: string): Promise<string[]> {
  try {
    const result = await prisma.$queryRaw<{ code: string }[]>`
      SELECT DISTINCT p.code
      FROM permissions p
      JOIN "rolePermission" rp ON p.id = rp."permissionId"
      JOIN "userRole_New" ur ON rp."roleId" = ur."roleId"
      WHERE ur."userId" = ${userId}::uuid
        AND p."isActive" = true
    `;

    return result.map((r) => r.code);
  } catch (error) {
    logger.error('[E-Invoice Transmission] Get user permissions error:', error);
    return [];
  }
}

// ============================================================================
// EXPORTS
// ============================================================================

export {
  checkUserTransmissionPermission,
  checkUaeCompliancePackageValid,
  getUserPermissions,
};
```
  </action>
  <verify>
    - `npx tsc --noEmit` compiles successfully
    - requireEInvoiceTransmissionPermission middleware exported
    - requireMfaForTransmission middleware exported
    - checkSodConflictsMiddleware exported
    - Package validity check integrated
  </verify>
  <done>Transmission permission middleware created with MFA and SoD checks</done>
</task>

<task type="auto">
  <name>Task 3: Create transmission permissions seed</name>
  <files>web-erp-app/backend/prisma/seeds/einvoice-transmission-permissions.seed.ts</files>
  <action>
Create seed script for transmission permissions:

```typescript
/**
 * E-Invoice Transmission Permissions Seed
 * Phase: 07-e-invoicing-transmission
 *
 * Seeds 22 transmission permissions into the pack-role system.
 * Extends UAE_COMPLIANCE package with einvoice_transmission module.
 *
 * @module einvoice-transmission-permissions.seed
 */

import { PrismaClient } from '@prisma/client';
import { randomUUID } from 'crypto';
import {
  EINVOICE_TRANSMISSION_PERMISSIONS,
  TRANSMISSION_PERMISSION_INFO,
  EInvoiceTransmissionPermission,
} from '../../src/types/einvoice-transmission-permissions';

const prisma = new PrismaClient();

/**
 * Seed e-invoice transmission permissions
 *
 * Adds 22 transmission permissions to the permissions table
 * and links to UAE_COMPLIANCE package.
 */
export async function seedEInvoiceTransmissionPermissions(): Promise<{
  permissionCount: number;
  packageId: string;
}> {
  console.log('[E-Invoice Transmission Seed] Starting permissions seeding...');

  // Find or create UAE_COMPLIANCE package
  let uaeCompliancePack = await prisma.packages.findFirst({
    where: { code: 'UAE_COMPLIANCE' },
  });

  if (!uaeCompliancePack) {
    uaeCompliancePack = await prisma.packages.create({
      data: {
        id: randomUUID(),
        code: 'UAE_COMPLIANCE',
        name: 'UAE Compliance Suite',
        description: 'Complete UAE tax and regulatory compliance: VAT, CT, WPS, E-Invoicing',
        isActive: true,
        createdAt: new Date(),
        updatedAt: new Date(),
      },
    });
    console.log('[E-Invoice Transmission Seed] Created UAE_COMPLIANCE package');
  }

  let permissionCount = 0;

  // Create all 22 transmission permissions
  for (const [key, permissionCode] of Object.entries(EINVOICE_TRANSMISSION_PERMISSIONS)) {
    const info = TRANSMISSION_PERMISSION_INFO[permissionCode as EInvoiceTransmissionPermission];

    if (!info) {
      console.warn(`[E-Invoice Transmission Seed] Missing info for permission: ${permissionCode}`);
      continue;
    }

    // Upsert permission
    await prisma.permissions.upsert({
      where: { code: permissionCode },
      update: {
        name: info.name,
        description: info.description,
        category: info.category,
        updatedAt: new Date(),
      },
      create: {
        id: randomUUID(),
        code: permissionCode,
        name: info.name,
        description: info.description,
        category: info.category,
        packageId: uaeCompliancePack.id,
        isActive: true,
        createdAt: new Date(),
        updatedAt: new Date(),
      },
    });

    permissionCount++;
    console.log(`[E-Invoice Transmission Seed] Upserted permission: ${permissionCode}`);
  }

  console.log(`[E-Invoice Transmission Seed] Seeded ${permissionCount} transmission permissions`);

  return {
    permissionCount,
    packageId: uaeCompliancePack.id,
  };
}

/**
 * Seed transmission role bundles for a company
 *
 * Creates predefined roles with transmission permission bundles.
 */
export async function seedTransmissionRoles(companyId: string): Promise<{
  rolesCreated: number;
  roleNames: string[];
}> {
  console.log(`[E-Invoice Transmission Seed] Creating roles for company: ${companyId}`);

  // Get all transmission permissions
  const permissions = await prisma.permissions.findMany({
    where: {
      code: { in: Object.values(EINVOICE_TRANSMISSION_PERMISSIONS) },
      isActive: true,
    },
  });

  const permissionMap = new Map(permissions.map((p) => [p.code, p.id]));

  // Define roles with their permission bundles
  const roles = [
    {
      name: 'E-Invoice Clerk',
      description: 'Basic queue and status viewing for e-invoices',
      permissions: [
        EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_VIEW,
        EINVOICE_TRANSMISSION_PERMISSIONS.STATUS_VIEW,
        EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_XML,
        EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_JSON,
        EINVOICE_TRANSMISSION_PERMISSIONS.AUDIT_VIEW,
        EINVOICE_TRANSMISSION_PERMISSIONS.DASHBOARD_VIEW,
      ],
    },
    {
      name: 'E-Invoice Operator',
      description: 'Can submit to sandbox, retry failed transmissions',
      permissions: [
        EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_VIEW,
        EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_SUBMIT,
        EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_RETRY,
        EINVOICE_TRANSMISSION_PERMISSIONS.STATUS_VIEW,
        EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_SANDBOX,
        EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_XML,
        EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_JSON,
        EINVOICE_TRANSMISSION_PERMISSIONS.AUDIT_VIEW,
        EINVOICE_TRANSMISSION_PERMISSIONS.CONFIG_VIEW,
        EINVOICE_TRANSMISSION_PERMISSIONS.CONNECTION_TEST,
        EINVOICE_TRANSMISSION_PERMISSIONS.DASHBOARD_VIEW,
      ],
    },
    {
      name: 'E-Invoice Manager',
      description: 'Full transmission authority except credentials',
      permissions: [
        EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_VIEW,
        EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_SUBMIT,
        EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_RETRY,
        EINVOICE_TRANSMISSION_PERMISSIONS.QUEUE_CANCEL,
        EINVOICE_TRANSMISSION_PERMISSIONS.STATUS_VIEW,
        EINVOICE_TRANSMISSION_PERMISSIONS.STATUS_EXPORT,
        EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_SANDBOX,
        EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_PRODUCTION,
        EINVOICE_TRANSMISSION_PERMISSIONS.TRANSMIT_BULK,
        EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_XML,
        EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_JSON,
        EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_BULK,
        EINVOICE_TRANSMISSION_PERMISSIONS.CONFIG_VIEW,
        EINVOICE_TRANSMISSION_PERMISSIONS.AUDIT_VIEW,
        EINVOICE_TRANSMISSION_PERMISSIONS.AUDIT_EXPORT,
        EINVOICE_TRANSMISSION_PERMISSIONS.CONNECTION_TEST,
        EINVOICE_TRANSMISSION_PERMISSIONS.DASHBOARD_VIEW,
        EINVOICE_TRANSMISSION_PERMISSIONS.NOTIFICATIONS_MANAGE,
      ],
    },
  ];

  const createdRoleNames: string[] = [];

  for (const roleData of roles) {
    // Create or update role
    const role = await prisma.role_New.upsert({
      where: {
        companyId_name: { companyId, name: roleData.name },
      },
      update: {
        description: roleData.description,
        updatedAt: new Date(),
      },
      create: {
        id: randomUUID(),
        name: roleData.name,
        description: roleData.description,
        companyId,
        roleType: 'NON_DOCUMENT_ROLE',
        isSystemRole: true,
        isActive: true,
        createdAt: new Date(),
        updatedAt: new Date(),
      },
    });

    // Assign permissions to role
    for (const permCode of roleData.permissions) {
      const permId = permissionMap.get(permCode);
      if (permId) {
        await prisma.rolePermission.upsert({
          where: {
            roleId_permissionId: { roleId: role.id, permissionId: permId },
          },
          update: {},
          create: {
            id: randomUUID(),
            roleId: role.id,
            permissionId: permId,
          },
        });
      }
    }

    createdRoleNames.push(roleData.name);
    console.log(`[E-Invoice Transmission Seed] Created role: ${roleData.name}`);
  }

  return {
    rolesCreated: createdRoleNames.length,
    roleNames: createdRoleNames,
  };
}

/**
 * Main seed function
 */
async function main() {
  const { permissionCount, packageId } = await seedEInvoiceTransmissionPermissions();

  console.log('\n=== E-Invoice Transmission Permissions Seed Complete ===');
  console.log(`Permissions seeded: ${permissionCount}`);
  console.log(`Package ID: ${packageId}`);
  console.log('\nTo seed roles for a specific company, call:');
  console.log('  seedTransmissionRoles(companyId)');
}

// Direct execution for CLI
if (require.main === module) {
  main()
    .then(() => {
      console.log('\nSeed completed successfully');
      process.exit(0);
    })
    .catch((error) => {
      console.error('Seed failed:', error);
      process.exit(1);
    })
    .finally(() => prisma.$disconnect());
}

export default seedEInvoiceTransmissionPermissions;
```
  </action>
  <verify>
    - `npx ts-node prisma/seeds/einvoice-transmission-permissions.seed.ts` runs successfully
    - 22 permissions created in database
    - UAE_COMPLIANCE package linked
    - seedTransmissionRoles function creates 3 role bundles
  </verify>
  <done>Transmission permissions seed created with 22 permissions and role bundles</done>
</task>

</tasks>

<verification>
1. Types compile: `npx tsc --noEmit` passes
2. Permission count: 22 permissions in EINVOICE_TRANSMISSION_PERMISSIONS
3. Role bundles: 6 roles (Clerk, Operator, Manager, Finance Admin, CFO, Auditor)
4. SoD conflicts: 4 conflict rules defined
5. MFA requirements: 4 operations require MFA
6. Middleware: Permission, MFA, SoD middleware exported
7. Seed runs: `npx ts-node prisma/seeds/einvoice-transmission-permissions.seed.ts`
8. Package integration: UAE_COMPLIANCE package extended
</verification>

<success_criteria>
1. 22 granular permissions defined across 7 categories (including Status & Monitoring)
2. 6 role bundles map permissions to organizational roles per FTA requirements
3. SoD conflicts prevent dangerous permission combinations (4 rules)
4. MFA required for: credentials:manage, mode:switch, transmit:production, transmit:bulk
5. Permission middleware integrates with existing pack-role system
6. Package validity check ensures UAE_COMPLIANCE is active
7. Seed script is idempotent (safe to run multiple times)
8. All permissions have metadata (name, description, category, MFA flag)
</success_criteria>

<output>
After completion, create `.planning/phases/07-e-invoicing-transmission/07-02-SUMMARY.md`
</output>
