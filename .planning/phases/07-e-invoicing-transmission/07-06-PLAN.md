---
phase: 07-e-invoicing-transmission
plan: 06
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - web-erp-app/backend/src/services/einvoice/mls/mls.types.ts
  - web-erp-app/backend/src/services/einvoice/mls/mls-handler.service.ts
  - web-erp-app/backend/src/services/einvoice/mls/error-mapper.service.ts
  - web-erp-app/backend/src/services/einvoice/mls/__tests__/mls-handler.service.test.ts
autonomous: true

must_haves:
  truths:
    - "MLS codes (AB, AP, RE) mapped to internal transmission status"
    - "DCTCE/PEPPOL error codes mapped to invoice field names"
    - "Rejection notifications sent to configured recipients"
    - "Full status history logged for FTA compliance"
  artifacts:
    - path: "web-erp-app/backend/src/services/einvoice/mls/mls-handler.service.ts"
      provides: "MLS response handler"
      exports: ["MlsHandlerService"]
      min_lines: 200
    - path: "web-erp-app/backend/src/services/einvoice/mls/error-mapper.service.ts"
      provides: "Error to field mapping"
      exports: ["ErrorMapperService"]
    - path: "web-erp-app/backend/src/services/einvoice/mls/mls.types.ts"
      provides: "MLS type definitions"
      exports: ["MlsStatusCode", "MlsResponse", "MlsValidationError"]
  key_links:
    - from: "mls-handler.service.ts"
      to: "einvoice_transmissions"
      via: "status updates"
      pattern: "prisma\\.einvoice_transmissions"
    - from: "error-mapper.service.ts"
      to: "mls.types.ts"
      via: "error code mappings"
      pattern: "ERROR_FIELD_MAP|PINT_AE_ERROR_CODES"
---

<objective>
Create the MLS (Message Level Status) Handler Service for processing DCTCE responses, mapping error codes to invoice fields, and sending rejection notifications.

Purpose: EINV-08 requires proper handling of MLS responses - the standard DCTCE status codes (AB, AP, RE) that indicate invoice acceptance or rejection, with user-friendly error mapping for corrections.

Output:
- MLS type definitions and status mappings
- MlsHandlerService for processing responses and updating transmission status
- ErrorMapperService for field-level error mapping
- Unit tests covering status handling and notifications
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-e-invoicing-transmission/07-CONTEXT.md
@.planning/phases/07-e-invoicing-transmission/07-RESEARCH.md
@web-erp-app/backend/src/types/einvoice-transmission.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MLS Type Definitions</name>
  <files>web-erp-app/backend/src/services/einvoice/mls/mls.types.ts</files>
  <action>
Create directory and MLS types:

```bash
mkdir -p web-erp-app/backend/src/services/einvoice/mls
```

Define types based on 07-RESEARCH.md MLS section:

1. **MlsStatusCode enum** (core DCTCE codes + internal):
   - AB: Accepted, not forwarded
   - AP: Accepted and forwarded (cleared)
   - RE: Rejected
   - PENDING: Awaiting response
   - PROCESSING: Being processed
   - ERROR: System error (not validation)
   - TIMEOUT: Response timeout

2. **MLS_TO_STATUS_MAP constant**: Maps MlsStatusCode to EInvoiceTransmissionStatus
   - AB -> PENDING_CLEARANCE
   - AP -> CLEARED
   - RE -> REJECTED
   - PENDING -> TRANSMITTING
   - PROCESSING -> PENDING_CLEARANCE
   - ERROR -> FAILED
   - TIMEOUT -> FAILED

3. **MlsResponse interface**:
   - submissionId: string
   - documentReference: string (invoice number)
   - statusCode: MlsStatusCode
   - statusMessage: string
   - receivedAt: Date
   - processedAt: Date
   - tddReference?: string (if accepted)
   - clearanceNumber?: string (if cleared)
   - errors?: MlsValidationError[]
   - rawResponse?: unknown

4. **MlsValidationError interface**:
   - errorCode: string (e.g., 'PINT-AE-001')
   - errorMessage: string
   - errorLocation?: string (XPath)
   - severity: 'fatal' | 'error' | 'warning'
   - suggestedFix?: string
   - fieldMapping?: string (mapped invoice field)

5. **MlsNotificationConfig interface**:
   - notifyOnRejection: boolean
   - notifyOnFailure: boolean
   - notifyOnClearance: boolean
   - emailRecipients: string[]
   - inAppNotify: boolean

6. **STATUS_DESCRIPTIONS constant**: Human-readable status descriptions
   - AB: "Invoice accepted by FTA, awaiting clearance"
   - AP: "Invoice cleared and forwarded to recipient"
   - RE: "Invoice rejected - correction required"

Also create index.ts for exports.
  </action>
  <verify>
    - `npx tsc --noEmit` compiles successfully
    - All MLS types exported
    - Status mapping covers all scenarios
  </verify>
  <done>MLS types created with status codes, mappings, and notification config</done>
</task>

<task type="auto">
  <name>Task 2: Create Error Mapper Service</name>
  <files>web-erp-app/backend/src/services/einvoice/mls/error-mapper.service.ts</files>
  <action>
Create error mapping service:

1. **PINT_AE_ERROR_CODES constant**: Map error codes to descriptions
   - PINT-AE-001: "CustomizationID must contain PINT AE identifier"
   - PINT-AE-002: "DocumentCurrencyCode must be AED"
   - PINT-AE-003: "Seller TRN is mandatory and must be 15 digits"
   - PEPPOL-EN16931-R001: "Business process MUST be provided"
   - PEPPOL-EN16931-R010: "Buyer electronic address MUST be provided"
   - PEPPOL-EN16931-R020: "Seller electronic address MUST be provided"
   - XSD-001: "XML schema validation failure"
   - TRN-001: "Invalid TRN format"

2. **ERROR_FIELD_MAP constant**: Map error codes to invoice fields
   - PINT-AE-001: 'customizationId'
   - PINT-AE-002: 'documentCurrencyCode'
   - PINT-AE-003: 'supplierTrn'
   - PEPPOL-EN16931-R010: 'buyerEndpoint'
   - PEPPOL-EN16931-R020: 'supplierEndpoint'
   - TRN-001: 'supplierTrn'

3. **SUGGESTED_FIXES constant**: Map error codes to fix instructions
   - PINT-AE-002: "Document currency must be AED for UAE invoices"
   - PINT-AE-003: "Supplier TRN must be exactly 15 digits starting with 100"
   - TRN-001: "Check that the TRN format is valid (15 digits starting with 100)"

4. **ErrorMapperService class** (@injectable):
   - mapError(error: MlsValidationError): MappedError
   - mapErrors(errors: MlsValidationError[]): MappedError[]
   - getFieldForError(errorCode: string): string | null
   - getSuggestedFix(errorCode: string): string
   - extractXPathField(xpath: string): string | null (parse XPath to field name)
   - categorizeErrors(errors: MappedError[]): CategorizedErrors (group by severity)

5. **MappedError interface**:
   - originalCode: string
   - originalMessage: string
   - field: string | null
   - suggestedFix: string
   - severity: 'fatal' | 'error' | 'warning'
   - userFriendlyMessage: string

Make sure to handle unknown error codes gracefully with default messages.
  </action>
  <verify>
    - `npx tsc --noEmit` compiles successfully
    - Error codes from RESEARCH.md are mapped
    - Suggested fixes are user-friendly
    - Unknown codes handled gracefully
  </verify>
  <done>ErrorMapperService created with PINT-AE/PEPPOL error mappings and field identification</done>
</task>

<task type="auto">
  <name>Task 3: Create MLS Handler Service</name>
  <files>web-erp-app/backend/src/services/einvoice/mls/mls-handler.service.ts</files>
  <action>
Create the MLS Handler Service:

1. **MlsHandlerService class** (@injectable):
   - Inject: PrismaClient, ErrorMapperService, NotificationService, ComplianceAuditService

2. **handleMlsResponse(transmissionId, response)**: Main handler
   - Map MLS status code to internal status
   - Call errorMapper.mapErrors() for any validation errors
   - Update einvoice_transmissions record with:
     - status (mapped)
     - mlsStatusCode
     - tddReference (if accepted)
     - clearanceNumber (if cleared)
     - aspResponseCode
     - aspResponseMessage
     - lastStatusCheckAt
   - Store mapped errors in einvoice_transmission_history
   - Send notifications based on config
   - Log to compliance audit
   - Return updated transmission record

3. **checkAndUpdateStatus(transmissionId, provider)**: Status polling
   - Get transmission record
   - Call provider.checkStatus()
   - Parse response as MlsResponse
   - Call handleMlsResponse()
   - Return updated status

4. **storeValidationErrors(transmissionId, errors)**:
   - Store in einvoice_transmission_errors table
   - Include field mapping for UI highlighting

5. **sendNotification(transmission, response)**: Notify on status change
   - Check notification config from tenant settings
   - Email for rejections/failures (critical)
   - In-app for clearances (routine)
   - Include error details and suggested fixes

6. **logStatusTransition(transmissionId, oldStatus, newStatus, response)**:
   - Create einvoice_transmission_history record
   - Include: userId (system), action, timestamp, response data
   - This is FTA audit trail

7. **Private helper methods**:
   - mapMlsToInternalStatus(mlsCode): EInvoiceTransmissionStatus
   - canTransition(from, to): boolean (state machine validation)
   - formatNotificationMessage(transmission, errors): string
   - shouldNotify(config, status): boolean

Ensure all status transitions are logged for FTA compliance.
  </action>
  <verify>
    - `npx tsc --noEmit` compiles successfully
    - MLS codes correctly mapped to internal status
    - Status history logged for audit
    - Notifications sent on rejection/failure
    - Error mapping includes field identification
  </verify>
  <done>MlsHandlerService created with status handling, notifications, and audit logging</done>
</task>

<task type="auto">
  <name>Task 4: Create MLS Handler Unit Tests</name>
  <files>web-erp-app/backend/src/services/einvoice/mls/__tests__/mls-handler.service.test.ts</files>
  <action>
Create unit tests:

**Test suites**:

1. **MLS Status Mapping**:
   - Should map AB to PENDING_CLEARANCE
   - Should map AP to CLEARED
   - Should map RE to REJECTED
   - Should map TIMEOUT to FAILED
   - Should handle unknown codes gracefully

2. **Error Mapping**:
   - Should map PINT-AE-003 to supplierTrn field
   - Should provide suggested fix for known errors
   - Should handle unknown error codes
   - Should extract field from XPath if provided

3. **handleMlsResponse - Happy Path**:
   - Should update transmission status to CLEARED on AP
   - Should store tddReference when provided
   - Should store clearanceNumber when provided
   - Should log status transition to history

4. **handleMlsResponse - Rejection**:
   - Should update status to REJECTED on RE
   - Should store validation errors
   - Should map errors to fields
   - Should trigger rejection notification

5. **Notification Logic**:
   - Should send email on rejection
   - Should send email on failure
   - Should send in-app on clearance
   - Should respect notification config (disabled)

6. **State Transitions**:
   - Should allow PENDING_CLEARANCE -> CLEARED
   - Should allow PENDING_CLEARANCE -> REJECTED
   - Should prevent CLEARED -> REJECTED (invalid)
   - Should prevent double clearance

Use mocks for:
- PrismaClient (mock update/create/findUnique)
- NotificationService (mock sendEmail, sendInApp)
- ComplianceAuditService (mock logWithHashChain)
  </action>
  <verify>
    - Run `npm test -- --testPathPattern=mls-handler.service.test.ts`
    - All tests pass
    - Coverage includes status mapping, error mapping, notifications
  </verify>
  <done>Unit tests created covering MLS status handling, error mapping, and notification logic</done>
</task>

</tasks>

<verification>
1. MLS types: All status codes and mappings defined
2. Error mapper: PINT-AE and PEPPOL error codes mapped
3. Field mapping: Error codes map to invoice fields
4. MLS handler: Status updates with audit logging
5. Notifications: Rejection/failure emails sent
6. State machine: Invalid transitions prevented
7. Audit trail: All status changes logged
8. Tests: All unit tests pass
</verification>

<success_criteria>
1. MlsStatusCode enum includes AB, AP, RE, and internal codes
2. MLS_TO_STATUS_MAP correctly maps to EInvoiceTransmissionStatus
3. ErrorMapperService maps error codes to invoice fields
4. Suggested fixes are user-friendly for common errors
5. MlsHandlerService updates transmission status on response
6. Validation errors stored with field mapping for UI
7. Email notification sent on rejection/failure
8. Status transitions logged to einvoice_transmission_history
9. Unit tests cover status mapping, notifications, and error scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/07-e-invoicing-transmission/07-06-SUMMARY.md`
</output>
