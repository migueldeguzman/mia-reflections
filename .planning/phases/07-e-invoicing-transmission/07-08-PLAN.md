---
phase: 07-e-invoicing-transmission
plan: 08
type: execute
wave: 3
depends_on: ["07-01", "07-04"]
files_modified:
  - web-erp-app/backend/src/services/einvoice/export/export.service.ts
  - web-erp-app/backend/src/services/einvoice/export/export.types.ts
  - web-erp-app/backend/src/controllers/einvoice-export.controller.ts
  - web-erp-app/backend/src/routes/einvoice-export.routes.ts
autonomous: true

must_haves:
  truths:
    - "PINT-AE XML export from archive"
    - "JSON export with UBL-mapped structure"
    - "Bulk export with date range and status filters creates ZIP"
    - "Download endpoint and API endpoint available"
  artifacts:
    - path: "web-erp-app/backend/src/services/einvoice/export/export.service.ts"
      provides: "Export service"
      exports: ["EInvoiceExportService"]
      min_lines: 200
    - path: "web-erp-app/backend/src/controllers/einvoice-export.controller.ts"
      provides: "Export controller"
      exports: ["EInvoiceExportController"]
    - path: "web-erp-app/backend/src/routes/einvoice-export.routes.ts"
      provides: "Export routes"
      exports: ["einvoiceExportRoutes"]
  key_links:
    - from: "export.service.ts"
      to: "einvoice-archive.service.ts"
      via: "XML retrieval"
      pattern: "archiveService|getArchive"
    - from: "export.controller.ts"
      to: "export.service.ts"
      via: "service call"
      pattern: "exportService\\.export"
---

<objective>
Create the e-invoice export service for XML and JSON formats with bulk export capability and ZIP packaging.

Purpose: EINV-10 requires export functionality - users need to download e-invoices in PINT-AE XML format for FTA compliance records and JSON format for external system integration.

Output:
- EInvoiceExportService for single and bulk exports
- Export controller with download and API endpoints
- ZIP packaging for bulk exports
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-e-invoicing-transmission/07-CONTEXT.md
@.planning/phases/07-e-invoicing-transmission/07-RESEARCH.md
@web-erp-app/backend/src/services/einvoice/einvoice-archive.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Export Type Definitions</name>
  <files>web-erp-app/backend/src/services/einvoice/export/export.types.ts</files>
  <action>
Create directory and export types:

```bash
mkdir -p web-erp-app/backend/src/services/einvoice/export
```

Define types:

1. **ExportFormat enum**:
   - XML: 'xml' (PINT-AE format)
   - JSON: 'json' (UBL-mapped)

2. **ExportOptions interface**:
   - format: ExportFormat
   - includeMetadata: boolean (default true)
   - prettyPrint: boolean (default false for XML, true for JSON)
   - includeTdd: boolean (include TDD summary)
   - includeTransmissionStatus: boolean

3. **BulkExportRequest interface**:
   - companyId: string
   - format: ExportFormat
   - filters: ExportFilters
   - options?: ExportOptions

4. **ExportFilters interface**:
   - dateFrom?: Date
   - dateTo?: Date
   - status?: EInvoiceTransmissionStatus[]
   - invoiceType?: ('INVOICE' | 'CREDIT_NOTE')[]
   - einvoiceNumbers?: string[]
   - transmissionIds?: string[]
   - supplierTrn?: string
   - buyerTrn?: string

5. **ExportResult interface**:
   - archiveId: string
   - einvoiceNumber: string
   - format: ExportFormat
   - content: string | Buffer
   - filename: string
   - mimeType: string
   - size: number

6. **BulkExportResult interface**:
   - zipFilename: string
   - zipContent: Buffer
   - mimeType: 'application/zip'
   - size: number
   - filesIncluded: number
   - manifest: ExportManifest

7. **ExportManifest interface**:
   - exportedAt: Date
   - exportedBy: string
   - companyId: string
   - filters: ExportFilters
   - files: Array<{ filename, archiveId, einvoiceNumber, format }>
   - totalCount: number

8. **MIME_TYPES constant**:
   - xml: 'application/xml'
   - json: 'application/json'
   - zip: 'application/zip'

Also create index.ts for exports.
  </action>
  <verify>
    - `npx tsc --noEmit` compiles successfully
    - Export types exported
    - Filters cover date range and status
  </verify>
  <done>Export types created with formats, filters, and result interfaces</done>
</task>

<task type="auto">
  <name>Task 2: Create Export Service</name>
  <files>web-erp-app/backend/src/services/einvoice/export/export.service.ts</files>
  <action>
Create the export service:

1. **EInvoiceExportService class** (@injectable):
   - Inject: PrismaClient, EInvoiceArchiveService, TddBuilderService

2. **exportSingle(archiveId, options)**: Single invoice export
   - Get archive from archiveService
   - If format is XML:
     - Return archive.xmlContent directly (already PINT-AE)
     - Add XML declaration if not present
   - If format is JSON:
     - Parse XML to JSON using fast-xml-parser
     - Map to UBL JSON structure
     - Include metadata if requested
     - Include TDD summary if requested
     - Include transmission status if requested
   - Return ExportResult

3. **exportBulk(request: BulkExportRequest, userId)**: Bulk export with ZIP
   - Query archives matching filters
   - Validate company access (user.companyId === request.companyId)
   - Create Archiver ZIP stream
   - For each archive:
     - Export in requested format
     - Add to ZIP with filename: {einvoiceNumber}.{format}
   - Generate manifest.json
   - Add manifest to ZIP
   - Return BulkExportResult with ZIP buffer

4. **getExportFilename(archive, format)**: Generate filename
   - Format: {einvoiceNumber}_{YYYY-MM-DD}.{ext}
   - Sanitize for filesystem (remove special chars)

5. **queryArchivesForExport(companyId, filters)**: Query with filters
   - Build Prisma where clause from filters
   - Join with einvoice_transmissions for status filter
   - Return archives with transmission data

6. **Private xmlToJson(xml, options)**: XML to JSON conversion
   - Use fast-xml-parser with attributeNamePrefix
   - Map UBL namespace prefixes
   - Structure as UBL JSON (cac/cbc namespaces)

7. **Private addMetadata(json, archive, transmission)**: Add export metadata
   - exportedAt, archiveId, transmissionStatus
   - hash, archivedAt, transmittedAt

8. **Private addTddSummary(json, archive)**: Add TDD data
   - Call tddBuilder.buildFromArchive()
   - Include supplier TRN, amounts, tax breakdown

9. **createExportManifest(companyId, filters, files, userId)**: Create manifest
   - Include all export details for audit
   - Include filter parameters used
   - List all files with metadata
  </action>
  <verify>
    - `npx tsc --noEmit` compiles successfully
    - XML export returns valid PINT-AE
    - JSON export maps UBL structure
    - Bulk export creates ZIP with manifest
    - Filenames are filesystem-safe
  </verify>
  <done>EInvoiceExportService created with single and bulk export, XML/JSON formats</done>
</task>

<task type="auto">
  <name>Task 3: Create Export Controller and Routes</name>
  <files>
    web-erp-app/backend/src/controllers/einvoice-export.controller.ts
    web-erp-app/backend/src/routes/einvoice-export.routes.ts
  </files>
  <action>
Create the export controller:

**einvoice-export.controller.ts**:

1. **EInvoiceExportController class**:
   - Inject: EInvoiceExportService

2. **GET /api/einvoice/export/:archiveId**: Single export download
   - Query params: format (xml|json), includeTdd, includeStatus
   - Validate archiveId UUID
   - Check company access
   - Call exportService.exportSingle()
   - Set Content-Type header (application/xml or application/json)
   - Set Content-Disposition: attachment; filename="..."
   - Stream response

3. **POST /api/einvoice/export/bulk**: Bulk export download
   - Body: BulkExportRequest
   - Validate filters
   - Check company access
   - Call exportService.exportBulk()
   - Set Content-Type: application/zip
   - Set Content-Disposition: attachment; filename="einvoices_export_{date}.zip"
   - Stream ZIP response

4. **GET /api/einvoice/export/:archiveId/json**: JSON API endpoint
   - Same as single export but for API consumption
   - Returns JSON body directly (not as file download)
   - Useful for integrations

5. **POST /api/einvoice/export/preview**: Preview bulk export
   - Same as bulk but returns manifest only (no actual export)
   - Shows count, file list, estimated size
   - Useful for UI confirmation

**einvoice-export.routes.ts**:

```typescript
import { Router } from 'express';
import { authenticateJWT } from '../../middleware/auth.middleware';
import {
  requireEInvoiceTransmissionPermission,
} from '../../middleware/einvoice-transmission.middleware';
import { EINVOICE_TRANSMISSION_PERMISSIONS } from '../../types/einvoice-transmission-permissions';
import { EInvoiceExportController } from '../controllers/einvoice-export.controller';
import { container } from '../../di/container';
import { TYPES } from '../../di/types';

const router = Router();
const controller = container.get<EInvoiceExportController>(TYPES.EInvoiceExportController);

// Single export (download)
router.get(
  '/export/:archiveId',
  authenticateJWT,
  requireEInvoiceTransmissionPermission(EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_XML),
  controller.exportSingle.bind(controller)
);

// Bulk export (ZIP download)
router.post(
  '/export/bulk',
  authenticateJWT,
  requireEInvoiceTransmissionPermission(EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_BULK),
  controller.exportBulk.bind(controller)
);

// JSON API endpoint
router.get(
  '/export/:archiveId/json',
  authenticateJWT,
  requireEInvoiceTransmissionPermission(EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_JSON),
  controller.exportJson.bind(controller)
);

// Preview bulk export
router.post(
  '/export/preview',
  authenticateJWT,
  requireEInvoiceTransmissionPermission(EINVOICE_TRANSMISSION_PERMISSIONS.EXPORT_BULK),
  controller.previewBulk.bind(controller)
);

export { router as einvoiceExportRoutes };
```

Register routes in main app (add to existing e-invoice routes).
  </action>
  <verify>
    - `npx tsc --noEmit` compiles successfully
    - Routes use correct permission middleware
    - Single export sets Content-Disposition header
    - Bulk export returns ZIP file
    - JSON endpoint returns parsed JSON
  </verify>
  <done>Export controller and routes created with download and API endpoints</done>
</task>

</tasks>

<verification>
1. Export types: XML and JSON formats defined
2. Single export: Returns PINT-AE XML or UBL JSON
3. Bulk export: Creates ZIP with manifest
4. Filters: Date range, status, invoice type supported
5. Filenames: Sanitized for filesystem
6. Permissions: EXPORT_XML, EXPORT_JSON, EXPORT_BULK used
7. Headers: Content-Type and Content-Disposition set correctly
8. Preview: Returns manifest without actual export
</verification>

<success_criteria>
1. GET /export/:archiveId downloads PINT-AE XML or JSON
2. POST /export/bulk creates ZIP with multiple invoices
3. Bulk export includes manifest.json with file list
4. Date range filter works (dateFrom, dateTo)
5. Status filter works (CLEARED, REJECTED, etc.)
6. JSON export maps UBL structure correctly
7. JSON export includes optional TDD summary
8. Filenames are safe (no special characters)
9. All endpoints require proper permissions
</success_criteria>

<output>
After completion, create `.planning/phases/07-e-invoicing-transmission/07-08-SUMMARY.md`
</output>
