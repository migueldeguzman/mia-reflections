---
phase: 07-e-invoicing-transmission
plan: 10
type: execute
wave: 4
depends_on: ["07-01", "07-02", "07-03", "07-04", "07-05", "07-06", "07-07", "07-08", "07-09"]
files_modified:
  - web-erp-app/backend/src/di/transmission.module.ts
  - web-erp-app/backend/src/di/types.ts
  - web-erp-app/backend/src/di/container.ts
  - web-erp-app/backend/src/services/einvoice/index.ts
autonomous: true

must_haves:
  truths:
    - "All Phase 7 services registered in DI container"
    - "Provider factory resolves correct provider based on mode"
    - "Services are injectable with correct dependencies"
    - "Module loads without errors at startup"
  artifacts:
    - path: "web-erp-app/backend/src/di/transmission.module.ts"
      provides: "DI module for transmission services"
      exports: ["transmissionModule", "TRANSMISSION_TYPES"]
      min_lines: 120
    - path: "web-erp-app/backend/src/di/types.ts"
      provides: "DI type symbols for transmission"
      exports: ["TRANSMISSION_TYPES"]
    - path: "web-erp-app/backend/src/services/einvoice/index.ts"
      provides: "Barrel export for all e-invoice services"
  key_links:
    - from: "transmission.module.ts"
      to: "container.ts"
      via: "module loading"
      pattern: "container\\.load\\(transmissionModule\\)"
    - from: "transmission.module.ts"
      to: "credential-store.service.ts"
      via: "service binding"
      pattern: "bind.*CredentialStoreService"
---

<objective>
Create the DI configuration module that wires all Phase 7 services together and ensures proper dependency injection.

Purpose: All services need to be registered in the IoC container with correct scoping (singleton vs transient) and the provider factory needs to resolve the correct provider based on transmission mode.

Output:
- transmission.module.ts with all service registrations
- Updated types.ts with TRANSMISSION_TYPES symbols
- Updated container.ts to load transmission module
- Barrel exports for all e-invoice services
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-e-invoicing-transmission/07-CONTEXT.md
@web-erp-app/backend/src/di/container.ts
@web-erp-app/backend/src/di/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update DI Types</name>
  <files>web-erp-app/backend/src/di/types.ts</files>
  <action>
Add TRANSMISSION_TYPES symbols for all Phase 7 services:

```typescript
// ==================== E-Invoice Transmission (Phase 7) ====================

export const TRANSMISSION_TYPES = {
  // Schema Services
  TransmissionSettingsService: Symbol.for('TransmissionSettingsService'),

  // Credential Services (07-03)
  CredentialStoreService: Symbol.for('CredentialStoreService'),
  OAuthTokenService: Symbol.for('OAuthTokenService'),

  // Provider Services (07-05)
  TransmissionProviderFactory: Symbol.for('TransmissionProviderFactory'),
  DctceDirectProvider: Symbol.for('DctceDirectProvider'),
  AspProvider: Symbol.for('AspProvider'),
  SandboxProvider: Symbol.for('SandboxProvider'),

  // TDD Services (07-04)
  TddBuilderService: Symbol.for('TddBuilderService'),

  // MLS Services (07-06)
  MlsHandlerService: Symbol.for('MlsHandlerService'),
  ErrorMapperService: Symbol.for('ErrorMapperService'),

  // Queue Services (07-07)
  TransmissionQueueService: Symbol.for('TransmissionQueueService'),
  TransmissionWorkerService: Symbol.for('TransmissionWorkerService'),

  // Export Services (07-08)
  EInvoiceExportService: Symbol.for('EInvoiceExportService'),

  // Controllers (07-09)
  EInvoiceTransmissionController: Symbol.for('EInvoiceTransmissionController'),
  EInvoiceExportController: Symbol.for('EInvoiceExportController'),
} as const;

// Type for the provider factory function
export type TransmissionProviderFactory = (
  companyId: string,
  mode: string
) => Promise<ITransmissionProvider>;
```

Also export TRANSMISSION_TYPES from the main types export.
  </action>
  <verify>
    - `npx tsc --noEmit` compiles successfully
    - All symbols are unique
    - TransmissionProviderFactory type exported
  </verify>
  <done>DI types updated with all TRANSMISSION_TYPES symbols</done>
</task>

<task type="auto">
  <name>Task 2: Create Transmission Module</name>
  <files>web-erp-app/backend/src/di/transmission.module.ts</files>
  <action>
Create the DI module that registers all Phase 7 services:

```typescript
/**
 * E-Invoice Transmission DI Module
 * Phase: 07-e-invoicing-transmission
 *
 * Registers all transmission services with appropriate scoping:
 * - Singleton: Stateless services, caches, queues
 * - Transient: Providers (new instance per request)
 */

import { ContainerModule, interfaces } from 'inversify';
import { TRANSMISSION_TYPES, TransmissionProviderFactory } from './types';
import { TYPES } from './types';

// Credential Services
import { CredentialStoreService } from '../services/einvoice/credentials/credential-store.service';
import { OAuthTokenService } from '../services/einvoice/credentials/oauth-token.service';

// Provider Services
import { ITransmissionProvider } from '../services/einvoice/providers/transmission-provider.interface';
import { DctceDirectProvider } from '../services/einvoice/providers/dctce-direct.provider';
import { AspProvider } from '../services/einvoice/providers/asp.provider';
import { SandboxProvider } from '../services/einvoice/providers/sandbox.provider';

// TDD/MLS Services
import { TddBuilderService } from '../services/einvoice/tdd/tdd-builder.service';
import { MlsHandlerService } from '../services/einvoice/mls/mls-handler.service';
import { ErrorMapperService } from '../services/einvoice/mls/error-mapper.service';

// Queue Services
import { TransmissionQueueService } from '../services/einvoice/queue/transmission-queue.service';
import { TransmissionWorkerService } from '../services/einvoice/queue/transmission-worker.service';

// Export Services
import { EInvoiceExportService } from '../services/einvoice/export/export.service';

// Controllers
import { EInvoiceTransmissionController } from '../controllers/einvoice-transmission.controller';
import { EInvoiceExportController } from '../controllers/einvoice-export.controller';

export const transmissionModule = new ContainerModule((bind: interfaces.Bind) => {
  // ==================== Credential Services ====================
  // Singleton: Shares encryption key and token cache
  bind(TRANSMISSION_TYPES.CredentialStoreService)
    .to(CredentialStoreService)
    .inSingletonScope();

  bind(TRANSMISSION_TYPES.OAuthTokenService)
    .to(OAuthTokenService)
    .inSingletonScope();

  // ==================== Provider Services ====================
  // Transient: Fresh instance per request (stateful with credentials)
  bind(TRANSMISSION_TYPES.DctceDirectProvider)
    .to(DctceDirectProvider)
    .inTransientScope();

  bind(TRANSMISSION_TYPES.AspProvider)
    .to(AspProvider)
    .inTransientScope();

  bind(TRANSMISSION_TYPES.SandboxProvider)
    .to(SandboxProvider)
    .inTransientScope();

  // Provider Factory: Resolves correct provider based on mode
  bind<TransmissionProviderFactory>(TRANSMISSION_TYPES.TransmissionProviderFactory)
    .toFactory<Promise<ITransmissionProvider>>((context: interfaces.Context) => {
      return async (companyId: string, mode: string): Promise<ITransmissionProvider> => {
        const prisma = context.container.get(TYPES.PrismaClient);

        // Get company transmission settings
        const settings = await prisma.einvoice_transmission_settings.findUnique({
          where: { companyId },
        });

        if (!settings) {
          throw new Error(`No transmission settings configured for company: ${companyId}`);
        }

        // Resolve provider based on mode
        switch (mode) {
          case 'DCTCE_DIRECT':
            const dctceProvider = context.container.get<DctceDirectProvider>(
              TRANSMISSION_TYPES.DctceDirectProvider
            );
            await dctceProvider.initialize(companyId);
            return dctceProvider;

          case 'ASP':
            const aspProvider = context.container.get<AspProvider>(
              TRANSMISSION_TYPES.AspProvider
            );
            await aspProvider.initialize(companyId);
            return aspProvider;

          case 'SANDBOX':
          default:
            const sandboxProvider = context.container.get<SandboxProvider>(
              TRANSMISSION_TYPES.SandboxProvider
            );
            return sandboxProvider;
        }
      };
    });

  // ==================== TDD/MLS Services ====================
  // Singleton: Stateless transformation services
  bind(TRANSMISSION_TYPES.TddBuilderService)
    .to(TddBuilderService)
    .inSingletonScope();

  bind(TRANSMISSION_TYPES.ErrorMapperService)
    .to(ErrorMapperService)
    .inSingletonScope();

  bind(TRANSMISSION_TYPES.MlsHandlerService)
    .to(MlsHandlerService)
    .inSingletonScope();

  // ==================== Queue Services ====================
  // Singleton: Single queue instance shared across requests
  bind(TRANSMISSION_TYPES.TransmissionQueueService)
    .to(TransmissionQueueService)
    .inSingletonScope();

  bind(TRANSMISSION_TYPES.TransmissionWorkerService)
    .to(TransmissionWorkerService)
    .inSingletonScope();

  // ==================== Export Services ====================
  // Singleton: Stateless export service
  bind(TRANSMISSION_TYPES.EInvoiceExportService)
    .to(EInvoiceExportService)
    .inSingletonScope();

  // ==================== Controllers ====================
  // Singleton: Controllers are stateless
  bind(TRANSMISSION_TYPES.EInvoiceTransmissionController)
    .to(EInvoiceTransmissionController)
    .inSingletonScope();

  bind(TRANSMISSION_TYPES.EInvoiceExportController)
    .to(EInvoiceExportController)
    .inSingletonScope();
});

export { TRANSMISSION_TYPES };
```
  </action>
  <verify>
    - `npx tsc --noEmit` compiles successfully
    - All services bound with correct scope
    - Provider factory returns Promise<ITransmissionProvider>
    - Module exports transmissionModule and TRANSMISSION_TYPES
  </verify>
  <done>Transmission module created with all service bindings and provider factory</done>
</task>

<task type="auto">
  <name>Task 3: Update Container to Load Module</name>
  <files>web-erp-app/backend/src/di/container.ts</files>
  <action>
Update the main container to load the transmission module:

1. Import the transmission module:
```typescript
import { transmissionModule } from './transmission.module';
```

2. Load the module after other modules:
```typescript
// Load Phase 7 transmission module
container.load(transmissionModule);
```

3. Add startup verification (optional but recommended):
```typescript
// Verify critical services are available
const verifyTransmissionServices = () => {
  try {
    container.get(TRANSMISSION_TYPES.TransmissionQueueService);
    container.get(TRANSMISSION_TYPES.TddBuilderService);
    container.get(TRANSMISSION_TYPES.MlsHandlerService);
    console.log('[DI] Transmission services verified');
  } catch (error) {
    console.error('[DI] Transmission service verification failed:', error);
    throw error;
  }
};

// Call during app startup (not at import time)
export { verifyTransmissionServices };
```

4. Export TRANSMISSION_TYPES from container for convenience:
```typescript
export { TRANSMISSION_TYPES } from './types';
```
  </action>
  <verify>
    - `npx tsc --noEmit` compiles successfully
    - Container loads without errors
    - verifyTransmissionServices() passes
    - TRANSMISSION_TYPES exported from container
  </verify>
  <done>Container updated to load transmission module with startup verification</done>
</task>

<task type="auto">
  <name>Task 4: Create Barrel Exports</name>
  <files>web-erp-app/backend/src/services/einvoice/index.ts</files>
  <action>
Create barrel export for all e-invoice services (Phase 6 + Phase 7):

```typescript
/**
 * E-Invoice Services Barrel Export
 * Phases: 06 (Core), 07 (Transmission)
 */

// ==================== Phase 6: Core E-Invoice ====================

// Archive
export { EInvoiceArchiveService } from './einvoice-archive.service';
export type { ArchiveResult, ArchiveOptions } from './einvoice-archive.service';

// Builder
export { PintAeBuilderService } from './pint-ae-builder.service';
export type { BuildResult, BuildOptions } from './pint-ae-builder.service';

// Validator
export { UblValidatorService } from './ubl-validator.service';
export type { ValidationResult, ValidationError } from './ubl-validator.service';

// QR Code
export { QrCodeService } from './qr-code.service';
export { TlvEncoder } from './tlv-encoder.util';

// Types
export * from './einvoice.types';

// ==================== Phase 7: Transmission ====================

// Credentials (07-03)
export { CredentialStoreService } from './credentials/credential-store.service';
export { OAuthTokenService } from './credentials/oauth-token.service';
export * from './credentials/credentials.types';

// Providers (07-05)
export { ITransmissionProvider } from './providers/transmission-provider.interface';
export { DctceDirectProvider } from './providers/dctce-direct.provider';
export { AspProvider } from './providers/asp.provider';
export { SandboxProvider } from './providers/sandbox.provider';
export * from './providers/provider.types';

// TDD (07-04)
export { TddBuilderService } from './tdd/tdd-builder.service';
export * from './tdd/tdd.types';

// MLS (07-06)
export { MlsHandlerService } from './mls/mls-handler.service';
export { ErrorMapperService } from './mls/error-mapper.service';
export * from './mls/mls.types';

// Queue (07-07)
export { TransmissionQueueService } from './queue/transmission-queue.service';
export { TransmissionWorkerService } from './queue/transmission-worker.service';
export * from './queue/queue.types';

// Export (07-08)
export { EInvoiceExportService } from './export/export.service';
export * from './export/export.types';
```

Also ensure each subdirectory has its own index.ts:
- credentials/index.ts
- providers/index.ts
- tdd/index.ts
- mls/index.ts
- queue/index.ts
- export/index.ts
  </action>
  <verify>
    - `npx tsc --noEmit` compiles successfully
    - All services importable from '@services/einvoice'
    - No circular dependency errors
    - Type exports work correctly
  </verify>
  <done>Barrel exports created for all e-invoice services (Phase 6 + Phase 7)</done>
</task>

</tasks>

<verification>
1. TRANSMISSION_TYPES: All 15 symbols defined
2. transmission.module.ts: All services bound
3. Singleton scope: Caches, queues, stateless services
4. Transient scope: Providers (credential-aware)
5. Provider factory: Resolves DCTCE_DIRECT, ASP, SANDBOX
6. Container loads: No errors at startup
7. Barrel exports: All services importable from single path
8. verifyTransmissionServices(): Passes without errors
</verification>

<success_criteria>
1. `container.get(TRANSMISSION_TYPES.TransmissionQueueService)` returns instance
2. `container.get(TRANSMISSION_TYPES.TddBuilderService)` returns instance
3. Provider factory resolves correct provider for each mode
4. DctceDirectProvider initializes with company credentials
5. All services injectable with dependencies resolved
6. No circular dependency errors
7. App starts without DI errors
8. Services importable: `import { TddBuilderService } from '@services/einvoice'`
</success_criteria>

<output>
After completion, create `.planning/phases/07-e-invoicing-transmission/07-10-SUMMARY.md`
</output>
