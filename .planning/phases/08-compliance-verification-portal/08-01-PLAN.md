---
phase: 08-compliance-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web-erp-app/backend/prisma/schema.prisma
  - web-erp-app/backend/prisma/migrations/*
  - web-erp-app/backend/src/types/compliance-portal.types.ts
autonomous: true

must_haves:
  truths:
    - "compliance_sign_offs table exists in database"
    - "compliance_check_runs table exists in database"
    - "TypeScript types for portal services are defined"
  artifacts:
    - path: "web-erp-app/backend/prisma/schema.prisma"
      provides: "compliance_sign_offs and compliance_check_runs models"
      contains: "model compliance_sign_offs"
    - path: "web-erp-app/backend/src/types/compliance-portal.types.ts"
      provides: "Portal interfaces and types"
      exports: ["ComplianceStatus", "DomainComplianceStatus", "CheckDefinition", "CheckResult"]
  key_links:
    - from: "compliance-portal.types.ts"
      to: "@prisma/client"
      via: "generated Prisma types"
      pattern: "import.*@prisma/client"
---

<objective>
Create database schema and TypeScript types for the compliance verification portal.

Purpose: Establish the data foundation for storing sign-off records with immutable snapshots and historical check run results required by VERIFY-08 and VERIFY-09.

Output: Database tables (compliance_sign_offs, compliance_check_runs) and TypeScript type definitions for all portal service interfaces.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-compliance-verification-portal/08-RESEARCH.md

# Existing schema patterns from Phase 2
@web-erp-app/backend/prisma/schema.prisma

# Existing types pattern
@web-erp-app/backend/src/types/audit.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add compliance portal models to Prisma schema</name>
  <files>web-erp-app/backend/prisma/schema.prisma</files>
  <action>
Add two new models to the Prisma schema:

1. compliance_sign_offs model:
```prisma
model compliance_sign_offs {
  id                String   @id @default(uuid())
  companyId         String   @map("company_id")
  domain            String   // VAT, CT, WPS, EINVOICE
  periodId          String   @map("period_id")

  // Status tracking
  status            String   @default("PENDING_APPROVAL") // PENDING_APPROVAL, APPROVED, REJECTED
  submittedById     String   @map("submitted_by_id")
  submittedAt       DateTime @map("submitted_at")
  approvedAt        DateTime? @map("approved_at")
  rejectedAt        DateTime? @map("rejected_at")
  rejectedReason    String?  @map("rejected_reason")

  // Immutable snapshots (JSON)
  checklistSnapshot Json     @map("checklist_snapshot")
  previewSnapshot   Json     @map("preview_snapshot")

  // Approval workflow record
  approvalRecord    Json?    @map("approval_record")

  // Audit fields
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  company           companies @relation(fields: [companyId], references: [id])
  submittedBy       users     @relation("sign_off_submitter", fields: [submittedById], references: [id])

  @@index([companyId, domain, status])
  @@index([periodId])
  @@map("compliance_sign_offs")
}
```

2. compliance_check_runs model:
```prisma
model compliance_check_runs {
  id              String   @id @default(uuid())
  companyId       String   @map("company_id")
  domain          String   // VAT, CT, WPS, EINVOICE
  periodId        String?  @map("period_id")

  // Results
  status          String   // PASS, WARNING, FAIL
  checksPassed    Int      @map("checks_passed")
  checksTotal     Int      @map("checks_total")
  resultsJson     Json     @map("results_json")

  // Metadata
  triggeredBy     String   @map("triggered_by") // userId or 'SYSTEM'
  triggerType     String   @map("trigger_type") // MANUAL, SCHEDULED, ON_CHANGE
  runDurationMs   Int      @map("run_duration_ms")

  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  company         companies @relation(fields: [companyId], references: [id])

  @@index([companyId, domain, createdAt])
  @@map("compliance_check_runs")
}
```

3. Update companies model to add relation fields:
```prisma
// Add to companies model
signOffs        compliance_sign_offs[]
checkRuns       compliance_check_runs[]
```

4. Update users model to add relation:
```prisma
// Add to users model
submittedSignOffs compliance_sign_offs[] @relation("sign_off_submitter")
```

Follow existing naming conventions (snake_case for DB columns via @map, camelCase for Prisma fields).
  </action>
  <verify>npx prisma validate</verify>
  <done>Prisma schema validates with new compliance portal models</done>
</task>

<task type="auto">
  <name>Task 2: Create and apply database migration</name>
  <files>web-erp-app/backend/prisma/migrations/*</files>
  <action>
Generate and apply Prisma migration for compliance portal schema:

```bash
cd web-erp-app/backend
npx prisma migrate dev --name add_compliance_portal_tables
```

The migration should create:
- compliance_sign_offs table with all columns and indexes
- compliance_check_runs table with all columns and indexes
- Foreign key constraints to companies and users tables

After migration, regenerate Prisma client:
```bash
npx prisma generate
```

Verify tables exist in the database schema.
  </action>
  <verify>npx prisma db pull --print | grep -E "compliance_sign_offs|compliance_check_runs"</verify>
  <done>Migration applied, tables exist in database, Prisma client regenerated</done>
</task>

<task type="auto">
  <name>Task 3: Create compliance portal TypeScript types</name>
  <files>web-erp-app/backend/src/types/compliance-portal.types.ts</files>
  <action>
Create comprehensive TypeScript types for compliance portal services:

```typescript
/**
 * Compliance Portal Types
 *
 * Phase: 08-compliance-verification
 * Plan: 08-01
 *
 * Type definitions for compliance verification portal services
 * including status aggregation, checklists, previews, and sign-offs.
 */

// ============================================================================
// Domain Types
// ============================================================================

export type ComplianceDomain = 'VAT' | 'CT' | 'WPS' | 'EINVOICE';

export type OverallComplianceStatus =
  | 'COMPLIANT'
  | 'WARNING'
  | 'NON_COMPLIANT'
  | 'UNKNOWN';

export type DomainStatus = 'PASS' | 'WARNING' | 'FAIL' | 'PENDING';

export type CheckSeverity = 'CRITICAL' | 'WARNING' | 'INFO';

export type SignOffStatus = 'PENDING_APPROVAL' | 'APPROVED' | 'REJECTED';

export type TriggerType = 'MANUAL' | 'SCHEDULED' | 'ON_CHANGE';

// ============================================================================
// Compliance Status Types
// ============================================================================

export interface ComplianceIssue {
  checkId: string;
  name: string;
  message: string;
  remediation: string;
  affectedRecords?: string[];
}

export interface DomainComplianceStatus {
  status: DomainStatus;
  checksPassed: number;
  checksTotal: number;
  criticalIssues: ComplianceIssue[];
  warnings: ComplianceIssue[];
  lastCheckedAt: Date;
}

export interface ComplianceStatus {
  overall: OverallComplianceStatus;
  lastUpdated: Date;
  domains: {
    vat: DomainComplianceStatus;
    corporateTax: DomainComplianceStatus;
    wps: DomainComplianceStatus;
    eInvoice: DomainComplianceStatus;
  };
}

// ============================================================================
// Check Definition Types
// ============================================================================

export interface CheckContext {
  companyId: string;
  periodId?: string;
  prisma: unknown; // PrismaClient injected at runtime
  services: ServiceContainer;
}

export interface ServiceContainer {
  vat: unknown;
  ct: unknown;
  wps: unknown;
  einv: unknown;
}

export interface CheckResult {
  passed: boolean;
  status: DomainStatus;
  message: string;
  details?: unknown;
  affectedRecords?: string[];
}

export interface CheckDefinition {
  id: string;
  domain: ComplianceDomain;
  name: string;
  description: string;
  severity: CheckSeverity;
  checkFn: (context: CheckContext) => Promise<CheckResult>;
  remediationGuide: string;
}

export interface CheckResultWithMeta {
  checkId: string;
  name: string;
  severity: CheckSeverity;
  result: CheckResult;
  remediationGuide: string;
}

// ============================================================================
// Preview Types
// ============================================================================

export type PreviewFormat = 'FORM_201' | 'CT_RETURN' | 'SIF_FILE' | 'PINT_AE_XML';

export interface ValidationMessage {
  code: string;
  message: string;
  severity: 'ERROR' | 'WARNING' | 'INFO';
  field?: string;
}

export interface PreviewSummary {
  totalRecords: number;
  totalAmount: number;
  totalTax: number;
  filingDeadline: Date;
}

export interface SubmissionPreviewData {
  domain: ComplianceDomain;
  periodId: string;
  format: PreviewFormat;
  previewHtml: string;
  rawData: unknown;
  summary: PreviewSummary;
  validationStatus: 'VALID' | 'WARNINGS' | 'INVALID';
  validationMessages: ValidationMessage[];
}

// ============================================================================
// Sandbox Types
// ============================================================================

export type SandboxTestType = 'FULL' | 'QUICK' | 'SPECIFIC';

export interface SandboxTestRequest {
  domain: ComplianceDomain;
  testType: SandboxTestType;
  documentIds?: string[];
}

export interface SandboxDocumentResult {
  documentId: string;
  documentNumber: string;
  status: 'PASS' | 'FAIL' | 'ERROR';
  errors?: Array<{ code: string; message: string }>;
  sandboxResponse?: unknown;
}

export interface SandboxTestResult {
  testId: string;
  domain: ComplianceDomain;
  status: 'PASS' | 'FAIL' | 'PARTIAL';
  startedAt: Date;
  completedAt: Date;
  testsRun: number;
  testsPassed: number;
  testsFailed: number;
  results: SandboxDocumentResult[];
}

// ============================================================================
// Sign-Off Types
// ============================================================================

export interface ComplianceSignOffRequest {
  companyId: string;
  domain: ComplianceDomain;
  periodId: string;
  submitterId: string;
  checklistResults: DomainComplianceStatus;
  previewData: SubmissionPreviewData;
}

export interface PendingApprover {
  userId: string;
  userName?: string;
  roleId?: string;
  roleName?: string;
}

export interface SignOffResult {
  signOffId: string;
  approvalId: string;
  status: SignOffStatus;
  currentLevel: number;
  pendingApprovers: PendingApprover[];
}

export interface ApprovalResult {
  approvalId: string;
  isFullyApproved: boolean;
  currentLevel: number;
  totalLevels: number;
  approvalHistory: Array<{
    level: number;
    approverId: string;
    approverName?: string;
    approvedAt: Date;
    comments?: string;
  }>;
}

// ============================================================================
// Approval History Types
// ============================================================================

export interface ApprovalHistoryEntry {
  signOffId: string;
  domain: ComplianceDomain;
  periodId: string;
  status: SignOffStatus;
  submittedAt: Date;
  submittedBy: {
    id: string;
    name: string;
    email: string;
  };
  approvedAt?: Date;
  rejectedAt?: Date;
  rejectedReason?: string;
  approvalChain: Array<{
    level: number;
    approverName: string;
    approvedAt: Date;
    comments?: string;
  }>;
}

export interface ApprovalHistoryFilter {
  domain?: ComplianceDomain;
  status?: SignOffStatus;
  startDate?: Date;
  endDate?: Date;
  limit?: number;
  offset?: number;
}

// ============================================================================
// Check Run Types (for historical tracking)
// ============================================================================

export interface CheckRunRecord {
  id: string;
  companyId: string;
  domain: ComplianceDomain;
  periodId?: string;
  status: DomainStatus;
  checksPassed: number;
  checksTotal: number;
  resultsJson: CheckResultWithMeta[];
  triggeredBy: string;
  triggerType: TriggerType;
  runDurationMs: number;
  createdAt: Date;
}

export interface CreateCheckRunInput {
  companyId: string;
  domain: ComplianceDomain;
  periodId?: string;
  status: DomainStatus;
  checksPassed: number;
  checksTotal: number;
  resultsJson: CheckResultWithMeta[];
  triggeredBy: string;
  triggerType: TriggerType;
  runDurationMs: number;
}
```

Follow existing type patterns from audit.types.ts and ensure proper JSDoc comments.
  </action>
  <verify>npx tsc --noEmit web-erp-app/backend/src/types/compliance-portal.types.ts</verify>
  <done>TypeScript types compile without errors and export all required interfaces</done>
</task>

</tasks>

<verification>
1. Run `npx prisma validate` - schema is valid
2. Run `npx prisma db pull --print | grep compliance` - tables exist
3. Run `npx tsc --noEmit` - TypeScript compiles
4. Verify migration file exists in prisma/migrations/
</verification>

<success_criteria>
1. compliance_sign_offs table exists with all columns and indexes
2. compliance_check_runs table exists with all columns and indexes
3. Foreign key constraints to companies and users tables work
4. TypeScript types export all interfaces needed by portal services
5. Prisma client regenerated with new models
</success_criteria>

<output>
After completion, create `.planning/phases/08-compliance-verification-portal/08-01-SUMMARY.md`
</output>
