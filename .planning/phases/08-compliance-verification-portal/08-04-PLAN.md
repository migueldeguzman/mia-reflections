---
phase: 08-compliance-verification
plan: 04
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - web-erp-app/backend/src/services/compliance-portal/compliance-preview.service.ts
  - web-erp-app/backend/src/services/compliance-portal/index.ts
autonomous: true

must_haves:
  truths:
    - "FTA preview shows exactly what will be submitted"
    - "Preview includes summary with record count, amounts, and deadline"
    - "Validation status indicates if preview is valid for submission"
  artifacts:
    - path: "web-erp-app/backend/src/services/compliance-portal/compliance-preview.service.ts"
      provides: "FTA submission preview generation"
      exports: ["CompliancePreviewService"]
      min_lines: 200
  key_links:
    - from: "compliance-preview.service.ts"
      to: "VatReturnService"
      via: "generateForm201 call"
      pattern: "generateForm201|Form201"
---

<objective>
Create the CompliancePreviewService that generates FTA submission previews for all compliance domains.

Purpose: Implement VERIFY-07 (FTA submission preview) allowing users to see exactly what will be submitted before final sign-off.

Output: CompliancePreviewService with generatePreview() method for VAT Form 201, CT Return, WPS SIF, and PINT-AE XML previews.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-compliance-verification-portal/08-RESEARCH.md

# Prior plan summaries
@.planning/phases/08-compliance-verification-portal/08-01-SUMMARY.md
@.planning/phases/08-compliance-verification-portal/08-02-SUMMARY.md

# Type definitions
@web-erp-app/backend/src/types/compliance-portal.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CompliancePreviewService</name>
  <files>web-erp-app/backend/src/services/compliance-portal/compliance-preview.service.ts</files>
  <action>
Create the CompliancePreviewService that generates submission previews:

```typescript
/**
 * Compliance Preview Service
 *
 * Phase: 08-compliance-verification
 * Plan: 08-04
 * Requirement: VERIFY-07 (FTA submission preview)
 *
 * Generates preview of what will be submitted to FTA before final sign-off.
 * Supports all compliance domains:
 * - VAT: Form 201 preview
 * - CT: Corporate Tax Return preview
 * - WPS: SIF file preview
 * - E-Invoice: PINT-AE XML preview
 */

import { injectable, inject } from 'inversify';
import { PrismaClient } from '@prisma/client';
import { TYPES } from '../../config/types';
import {
  ComplianceDomain,
  SubmissionPreviewData,
  PreviewFormat,
  ValidationMessage,
  PreviewSummary,
} from '../../types/compliance-portal.types';

@injectable()
export class CompliancePreviewService {
  constructor(
    @inject(TYPES.PrismaClient) private readonly prisma: PrismaClient
  ) {}

  // ==========================================================================
  // Public Methods
  // ==========================================================================

  /**
   * Generates submission preview for a compliance domain
   *
   * @param companyId - Company generating preview
   * @param domain - Compliance domain
   * @param periodId - Period to preview
   * @param userId - User requesting preview (for authorization)
   */
  async generatePreview(
    companyId: string,
    domain: ComplianceDomain,
    periodId: string,
    userId: string
  ): Promise<SubmissionPreviewData> {
    // Validate company access
    await this.validateCompanyAccess(userId, companyId);

    switch (domain) {
      case 'VAT':
        return await this.generateVatPreview(companyId, periodId);
      case 'CT':
        return await this.generateCtPreview(companyId, periodId);
      case 'WPS':
        return await this.generateWpsPreview(companyId, periodId);
      case 'EINVOICE':
        return await this.generateEInvoicePreview(companyId, periodId);
      default:
        throw new Error(`Unknown domain: ${domain}`);
    }
  }

  // ==========================================================================
  // VAT Preview (Form 201)
  // ==========================================================================

  /**
   * Generates VAT Form 201 preview
   */
  private async generateVatPreview(
    companyId: string,
    periodId: string
  ): Promise<SubmissionPreviewData> {
    // Get VAT period details
    const period = await this.prisma.$queryRaw<any[]>`
      SELECT * FROM vat_periods WHERE id = ${periodId}::uuid AND company_id = ${companyId}::uuid
    `.catch(() => []);

    if (period.length === 0) {
      throw new Error('VAT period not found');
    }

    const vatPeriod = period[0];

    // Get company TRN
    const company = await this.prisma.companies.findUnique({
      where: { id: companyId },
      select: { name: true, taxNumber: true },
    });

    // Calculate VAT totals from transactions
    const salesTotal = await this.prisma.$queryRaw<[{ total: any }]>`
      SELECT COALESCE(SUM(total_amount), 0) as total
      FROM invoices
      WHERE company_id = ${companyId}::uuid
        AND invoice_date >= ${vatPeriod.start_date}::date
        AND invoice_date <= ${vatPeriod.end_date}::date
        AND status IN ('SENT', 'PAID')
    `.catch(() => [{ total: 0 }]);

    const vatOutput = Number(salesTotal[0]?.total || 0) * 0.05;

    const purchaseTotal = await this.prisma.$queryRaw<[{ total: any }]>`
      SELECT COALESCE(SUM(total_amount), 0) as total
      FROM bills
      WHERE company_id = ${companyId}::uuid
        AND bill_date >= ${vatPeriod.start_date}::date
        AND bill_date <= ${vatPeriod.end_date}::date
        AND status IN ('APPROVED', 'POSTED')
    `.catch(() => [{ total: 0 }]);

    const vatInput = Number(purchaseTotal[0]?.total || 0) * 0.05;
    const netVat = vatOutput - vatInput;

    // Build Form 201 structure
    const form201Data = {
      trn: company?.taxNumber || '',
      taxRegistrationName: company?.name || '',
      periodFrom: vatPeriod.start_date,
      periodTo: vatPeriod.end_date,
      dueDate: this.calculateVatDueDate(vatPeriod.end_date),
      boxes: {
        box1: { label: 'Standard Rated Supplies', amount: Number(salesTotal[0]?.total || 0), vat: vatOutput },
        box2: { label: 'Zero Rated Supplies', amount: 0, vat: 0 },
        box3: { label: 'Exempt Supplies', amount: 0 },
        box4: { label: 'Supplies Subject to Reverse Charge', amount: 0, vat: 0 },
        box5: { label: 'Adjustments to Output Tax', amount: 0 },
        box6: { label: 'Total Output Tax Due', amount: vatOutput },
        box7: { label: 'Standard Rated Expenses', amount: Number(purchaseTotal[0]?.total || 0), vat: vatInput },
        box8: { label: 'Zero Rated Expenses', amount: 0 },
        box9: { label: 'Recoverable Reverse Charge', amount: 0, vat: 0 },
        box10: { label: 'Adjustments to Input Tax', amount: 0 },
        box11: { label: 'Total Input Tax Recoverable', amount: vatInput },
        box12: { label: 'Net VAT Due (Box 6 - Box 11)', amount: netVat },
        box13: { label: 'Carried Forward Credit', amount: 0 },
        box14: { label: 'Net VAT Payable', amount: Math.max(0, netVat) },
      },
    };

    // Generate preview HTML
    const previewHtml = this.renderVatForm201Html(form201Data);

    // Validate the data
    const validationMessages = this.validateVatPreview(form201Data);

    return {
      domain: 'VAT',
      periodId,
      format: 'FORM_201',
      previewHtml,
      rawData: form201Data,
      summary: {
        totalRecords: 1,
        totalAmount: form201Data.boxes.box1.amount,
        totalTax: netVat,
        filingDeadline: form201Data.dueDate,
      },
      validationStatus: validationMessages.some(m => m.severity === 'ERROR') ? 'INVALID' :
                        validationMessages.some(m => m.severity === 'WARNING') ? 'WARNINGS' : 'VALID',
      validationMessages,
    };
  }

  /**
   * Renders VAT Form 201 as HTML
   */
  private renderVatForm201Html(form201: any): string {
    return `
      <div class="form-201-preview">
        <h2>VAT Return - Form 201</h2>
        <div class="header">
          <p><strong>TRN:</strong> ${form201.trn}</p>
          <p><strong>Tax Registration Name:</strong> ${form201.taxRegistrationName}</p>
          <p><strong>Period:</strong> ${new Date(form201.periodFrom).toLocaleDateString()} - ${new Date(form201.periodTo).toLocaleDateString()}</p>
          <p><strong>Due Date:</strong> ${new Date(form201.dueDate).toLocaleDateString()}</p>
        </div>
        <table class="form-201-table">
          <thead>
            <tr><th>Box</th><th>Description</th><th>Amount (AED)</th><th>VAT (AED)</th></tr>
          </thead>
          <tbody>
            ${Object.entries(form201.boxes).map(([key, box]: [string, any]) => `
              <tr>
                <td>${key.toUpperCase()}</td>
                <td>${box.label}</td>
                <td>${box.amount?.toLocaleString() || '-'}</td>
                <td>${box.vat !== undefined ? box.vat.toLocaleString() : '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <div class="summary">
          <p><strong>Net VAT Payable:</strong> AED ${form201.boxes.box14.amount.toLocaleString()}</p>
        </div>
      </div>
    `;
  }

  /**
   * Validates VAT preview data
   */
  private validateVatPreview(form201: any): ValidationMessage[] {
    const messages: ValidationMessage[] = [];

    if (!form201.trn || !/^100\d{12}$/.test(form201.trn)) {
      messages.push({
        code: 'VAT-ERR-001',
        message: 'Invalid TRN format',
        severity: 'ERROR',
        field: 'trn',
      });
    }

    if (new Date(form201.dueDate) < new Date()) {
      messages.push({
        code: 'VAT-WARN-001',
        message: 'Filing deadline has passed',
        severity: 'WARNING',
        field: 'dueDate',
      });
    }

    return messages;
  }

  /**
   * Calculates VAT due date (28 days after period end)
   */
  private calculateVatDueDate(periodEnd: Date | string): Date {
    const end = new Date(periodEnd);
    end.setDate(end.getDate() + 28);
    return end;
  }

  // ==========================================================================
  // Corporate Tax Preview
  // ==========================================================================

  /**
   * Generates Corporate Tax Return preview
   */
  private async generateCtPreview(
    companyId: string,
    periodId: string
  ): Promise<SubmissionPreviewData> {
    // Get fiscal year details
    const fiscalYear = await this.prisma.fiscal_years.findFirst({
      where: { companyId, id: periodId },
    }).catch(() => null);

    if (!fiscalYear) {
      throw new Error('Fiscal year not found');
    }

    // Get company info
    const company = await this.prisma.companies.findUnique({
      where: { id: companyId },
      select: { name: true, taxNumber: true },
    });

    // Get accounting income (simplified)
    const income = await this.prisma.$queryRaw<[{ total: any }]>`
      SELECT COALESCE(SUM(amount), 0) as total
      FROM accounting_journal_lines ajl
      JOIN accounting_journal_entries aje ON ajl.journal_entry_id = aje.id
      JOIN chart_of_accounts coa ON ajl.account_id = coa.id
      WHERE aje.company_id = ${companyId}::uuid
        AND aje.entry_date >= ${fiscalYear.startDate}::date
        AND aje.entry_date <= ${fiscalYear.endDate}::date
        AND coa.account_type = 'REVENUE'
    `.catch(() => [{ total: 0 }]);

    const expenses = await this.prisma.$queryRaw<[{ total: any }]>`
      SELECT COALESCE(SUM(amount), 0) as total
      FROM accounting_journal_lines ajl
      JOIN accounting_journal_entries aje ON ajl.journal_entry_id = aje.id
      JOIN chart_of_accounts coa ON ajl.account_id = coa.id
      WHERE aje.company_id = ${companyId}::uuid
        AND aje.entry_date >= ${fiscalYear.startDate}::date
        AND aje.entry_date <= ${fiscalYear.endDate}::date
        AND coa.account_type = 'EXPENSE'
    `.catch(() => [{ total: 0 }]);

    const accountingIncome = Number(income[0]?.total || 0) - Number(expenses[0]?.total || 0);
    const threshold = 375000;
    const taxRate = 0.09;
    const taxableIncome = Math.max(0, accountingIncome - threshold);
    const ctDue = taxableIncome * taxRate;

    const ctData = {
      trn: company?.taxNumber || '',
      companyName: company?.name || '',
      fiscalYear: fiscalYear.yearName,
      periodFrom: fiscalYear.startDate,
      periodTo: fiscalYear.endDate,
      dueDate: this.calculateCtDueDate(fiscalYear.endDate),
      calculations: {
        accountingIncome,
        adjustments: {
          nonDeductible: 0,
          exempt: 0,
        },
        taxableIncome,
        threshold,
        incomeAboveThreshold: taxableIncome,
        taxRate: '9%',
        corporateTaxDue: ctDue,
      },
    };

    const previewHtml = this.renderCtReturnHtml(ctData);
    const validationMessages = this.validateCtPreview(ctData);

    return {
      domain: 'CT',
      periodId,
      format: 'CT_RETURN',
      previewHtml,
      rawData: ctData,
      summary: {
        totalRecords: 1,
        totalAmount: accountingIncome,
        totalTax: ctDue,
        filingDeadline: ctData.dueDate,
      },
      validationStatus: validationMessages.some(m => m.severity === 'ERROR') ? 'INVALID' :
                        validationMessages.some(m => m.severity === 'WARNING') ? 'WARNINGS' : 'VALID',
      validationMessages,
    };
  }

  /**
   * Renders CT Return as HTML
   */
  private renderCtReturnHtml(ctData: any): string {
    return `
      <div class="ct-return-preview">
        <h2>Corporate Tax Return</h2>
        <div class="header">
          <p><strong>TRN:</strong> ${ctData.trn}</p>
          <p><strong>Company:</strong> ${ctData.companyName}</p>
          <p><strong>Fiscal Year:</strong> ${ctData.fiscalYear}</p>
          <p><strong>Period:</strong> ${new Date(ctData.periodFrom).toLocaleDateString()} - ${new Date(ctData.periodTo).toLocaleDateString()}</p>
          <p><strong>Filing Deadline:</strong> ${new Date(ctData.dueDate).toLocaleDateString()}</p>
        </div>
        <table class="ct-table">
          <tbody>
            <tr><td>Accounting Income</td><td>AED ${ctData.calculations.accountingIncome.toLocaleString()}</td></tr>
            <tr><td>Non-Deductible Expenses</td><td>AED ${ctData.calculations.adjustments.nonDeductible.toLocaleString()}</td></tr>
            <tr><td>Exempt Income</td><td>(AED ${ctData.calculations.adjustments.exempt.toLocaleString()})</td></tr>
            <tr><td>Taxable Income</td><td>AED ${ctData.calculations.taxableIncome.toLocaleString()}</td></tr>
            <tr><td>Small Business Threshold</td><td>(AED ${ctData.calculations.threshold.toLocaleString()})</td></tr>
            <tr><td>Income Above Threshold</td><td>AED ${ctData.calculations.incomeAboveThreshold.toLocaleString()}</td></tr>
            <tr><td>Tax Rate</td><td>${ctData.calculations.taxRate}</td></tr>
            <tr class="total"><td><strong>Corporate Tax Due</strong></td><td><strong>AED ${ctData.calculations.corporateTaxDue.toLocaleString()}</strong></td></tr>
          </tbody>
        </table>
      </div>
    `;
  }

  /**
   * Validates CT preview data
   */
  private validateCtPreview(ctData: any): ValidationMessage[] {
    const messages: ValidationMessage[] = [];

    if (!ctData.trn) {
      messages.push({
        code: 'CT-WARN-001',
        message: 'TRN not configured',
        severity: 'WARNING',
        field: 'trn',
      });
    }

    return messages;
  }

  /**
   * Calculates CT due date (9 months after period end)
   */
  private calculateCtDueDate(periodEnd: Date | string): Date {
    const end = new Date(periodEnd);
    end.setMonth(end.getMonth() + 9);
    return end;
  }

  // ==========================================================================
  // WPS Preview (SIF File)
  // ==========================================================================

  /**
   * Generates WPS SIF file preview
   */
  private async generateWpsPreview(
    companyId: string,
    periodId: string
  ): Promise<SubmissionPreviewData> {
    // Get payroll cycle
    const cycle = await this.prisma.$queryRaw<any[]>`
      SELECT * FROM payroll_cycles WHERE id = ${periodId}::uuid AND company_id = ${companyId}::uuid
    `.catch(() => []);

    if (cycle.length === 0) {
      throw new Error('Payroll cycle not found');
    }

    const payrollCycle = cycle[0];

    // Get salary records
    const salaryRecords = await this.prisma.$queryRaw<any[]>`
      SELECT * FROM employee_salary_records
      WHERE payroll_cycle_id = ${periodId}::uuid
      ORDER BY person_code
    `.catch(() => []);

    const totalSalary = salaryRecords.reduce((sum, r) => sum + Number(r.salary || 0), 0);
    const employeeCount = salaryRecords.length;

    const wpsData = {
      cycleId: payrollCycle.id,
      cycleName: payrollCycle.name || `${payrollCycle.month}/${payrollCycle.year}`,
      month: payrollCycle.month,
      year: payrollCycle.year,
      employeeCount,
      totalSalary,
      records: salaryRecords.map((r: any) => ({
        personCode: r.person_code,
        iban: r.iban,
        salary: Number(r.salary),
        allowances: Number(r.allowances || 0),
        deductions: Number(r.deductions || 0),
        netSalary: Number(r.net_salary || r.salary),
      })),
    };

    const previewHtml = this.renderWpsSifHtml(wpsData);
    const validationMessages = this.validateWpsPreview(wpsData);

    return {
      domain: 'WPS',
      periodId,
      format: 'SIF_FILE',
      previewHtml,
      rawData: wpsData,
      summary: {
        totalRecords: employeeCount,
        totalAmount: totalSalary,
        totalTax: 0, // WPS doesn't have tax
        filingDeadline: new Date(), // WPS has no fixed deadline
      },
      validationStatus: validationMessages.some(m => m.severity === 'ERROR') ? 'INVALID' :
                        validationMessages.some(m => m.severity === 'WARNING') ? 'WARNINGS' : 'VALID',
      validationMessages,
    };
  }

  /**
   * Renders WPS SIF as HTML
   */
  private renderWpsSifHtml(wpsData: any): string {
    return `
      <div class="wps-sif-preview">
        <h2>WPS SIF File Preview</h2>
        <div class="header">
          <p><strong>Payroll Cycle:</strong> ${wpsData.cycleName}</p>
          <p><strong>Employees:</strong> ${wpsData.employeeCount}</p>
          <p><strong>Total Salary:</strong> AED ${wpsData.totalSalary.toLocaleString()}</p>
        </div>
        <table class="sif-table">
          <thead>
            <tr><th>Person Code</th><th>IBAN</th><th>Salary</th><th>Allowances</th><th>Deductions</th><th>Net</th></tr>
          </thead>
          <tbody>
            ${wpsData.records.slice(0, 20).map((r: any) => `
              <tr>
                <td>${r.personCode || '-'}</td>
                <td>${r.iban ? '****' + r.iban.slice(-4) : '-'}</td>
                <td>${r.salary.toLocaleString()}</td>
                <td>${r.allowances.toLocaleString()}</td>
                <td>${r.deductions.toLocaleString()}</td>
                <td>${r.netSalary.toLocaleString()}</td>
              </tr>
            `).join('')}
            ${wpsData.records.length > 20 ? `<tr><td colspan="6">... and ${wpsData.records.length - 20} more records</td></tr>` : ''}
          </tbody>
        </table>
      </div>
    `;
  }

  /**
   * Validates WPS preview data
   */
  private validateWpsPreview(wpsData: any): ValidationMessage[] {
    const messages: ValidationMessage[] = [];

    // Check for missing person codes
    const missingPersonCodes = wpsData.records.filter((r: any) => !r.personCode || r.personCode.length !== 14);
    if (missingPersonCodes.length > 0) {
      messages.push({
        code: 'WPS-ERR-001',
        message: `${missingPersonCodes.length} employees missing valid Person Codes`,
        severity: 'ERROR',
        field: 'personCode',
      });
    }

    // Check for invalid IBANs
    const invalidIbans = wpsData.records.filter((r: any) => !r.iban || r.iban.length !== 23 || !r.iban.startsWith('AE'));
    if (invalidIbans.length > 0) {
      messages.push({
        code: 'WPS-ERR-002',
        message: `${invalidIbans.length} employees have invalid IBANs`,
        severity: 'ERROR',
        field: 'iban',
      });
    }

    return messages;
  }

  // ==========================================================================
  // E-Invoice Preview (PINT-AE XML)
  // ==========================================================================

  /**
   * Generates E-Invoice PINT-AE preview
   */
  private async generateEInvoicePreview(
    companyId: string,
    periodId: string
  ): Promise<SubmissionPreviewData> {
    // Get e-invoice archives for the period (or batch)
    const archives = await this.prisma.$queryRaw<any[]>`
      SELECT * FROM einvoice_archives
      WHERE company_id = ${companyId}::uuid
        AND id = ${periodId}::uuid
      LIMIT 1
    `.catch(() => []);

    if (archives.length === 0) {
      throw new Error('E-Invoice archive not found');
    }

    const archive = archives[0];

    const einvoiceData = {
      einvoiceNumber: archive.einvoice_number,
      documentType: archive.document_type,
      issueDate: archive.issue_date,
      supplierTrn: archive.supplier_trn,
      recipientTrn: archive.recipient_trn,
      totalAmount: Number(archive.total_amount),
      vatAmount: Number(archive.vat_amount),
      currency: 'AED',
      xmlContent: archive.xml_content,
    };

    const previewHtml = this.renderEInvoiceHtml(einvoiceData);
    const validationMessages = this.validateEInvoicePreview(einvoiceData);

    return {
      domain: 'EINVOICE',
      periodId,
      format: 'PINT_AE_XML',
      previewHtml,
      rawData: einvoiceData,
      summary: {
        totalRecords: 1,
        totalAmount: einvoiceData.totalAmount,
        totalTax: einvoiceData.vatAmount,
        filingDeadline: new Date(), // E-invoices should be transmitted promptly
      },
      validationStatus: validationMessages.some(m => m.severity === 'ERROR') ? 'INVALID' :
                        validationMessages.some(m => m.severity === 'WARNING') ? 'WARNINGS' : 'VALID',
      validationMessages,
    };
  }

  /**
   * Renders E-Invoice as HTML
   */
  private renderEInvoiceHtml(einvoiceData: any): string {
    return `
      <div class="einvoice-preview">
        <h2>E-Invoice Preview (PINT-AE)</h2>
        <div class="header">
          <p><strong>Invoice Number:</strong> ${einvoiceData.einvoiceNumber}</p>
          <p><strong>Document Type:</strong> ${einvoiceData.documentType}</p>
          <p><strong>Issue Date:</strong> ${new Date(einvoiceData.issueDate).toLocaleDateString()}</p>
          <p><strong>Supplier TRN:</strong> ${einvoiceData.supplierTrn}</p>
          <p><strong>Recipient TRN:</strong> ${einvoiceData.recipientTrn || 'N/A'}</p>
          <p><strong>Total Amount:</strong> ${einvoiceData.currency} ${einvoiceData.totalAmount.toLocaleString()}</p>
          <p><strong>VAT Amount:</strong> ${einvoiceData.currency} ${einvoiceData.vatAmount.toLocaleString()}</p>
        </div>
        <details>
          <summary>View XML Content</summary>
          <pre class="xml-content">${this.escapeHtml(einvoiceData.xmlContent?.substring(0, 5000) || '')}</pre>
          ${(einvoiceData.xmlContent?.length || 0) > 5000 ? '<p>... (truncated)</p>' : ''}
        </details>
      </div>
    `;
  }

  /**
   * Validates E-Invoice preview data
   */
  private validateEInvoicePreview(einvoiceData: any): ValidationMessage[] {
    const messages: ValidationMessage[] = [];

    if (!einvoiceData.supplierTrn) {
      messages.push({
        code: 'EINV-ERR-001',
        message: 'Supplier TRN is required',
        severity: 'ERROR',
        field: 'supplierTrn',
      });
    }

    if (!einvoiceData.xmlContent) {
      messages.push({
        code: 'EINV-ERR-002',
        message: 'XML content is missing',
        severity: 'ERROR',
        field: 'xmlContent',
      });
    }

    return messages;
  }

  // ==========================================================================
  // Helper Methods
  // ==========================================================================

  /**
   * Validates user has access to company
   */
  private async validateCompanyAccess(userId: string, companyId: string): Promise<void> {
    const user = await this.prisma.users.findUnique({
      where: { id: userId },
      select: { companyId: true },
    });

    if (!user) {
      throw new Error('User not found');
    }

    if (user.companyId !== companyId) {
      throw new Error('Access denied: Cannot access compliance data from other company');
    }
  }

  /**
   * Escapes HTML for safe display
   */
  private escapeHtml(text: string): string {
    return text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }
}
```

Key implementation notes:
- Generates previews for all 4 compliance domains
- Includes validation with error/warning messages
- HTML preview suitable for UI rendering
- Raw data included for programmatic access
- Summary with totals and filing deadlines
  </action>
  <verify>npx tsc --noEmit web-erp-app/backend/src/services/compliance-portal/compliance-preview.service.ts</verify>
  <done>CompliancePreviewService compiles with generatePreview for all 4 domains</done>
</task>

<task type="auto">
  <name>Task 2: Update barrel export</name>
  <files>web-erp-app/backend/src/services/compliance-portal/index.ts</files>
  <action>
Update barrel export to include CompliancePreviewService:

```typescript
/**
 * Compliance Portal Services
 *
 * Phase: 08-compliance-verification
 *
 * Barrel exports for compliance verification portal services.
 */

// Core aggregation service
export { CompliancePortalService } from './compliance-portal.service';

// Checklist engine
export { ComplianceChecklistService } from './compliance-checklist.service';

// Preview generation
export { CompliancePreviewService } from './compliance-preview.service';

// Check definitions
export { CHECK_DEFINITIONS, TOTAL_CHECKS } from './check-definitions';

// Types re-export for convenience
export type {
  ComplianceStatus,
  DomainComplianceStatus,
  OverallComplianceStatus,
  ComplianceDomain,
  DomainStatus,
  ComplianceIssue,
  SubmissionPreviewData,
  ValidationMessage,
} from '../../types/compliance-portal.types';
```
  </action>
  <verify>npx tsc --noEmit web-erp-app/backend/src/services/compliance-portal/index.ts</verify>
  <done>Barrel export updated with CompliancePreviewService</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` - all files compile
2. Verify generatePreview returns SubmissionPreviewData with all required fields
3. Verify validation messages are generated for invalid data
4. Verify HTML preview is escaped properly
</verification>

<success_criteria>
1. VAT Form 201 preview shows all 14 boxes with amounts
2. CT Return preview shows accounting income to tax due calculation
3. WPS SIF preview shows employee list with Person Codes and IBANs
4. E-Invoice preview shows PINT-AE fields with XML content option
5. Each preview includes validation status and messages
6. Summary includes record count, amounts, and filing deadline
</success_criteria>

<output>
After completion, create `.planning/phases/08-compliance-verification-portal/08-04-SUMMARY.md`
</output>
