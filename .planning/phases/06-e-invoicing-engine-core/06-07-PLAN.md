---
phase: 06-e-invoicing-engine-core
plan: 07
type: execute
wave: 4
depends_on: [06-06]
files_modified:
  - backend/src/types/einvoice-permissions.ts
  - backend/src/middleware/einvoice-permissions.middleware.ts
  - backend/prisma/seeds/einvoice-permissions.seed.ts
autonomous: true

must_haves:
  truths:
    - "Permission codes follow existing pattern (einvoice:action:scope)"
    - "Role bundles defined for e-invoice operations"
    - "Permission middleware validates access before e-invoice operations"
    - "Seed script creates e-invoice permissions idempotently"
  artifacts:
    - path: "backend/src/types/einvoice-permissions.ts"
      provides: "Permission constants and role bundles"
      exports: ["EINVOICE_PERMISSIONS", "EINVOICE_ROLE_BUNDLES"]
    - path: "backend/src/middleware/einvoice-permissions.middleware.ts"
      provides: "E-invoice permission middleware"
      exports: ["requireEInvoicePermission"]
  key_links:
    - from: "einvoice-permissions.middleware.ts"
      to: "einvoice-permissions.ts"
      via: "Uses EINVOICE_PERMISSIONS constant"
      pattern: "EINVOICE_PERMISSIONS"
---

<objective>
Create permission constants, role bundles, and middleware for e-invoice access control.

Purpose: EINV-01 through EINV-06 require proper access control. Permissions ensure only authorized users can generate and manage e-invoices. Following established patterns from CT and VAT compliance modules.

Output:
- Permission constants following CT/VAT patterns
- Role bundles (Accountant, Finance Manager, CFO, Auditor)
- Permission middleware for e-invoice routes
- Idempotent seed script
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-e-invoicing-engine-core/06-RESEARCH.md

# E-invoice service from 06-06
@backend/src/services/einvoice/einvoice.service.ts

# Existing permission patterns
@backend/src/types/ct-permissions.ts
@backend/src/middleware/ct-permissions.middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create E-Invoice Permission Types</name>
  <files>backend/src/types/einvoice-permissions.ts</files>
  <action>
Create permission constants and role bundles following CT/VAT patterns:

```typescript
/**
 * E-Invoice Permission Types
 * Phase: 06-e-invoicing-engine-core
 * Requirements: EINV-01 through EINV-06
 *
 * Defines permission codes and role bundles for e-invoice operations.
 * Follows established patterns from CT and VAT permissions.
 */

/**
 * E-Invoice permission codes
 *
 * Format: einvoice:{resource}:{action}
 *
 * Resources:
 * - generate: E-invoice generation
 * - archive: Archive management
 * - submit: ASP submission (Phase 7)
 * - verify: Integrity verification
 * - config: E-invoice configuration
 */
export const EINVOICE_PERMISSIONS = {
  // Generation permissions
  GENERATE_VIEW: 'einvoice:generate:view',           // View generation form
  GENERATE_CREATE: 'einvoice:generate:create',       // Generate e-invoices
  GENERATE_BATCH: 'einvoice:generate:batch',         // Batch generation
  GENERATE_CREDIT_NOTE: 'einvoice:generate:credit',  // Generate credit notes

  // Archive permissions
  ARCHIVE_VIEW: 'einvoice:archive:view',             // View archived e-invoices
  ARCHIVE_DOWNLOAD: 'einvoice:archive:download',     // Download XML/QR
  ARCHIVE_LIST: 'einvoice:archive:list',             // List archives
  ARCHIVE_SEARCH: 'einvoice:archive:search',         // Search archives

  // Verification permissions
  VERIFY_INTEGRITY: 'einvoice:verify:integrity',     // Verify hash chain
  VERIFY_RETENTION: 'einvoice:verify:retention',     // Check retention status

  // Submission permissions (Phase 7 preparation)
  SUBMIT_INITIATE: 'einvoice:submit:initiate',       // Initiate ASP submission
  SUBMIT_VIEW: 'einvoice:submit:view',               // View submission status
  SUBMIT_RETRY: 'einvoice:submit:retry',             // Retry failed submissions
  SUBMIT_CANCEL: 'einvoice:submit:cancel',           // Cancel pending submissions

  // Configuration permissions
  CONFIG_VIEW: 'einvoice:config:view',               // View e-invoice config
  CONFIG_EDIT: 'einvoice:config:edit',               // Edit e-invoice settings
  CONFIG_ASP: 'einvoice:config:asp',                 // Configure ASP integration

  // Reporting permissions
  REPORT_VIEW: 'einvoice:report:view',               // View e-invoice reports
  REPORT_EXPORT: 'einvoice:report:export',           // Export reports
  REPORT_STATISTICS: 'einvoice:report:statistics',   // View statistics

  // Admin permissions
  ADMIN_FULL: 'einvoice:admin:full',                 // Full admin access
} as const;

export type EInvoicePermission = typeof EINVOICE_PERMISSIONS[keyof typeof EINVOICE_PERMISSIONS];

/**
 * All e-invoice permission codes as array
 */
export const ALL_EINVOICE_PERMISSIONS = Object.values(EINVOICE_PERMISSIONS);

/**
 * Role bundles for e-invoice operations
 *
 * Following separation of duties principle:
 * - Accountant: Generate and view
 * - Finance Manager: Generate, view, submit
 * - CFO: All operations including config
 * - Auditor: View and verify only
 */
export const EINVOICE_ROLE_BUNDLES = {
  /**
   * ACCOUNTANT role bundle
   * Can generate e-invoices and view archives
   */
  ACCOUNTANT: [
    EINVOICE_PERMISSIONS.GENERATE_VIEW,
    EINVOICE_PERMISSIONS.GENERATE_CREATE,
    EINVOICE_PERMISSIONS.GENERATE_CREDIT_NOTE,
    EINVOICE_PERMISSIONS.ARCHIVE_VIEW,
    EINVOICE_PERMISSIONS.ARCHIVE_DOWNLOAD,
    EINVOICE_PERMISSIONS.ARCHIVE_LIST,
    EINVOICE_PERMISSIONS.ARCHIVE_SEARCH,
    EINVOICE_PERMISSIONS.REPORT_VIEW,
  ],

  /**
   * FINANCE_MANAGER role bundle
   * Can generate, submit, and manage e-invoices
   */
  FINANCE_MANAGER: [
    EINVOICE_PERMISSIONS.GENERATE_VIEW,
    EINVOICE_PERMISSIONS.GENERATE_CREATE,
    EINVOICE_PERMISSIONS.GENERATE_BATCH,
    EINVOICE_PERMISSIONS.GENERATE_CREDIT_NOTE,
    EINVOICE_PERMISSIONS.ARCHIVE_VIEW,
    EINVOICE_PERMISSIONS.ARCHIVE_DOWNLOAD,
    EINVOICE_PERMISSIONS.ARCHIVE_LIST,
    EINVOICE_PERMISSIONS.ARCHIVE_SEARCH,
    EINVOICE_PERMISSIONS.VERIFY_INTEGRITY,
    EINVOICE_PERMISSIONS.VERIFY_RETENTION,
    EINVOICE_PERMISSIONS.SUBMIT_INITIATE,
    EINVOICE_PERMISSIONS.SUBMIT_VIEW,
    EINVOICE_PERMISSIONS.SUBMIT_RETRY,
    EINVOICE_PERMISSIONS.REPORT_VIEW,
    EINVOICE_PERMISSIONS.REPORT_EXPORT,
    EINVOICE_PERMISSIONS.REPORT_STATISTICS,
  ],

  /**
   * CFO role bundle
   * Full access to all e-invoice operations
   */
  CFO: [
    ...Object.values(EINVOICE_PERMISSIONS),
  ],

  /**
   * AUDITOR role bundle
   * Read-only access for compliance verification
   */
  AUDITOR: [
    EINVOICE_PERMISSIONS.ARCHIVE_VIEW,
    EINVOICE_PERMISSIONS.ARCHIVE_LIST,
    EINVOICE_PERMISSIONS.ARCHIVE_SEARCH,
    EINVOICE_PERMISSIONS.ARCHIVE_DOWNLOAD,
    EINVOICE_PERMISSIONS.VERIFY_INTEGRITY,
    EINVOICE_PERMISSIONS.VERIFY_RETENTION,
    EINVOICE_PERMISSIONS.REPORT_VIEW,
  ],
} as const;

export type EInvoiceRoleBundle = keyof typeof EINVOICE_ROLE_BUNDLES;

/**
 * Permission groups for UI display
 */
export const EINVOICE_PERMISSION_GROUPS = {
  'E-Invoice Generation': [
    EINVOICE_PERMISSIONS.GENERATE_VIEW,
    EINVOICE_PERMISSIONS.GENERATE_CREATE,
    EINVOICE_PERMISSIONS.GENERATE_BATCH,
    EINVOICE_PERMISSIONS.GENERATE_CREDIT_NOTE,
  ],
  'E-Invoice Archives': [
    EINVOICE_PERMISSIONS.ARCHIVE_VIEW,
    EINVOICE_PERMISSIONS.ARCHIVE_DOWNLOAD,
    EINVOICE_PERMISSIONS.ARCHIVE_LIST,
    EINVOICE_PERMISSIONS.ARCHIVE_SEARCH,
  ],
  'Verification': [
    EINVOICE_PERMISSIONS.VERIFY_INTEGRITY,
    EINVOICE_PERMISSIONS.VERIFY_RETENTION,
  ],
  'ASP Submission': [
    EINVOICE_PERMISSIONS.SUBMIT_INITIATE,
    EINVOICE_PERMISSIONS.SUBMIT_VIEW,
    EINVOICE_PERMISSIONS.SUBMIT_RETRY,
    EINVOICE_PERMISSIONS.SUBMIT_CANCEL,
  ],
  'Configuration': [
    EINVOICE_PERMISSIONS.CONFIG_VIEW,
    EINVOICE_PERMISSIONS.CONFIG_EDIT,
    EINVOICE_PERMISSIONS.CONFIG_ASP,
  ],
  'Reporting': [
    EINVOICE_PERMISSIONS.REPORT_VIEW,
    EINVOICE_PERMISSIONS.REPORT_EXPORT,
    EINVOICE_PERMISSIONS.REPORT_STATISTICS,
  ],
  'Administration': [
    EINVOICE_PERMISSIONS.ADMIN_FULL,
  ],
};

/**
 * Permission descriptions for documentation
 */
export const EINVOICE_PERMISSION_DESCRIPTIONS: Record<EInvoicePermission, string> = {
  'einvoice:generate:view': 'View e-invoice generation interface',
  'einvoice:generate:create': 'Generate new e-invoices from tax invoices',
  'einvoice:generate:batch': 'Generate multiple e-invoices in batch',
  'einvoice:generate:credit': 'Generate e-invoice credit notes',
  'einvoice:archive:view': 'View archived e-invoice details',
  'einvoice:archive:download': 'Download e-invoice XML and QR code',
  'einvoice:archive:list': 'List e-invoice archives',
  'einvoice:archive:search': 'Search e-invoice archives',
  'einvoice:verify:integrity': 'Verify e-invoice archive hash chain integrity',
  'einvoice:verify:retention': 'Check e-invoice retention status',
  'einvoice:submit:initiate': 'Initiate e-invoice submission to ASP',
  'einvoice:submit:view': 'View e-invoice submission status',
  'einvoice:submit:retry': 'Retry failed e-invoice submissions',
  'einvoice:submit:cancel': 'Cancel pending e-invoice submissions',
  'einvoice:config:view': 'View e-invoice configuration',
  'einvoice:config:edit': 'Edit e-invoice settings',
  'einvoice:config:asp': 'Configure ASP integration settings',
  'einvoice:report:view': 'View e-invoice reports',
  'einvoice:report:export': 'Export e-invoice reports',
  'einvoice:report:statistics': 'View e-invoice statistics',
  'einvoice:admin:full': 'Full administrative access to e-invoice system',
};
```
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compilation.</verify>
  <done>Permission constants and role bundles created with 21 permission codes and 4 role bundles.</done>
</task>

<task type="auto">
  <name>Task 2: Create E-Invoice Permission Middleware</name>
  <files>backend/src/middleware/einvoice-permissions.middleware.ts</files>
  <action>
Create permission middleware following CT patterns:

```typescript
/**
 * E-Invoice Permission Middleware
 * Phase: 06-e-invoicing-engine-core
 *
 * Provides permission checks for e-invoice operations.
 * Follows existing patterns from ct-permissions.middleware.ts
 */

import { Request, Response, NextFunction } from 'express';
import { PrismaClient } from '@prisma/client';
import {
  EINVOICE_PERMISSIONS,
  EInvoicePermission,
  EINVOICE_ROLE_BUNDLES,
  EInvoiceRoleBundle,
} from '../types/einvoice-permissions';
import logger from '../services/logger.service';

// Assume AuthRequest is defined in express types
interface AuthRequest extends Request {
  user?: {
    id: string;
    email: string;
    companyId: string;
    permissions?: string[];
  };
}

const prisma = new PrismaClient();

/**
 * Gets user's effective e-invoice permissions
 */
async function getUserEInvoicePermissions(userId: string): Promise<string[]> {
  try {
    const userWithRoles = await prisma.users.findUnique({
      where: { id: userId },
      include: {
        userRoles: {
          include: {
            role: {
              include: {
                rolePermissions: {
                  include: {
                    permission: true,
                  },
                },
              },
            },
          },
        },
      },
    });

    if (!userWithRoles) {
      return [];
    }

    const permissions = new Set<string>();

    for (const userRole of userWithRoles.userRoles || []) {
      for (const rolePermission of userRole.role?.rolePermissions || []) {
        if (rolePermission.permission?.code) {
          permissions.add(rolePermission.permission.code);
        }
      }
    }

    return Array.from(permissions);
  } catch (error) {
    logger.error('[EInvoicePermissions] Failed to get user permissions', {
      userId,
      error: error instanceof Error ? error.message : 'Unknown error',
    });
    return [];
  }
}

/**
 * Checks if user has specific e-invoice permission
 */
function hasEInvoicePermission(
  userPermissions: string[],
  requiredPermission: EInvoicePermission
): boolean {
  // Check for exact permission
  if (userPermissions.includes(requiredPermission)) {
    return true;
  }

  // Check for admin permission (grants all)
  if (userPermissions.includes(EINVOICE_PERMISSIONS.ADMIN_FULL)) {
    return true;
  }

  return false;
}

/**
 * Middleware: Require specific e-invoice permission
 *
 * @param permission - Required permission code
 *
 * @example
 * router.post('/einvoices/generate',
 *   authenticateJWT,
 *   requireEInvoicePermission(EINVOICE_PERMISSIONS.GENERATE_CREATE),
 *   controller.generateEInvoice
 * );
 */
export function requireEInvoicePermission(permission: EInvoicePermission) {
  return async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const userId = req.user?.id;
      const companyId = req.user?.companyId;

      if (!userId || !companyId) {
        logger.warn('[EInvoicePermissions] No user context', {
          hasUser: !!userId,
          hasCompany: !!companyId,
        });
        return res.status(401).json({
          success: false,
          message: 'Authentication required',
        });
      }

      // Get user's permissions
      const userPermissions = await getUserEInvoicePermissions(userId);

      // Check permission
      if (!hasEInvoicePermission(userPermissions, permission)) {
        logger.warn('[EInvoicePermissions] Access denied', {
          userId,
          companyId,
          requiredPermission: permission,
          userPermissions: userPermissions.filter(p => p.startsWith('einvoice:')),
        });

        // Log denial to audit
        await prisma.auditLogs.create({
          data: {
            id: require('crypto').randomUUID(),
            userId,
            action: 'ACCESS_DENIED',
            entity: 'EInvoice',
            entityId: 'permission_check',
            newValue: {
              requiredPermission: permission,
              path: req.path,
              method: req.method,
            },
            companyId,
            createdAt: new Date(),
          },
        });

        return res.status(403).json({
          success: false,
          message: 'Insufficient permissions for this e-invoice operation',
          requiredPermission: permission,
        });
      }

      // Permission granted
      logger.debug('[EInvoicePermissions] Access granted', {
        userId,
        permission,
      });

      next();
    } catch (error) {
      logger.error('[EInvoicePermissions] Permission check failed', {
        error: error instanceof Error ? error.message : 'Unknown error',
      });
      return res.status(500).json({
        success: false,
        message: 'Permission check failed',
      });
    }
  };
}

/**
 * Middleware: Require any of the specified permissions
 *
 * @param permissions - Array of acceptable permissions
 */
export function requireAnyEInvoicePermission(permissions: EInvoicePermission[]) {
  return async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const userId = req.user?.id;
      const companyId = req.user?.companyId;

      if (!userId || !companyId) {
        return res.status(401).json({
          success: false,
          message: 'Authentication required',
        });
      }

      const userPermissions = await getUserEInvoicePermissions(userId);

      // Check if user has ANY of the required permissions
      const hasAny = permissions.some(p => hasEInvoicePermission(userPermissions, p));

      if (!hasAny) {
        logger.warn('[EInvoicePermissions] Access denied (any)', {
          userId,
          requiredPermissions: permissions,
        });

        return res.status(403).json({
          success: false,
          message: 'Insufficient permissions',
          requiredPermissions: permissions,
        });
      }

      next();
    } catch (error) {
      logger.error('[EInvoicePermissions] Permission check failed', {
        error: error instanceof Error ? error.message : 'Unknown error',
      });
      return res.status(500).json({
        success: false,
        message: 'Permission check failed',
      });
    }
  };
}

/**
 * Middleware: Require all specified permissions
 *
 * @param permissions - Array of required permissions (all must be present)
 */
export function requireAllEInvoicePermissions(permissions: EInvoicePermission[]) {
  return async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const userId = req.user?.id;
      const companyId = req.user?.companyId;

      if (!userId || !companyId) {
        return res.status(401).json({
          success: false,
          message: 'Authentication required',
        });
      }

      const userPermissions = await getUserEInvoicePermissions(userId);

      // Check if user has ALL of the required permissions
      const missingPermissions = permissions.filter(
        p => !hasEInvoicePermission(userPermissions, p)
      );

      if (missingPermissions.length > 0) {
        logger.warn('[EInvoicePermissions] Access denied (all)', {
          userId,
          missingPermissions,
        });

        return res.status(403).json({
          success: false,
          message: 'Insufficient permissions',
          missingPermissions,
        });
      }

      next();
    } catch (error) {
      logger.error('[EInvoicePermissions] Permission check failed', {
        error: error instanceof Error ? error.message : 'Unknown error',
      });
      return res.status(500).json({
        success: false,
        message: 'Permission check failed',
      });
    }
  };
}

/**
 * Middleware: Validate company access for e-invoice
 * Ensures user can only access e-invoices from their company
 */
export function validateCompanyAccess() {
  return async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const userCompanyId = req.user?.companyId;
      const requestedCompanyId = req.params.companyId || req.query.companyId || req.body?.companyId;

      if (requestedCompanyId && requestedCompanyId !== userCompanyId) {
        logger.warn('[EInvoicePermissions] Cross-company access attempt', {
          userId: req.user?.id,
          userCompanyId,
          requestedCompanyId,
        });

        return res.status(403).json({
          success: false,
          message: 'Cannot access e-invoices from other companies',
        });
      }

      next();
    } catch (error) {
      return res.status(500).json({
        success: false,
        message: 'Company validation failed',
      });
    }
  };
}

/**
 * Gets role bundle permissions for a specific role
 */
export function getRoleBundlePermissions(bundle: EInvoiceRoleBundle): EInvoicePermission[] {
  return [...EINVOICE_ROLE_BUNDLES[bundle]];
}

export {
  EINVOICE_PERMISSIONS,
  EINVOICE_ROLE_BUNDLES,
};
```
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compilation.</verify>
  <done>Permission middleware created with requireEInvoicePermission(), requireAnyEInvoicePermission(), requireAllEInvoicePermissions(), and validateCompanyAccess().</done>
</task>

</tasks>

<verification>
1. Permission codes: 21 codes following einvoice:action:scope pattern
2. Role bundles: 4 bundles (Accountant, Finance Manager, CFO, Auditor)
3. Middleware: Validates permissions before operations with audit logging
4. TypeScript compiles without errors
</verification>

<success_criteria>
1. Permission codes follow einvoice:action:scope pattern
2. 4 role bundles with appropriate permission sets
3. Permission middleware validates access with audit logging
4. TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/06-e-invoicing-engine-core/06-07-SUMMARY.md`
</output>
