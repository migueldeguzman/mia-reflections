---
phase: 06-e-invoicing-engine-core
plan: 07
type: execute
wave: 4
depends_on: [06-06]
files_modified:
  - backend/src/services/einvoice/__tests__/einvoice-integration.test.ts
  - backend/src/types/einvoice-permissions.ts
  - backend/src/middleware/einvoice-permissions.middleware.ts
  - backend/prisma/seeds/einvoice-permissions.seed.ts
autonomous: true

must_haves:
  truths:
    - "Integration tests verify complete e-invoice generation workflow"
    - "Permission codes follow existing pattern (einvoice:action:scope)"
    - "Role bundles defined for e-invoice operations"
    - "Permission middleware validates access before e-invoice operations"
    - "Seed script creates e-invoice permissions idempotently"
  artifacts:
    - path: "backend/src/services/einvoice/__tests__/einvoice-integration.test.ts"
      provides: "Integration tests for e-invoice lifecycle"
      min_lines: 300
    - path: "backend/src/types/einvoice-permissions.ts"
      provides: "Permission constants and role bundles"
      exports: ["EINVOICE_PERMISSIONS", "EINVOICE_ROLE_BUNDLES"]
    - path: "backend/src/middleware/einvoice-permissions.middleware.ts"
      provides: "E-invoice permission middleware"
      exports: ["requireEInvoicePermission"]
  key_links:
    - from: "einvoice-permissions.middleware.ts"
      to: "einvoice-permissions.ts"
      via: "Uses EINVOICE_PERMISSIONS constant"
      pattern: "EINVOICE_PERMISSIONS"
---

<objective>
Create integration tests and permission middleware for e-invoice operations.

Purpose: EINV-01 through EINV-05 require comprehensive testing and proper access control. Integration tests verify the complete workflow from tax invoice to archived e-invoice. Permissions ensure only authorized users can generate and manage e-invoices.

Output:
- Integration tests covering e-invoice lifecycle
- Permission constants following CT/VAT patterns
- Role bundles (Accountant, Finance Manager, CFO, Auditor)
- Permission middleware for e-invoice routes
- Idempotent seed script
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-e-invoicing-engine-core/06-RESEARCH.md

# E-invoice service from 06-06
@backend/src/services/einvoice/einvoice.service.ts

# Existing permission patterns
@backend/src/types/ct-permissions.ts
@backend/src/middleware/ct-permissions.middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create E-Invoice Permission Types</name>
  <files>backend/src/types/einvoice-permissions.ts</files>
  <action>
Create permission constants and role bundles following CT/VAT patterns:

```typescript
/**
 * E-Invoice Permission Types
 * Phase: 06-e-invoicing-engine-core
 * Requirements: EINV-01 through EINV-06
 *
 * Defines permission codes and role bundles for e-invoice operations.
 * Follows established patterns from CT and VAT permissions.
 */

/**
 * E-Invoice permission codes
 *
 * Format: einvoice:{resource}:{action}
 *
 * Resources:
 * - generate: E-invoice generation
 * - archive: Archive management
 * - submit: ASP submission (Phase 7)
 * - verify: Integrity verification
 * - config: E-invoice configuration
 */
export const EINVOICE_PERMISSIONS = {
  // Generation permissions
  GENERATE_VIEW: 'einvoice:generate:view',           // View generation form
  GENERATE_CREATE: 'einvoice:generate:create',       // Generate e-invoices
  GENERATE_BATCH: 'einvoice:generate:batch',         // Batch generation
  GENERATE_CREDIT_NOTE: 'einvoice:generate:credit',  // Generate credit notes

  // Archive permissions
  ARCHIVE_VIEW: 'einvoice:archive:view',             // View archived e-invoices
  ARCHIVE_DOWNLOAD: 'einvoice:archive:download',     // Download XML/QR
  ARCHIVE_LIST: 'einvoice:archive:list',             // List archives
  ARCHIVE_SEARCH: 'einvoice:archive:search',         // Search archives

  // Verification permissions
  VERIFY_INTEGRITY: 'einvoice:verify:integrity',     // Verify hash chain
  VERIFY_RETENTION: 'einvoice:verify:retention',     // Check retention status

  // Submission permissions (Phase 7 preparation)
  SUBMIT_INITIATE: 'einvoice:submit:initiate',       // Initiate ASP submission
  SUBMIT_VIEW: 'einvoice:submit:view',               // View submission status
  SUBMIT_RETRY: 'einvoice:submit:retry',             // Retry failed submissions
  SUBMIT_CANCEL: 'einvoice:submit:cancel',           // Cancel pending submissions

  // Configuration permissions
  CONFIG_VIEW: 'einvoice:config:view',               // View e-invoice config
  CONFIG_EDIT: 'einvoice:config:edit',               // Edit e-invoice settings
  CONFIG_ASP: 'einvoice:config:asp',                 // Configure ASP integration

  // Reporting permissions
  REPORT_VIEW: 'einvoice:report:view',               // View e-invoice reports
  REPORT_EXPORT: 'einvoice:report:export',           // Export reports
  REPORT_STATISTICS: 'einvoice:report:statistics',   // View statistics

  // Admin permissions
  ADMIN_FULL: 'einvoice:admin:full',                 // Full admin access
} as const;

export type EInvoicePermission = typeof EINVOICE_PERMISSIONS[keyof typeof EINVOICE_PERMISSIONS];

/**
 * All e-invoice permission codes as array
 */
export const ALL_EINVOICE_PERMISSIONS = Object.values(EINVOICE_PERMISSIONS);

/**
 * Role bundles for e-invoice operations
 *
 * Following separation of duties principle:
 * - Accountant: Generate and view
 * - Finance Manager: Generate, view, submit
 * - CFO: All operations including config
 * - Auditor: View and verify only
 */
export const EINVOICE_ROLE_BUNDLES = {
  /**
   * ACCOUNTANT role bundle
   * Can generate e-invoices and view archives
   */
  ACCOUNTANT: [
    EINVOICE_PERMISSIONS.GENERATE_VIEW,
    EINVOICE_PERMISSIONS.GENERATE_CREATE,
    EINVOICE_PERMISSIONS.GENERATE_CREDIT_NOTE,
    EINVOICE_PERMISSIONS.ARCHIVE_VIEW,
    EINVOICE_PERMISSIONS.ARCHIVE_DOWNLOAD,
    EINVOICE_PERMISSIONS.ARCHIVE_LIST,
    EINVOICE_PERMISSIONS.ARCHIVE_SEARCH,
    EINVOICE_PERMISSIONS.REPORT_VIEW,
  ],

  /**
   * FINANCE_MANAGER role bundle
   * Can generate, submit, and manage e-invoices
   */
  FINANCE_MANAGER: [
    EINVOICE_PERMISSIONS.GENERATE_VIEW,
    EINVOICE_PERMISSIONS.GENERATE_CREATE,
    EINVOICE_PERMISSIONS.GENERATE_BATCH,
    EINVOICE_PERMISSIONS.GENERATE_CREDIT_NOTE,
    EINVOICE_PERMISSIONS.ARCHIVE_VIEW,
    EINVOICE_PERMISSIONS.ARCHIVE_DOWNLOAD,
    EINVOICE_PERMISSIONS.ARCHIVE_LIST,
    EINVOICE_PERMISSIONS.ARCHIVE_SEARCH,
    EINVOICE_PERMISSIONS.VERIFY_INTEGRITY,
    EINVOICE_PERMISSIONS.VERIFY_RETENTION,
    EINVOICE_PERMISSIONS.SUBMIT_INITIATE,
    EINVOICE_PERMISSIONS.SUBMIT_VIEW,
    EINVOICE_PERMISSIONS.SUBMIT_RETRY,
    EINVOICE_PERMISSIONS.REPORT_VIEW,
    EINVOICE_PERMISSIONS.REPORT_EXPORT,
    EINVOICE_PERMISSIONS.REPORT_STATISTICS,
  ],

  /**
   * CFO role bundle
   * Full access to all e-invoice operations
   */
  CFO: [
    ...Object.values(EINVOICE_PERMISSIONS),
  ],

  /**
   * AUDITOR role bundle
   * Read-only access for compliance verification
   */
  AUDITOR: [
    EINVOICE_PERMISSIONS.ARCHIVE_VIEW,
    EINVOICE_PERMISSIONS.ARCHIVE_LIST,
    EINVOICE_PERMISSIONS.ARCHIVE_SEARCH,
    EINVOICE_PERMISSIONS.ARCHIVE_DOWNLOAD,
    EINVOICE_PERMISSIONS.VERIFY_INTEGRITY,
    EINVOICE_PERMISSIONS.VERIFY_RETENTION,
    EINVOICE_PERMISSIONS.REPORT_VIEW,
  ],
} as const;

export type EInvoiceRoleBundle = keyof typeof EINVOICE_ROLE_BUNDLES;

/**
 * Permission groups for UI display
 */
export const EINVOICE_PERMISSION_GROUPS = {
  'E-Invoice Generation': [
    EINVOICE_PERMISSIONS.GENERATE_VIEW,
    EINVOICE_PERMISSIONS.GENERATE_CREATE,
    EINVOICE_PERMISSIONS.GENERATE_BATCH,
    EINVOICE_PERMISSIONS.GENERATE_CREDIT_NOTE,
  ],
  'E-Invoice Archives': [
    EINVOICE_PERMISSIONS.ARCHIVE_VIEW,
    EINVOICE_PERMISSIONS.ARCHIVE_DOWNLOAD,
    EINVOICE_PERMISSIONS.ARCHIVE_LIST,
    EINVOICE_PERMISSIONS.ARCHIVE_SEARCH,
  ],
  'Verification': [
    EINVOICE_PERMISSIONS.VERIFY_INTEGRITY,
    EINVOICE_PERMISSIONS.VERIFY_RETENTION,
  ],
  'ASP Submission': [
    EINVOICE_PERMISSIONS.SUBMIT_INITIATE,
    EINVOICE_PERMISSIONS.SUBMIT_VIEW,
    EINVOICE_PERMISSIONS.SUBMIT_RETRY,
    EINVOICE_PERMISSIONS.SUBMIT_CANCEL,
  ],
  'Configuration': [
    EINVOICE_PERMISSIONS.CONFIG_VIEW,
    EINVOICE_PERMISSIONS.CONFIG_EDIT,
    EINVOICE_PERMISSIONS.CONFIG_ASP,
  ],
  'Reporting': [
    EINVOICE_PERMISSIONS.REPORT_VIEW,
    EINVOICE_PERMISSIONS.REPORT_EXPORT,
    EINVOICE_PERMISSIONS.REPORT_STATISTICS,
  ],
  'Administration': [
    EINVOICE_PERMISSIONS.ADMIN_FULL,
  ],
};

/**
 * Permission descriptions for documentation
 */
export const EINVOICE_PERMISSION_DESCRIPTIONS: Record<EInvoicePermission, string> = {
  'einvoice:generate:view': 'View e-invoice generation interface',
  'einvoice:generate:create': 'Generate new e-invoices from tax invoices',
  'einvoice:generate:batch': 'Generate multiple e-invoices in batch',
  'einvoice:generate:credit': 'Generate e-invoice credit notes',
  'einvoice:archive:view': 'View archived e-invoice details',
  'einvoice:archive:download': 'Download e-invoice XML and QR code',
  'einvoice:archive:list': 'List e-invoice archives',
  'einvoice:archive:search': 'Search e-invoice archives',
  'einvoice:verify:integrity': 'Verify e-invoice archive hash chain integrity',
  'einvoice:verify:retention': 'Check e-invoice retention status',
  'einvoice:submit:initiate': 'Initiate e-invoice submission to ASP',
  'einvoice:submit:view': 'View e-invoice submission status',
  'einvoice:submit:retry': 'Retry failed e-invoice submissions',
  'einvoice:submit:cancel': 'Cancel pending e-invoice submissions',
  'einvoice:config:view': 'View e-invoice configuration',
  'einvoice:config:edit': 'Edit e-invoice settings',
  'einvoice:config:asp': 'Configure ASP integration settings',
  'einvoice:report:view': 'View e-invoice reports',
  'einvoice:report:export': 'Export e-invoice reports',
  'einvoice:report:statistics': 'View e-invoice statistics',
  'einvoice:admin:full': 'Full administrative access to e-invoice system',
};
```
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compilation.</verify>
  <done>Permission constants and role bundles created with 21 permission codes and 4 role bundles.</done>
</task>

<task type="auto">
  <name>Task 2: Create E-Invoice Permission Middleware</name>
  <files>backend/src/middleware/einvoice-permissions.middleware.ts</files>
  <action>
Create permission middleware following CT patterns:

```typescript
/**
 * E-Invoice Permission Middleware
 * Phase: 06-e-invoicing-engine-core
 *
 * Provides permission checks for e-invoice operations.
 * Follows existing patterns from ct-permissions.middleware.ts
 */

import { Request, Response, NextFunction } from 'express';
import { PrismaClient } from '@prisma/client';
import {
  EINVOICE_PERMISSIONS,
  EInvoicePermission,
  EINVOICE_ROLE_BUNDLES,
  EInvoiceRoleBundle,
} from '../types/einvoice-permissions';
import logger from '../services/logger.service';

// Assume AuthRequest is defined in express types
interface AuthRequest extends Request {
  user?: {
    id: string;
    email: string;
    companyId: string;
    permissions?: string[];
  };
}

const prisma = new PrismaClient();

/**
 * Gets user's effective e-invoice permissions
 */
async function getUserEInvoicePermissions(userId: string): Promise<string[]> {
  try {
    const userWithRoles = await prisma.users.findUnique({
      where: { id: userId },
      include: {
        userRoles: {
          include: {
            role: {
              include: {
                rolePermissions: {
                  include: {
                    permission: true,
                  },
                },
              },
            },
          },
        },
      },
    });

    if (!userWithRoles) {
      return [];
    }

    const permissions = new Set<string>();

    for (const userRole of userWithRoles.userRoles || []) {
      for (const rolePermission of userRole.role?.rolePermissions || []) {
        if (rolePermission.permission?.code) {
          permissions.add(rolePermission.permission.code);
        }
      }
    }

    return Array.from(permissions);
  } catch (error) {
    logger.error('[EInvoicePermissions] Failed to get user permissions', {
      userId,
      error: error instanceof Error ? error.message : 'Unknown error',
    });
    return [];
  }
}

/**
 * Checks if user has specific e-invoice permission
 */
function hasEInvoicePermission(
  userPermissions: string[],
  requiredPermission: EInvoicePermission
): boolean {
  // Check for exact permission
  if (userPermissions.includes(requiredPermission)) {
    return true;
  }

  // Check for admin permission (grants all)
  if (userPermissions.includes(EINVOICE_PERMISSIONS.ADMIN_FULL)) {
    return true;
  }

  return false;
}

/**
 * Middleware: Require specific e-invoice permission
 *
 * @param permission - Required permission code
 *
 * @example
 * router.post('/einvoices/generate',
 *   authenticateJWT,
 *   requireEInvoicePermission(EINVOICE_PERMISSIONS.GENERATE_CREATE),
 *   controller.generateEInvoice
 * );
 */
export function requireEInvoicePermission(permission: EInvoicePermission) {
  return async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const userId = req.user?.id;
      const companyId = req.user?.companyId;

      if (!userId || !companyId) {
        logger.warn('[EInvoicePermissions] No user context', {
          hasUser: !!userId,
          hasCompany: !!companyId,
        });
        return res.status(401).json({
          success: false,
          message: 'Authentication required',
        });
      }

      // Get user's permissions
      const userPermissions = await getUserEInvoicePermissions(userId);

      // Check permission
      if (!hasEInvoicePermission(userPermissions, permission)) {
        logger.warn('[EInvoicePermissions] Access denied', {
          userId,
          companyId,
          requiredPermission: permission,
          userPermissions: userPermissions.filter(p => p.startsWith('einvoice:')),
        });

        // Log denial to audit
        await prisma.auditLogs.create({
          data: {
            id: require('crypto').randomUUID(),
            userId,
            action: 'ACCESS_DENIED',
            entity: 'EInvoice',
            entityId: 'permission_check',
            newValue: {
              requiredPermission: permission,
              path: req.path,
              method: req.method,
            },
            companyId,
            createdAt: new Date(),
          },
        });

        return res.status(403).json({
          success: false,
          message: 'Insufficient permissions for this e-invoice operation',
          requiredPermission: permission,
        });
      }

      // Permission granted
      logger.debug('[EInvoicePermissions] Access granted', {
        userId,
        permission,
      });

      next();
    } catch (error) {
      logger.error('[EInvoicePermissions] Permission check failed', {
        error: error instanceof Error ? error.message : 'Unknown error',
      });
      return res.status(500).json({
        success: false,
        message: 'Permission check failed',
      });
    }
  };
}

/**
 * Middleware: Require any of the specified permissions
 *
 * @param permissions - Array of acceptable permissions
 */
export function requireAnyEInvoicePermission(permissions: EInvoicePermission[]) {
  return async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const userId = req.user?.id;
      const companyId = req.user?.companyId;

      if (!userId || !companyId) {
        return res.status(401).json({
          success: false,
          message: 'Authentication required',
        });
      }

      const userPermissions = await getUserEInvoicePermissions(userId);

      // Check if user has ANY of the required permissions
      const hasAny = permissions.some(p => hasEInvoicePermission(userPermissions, p));

      if (!hasAny) {
        logger.warn('[EInvoicePermissions] Access denied (any)', {
          userId,
          requiredPermissions: permissions,
        });

        return res.status(403).json({
          success: false,
          message: 'Insufficient permissions',
          requiredPermissions: permissions,
        });
      }

      next();
    } catch (error) {
      logger.error('[EInvoicePermissions] Permission check failed', {
        error: error instanceof Error ? error.message : 'Unknown error',
      });
      return res.status(500).json({
        success: false,
        message: 'Permission check failed',
      });
    }
  };
}

/**
 * Middleware: Require all specified permissions
 *
 * @param permissions - Array of required permissions (all must be present)
 */
export function requireAllEInvoicePermissions(permissions: EInvoicePermission[]) {
  return async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const userId = req.user?.id;
      const companyId = req.user?.companyId;

      if (!userId || !companyId) {
        return res.status(401).json({
          success: false,
          message: 'Authentication required',
        });
      }

      const userPermissions = await getUserEInvoicePermissions(userId);

      // Check if user has ALL of the required permissions
      const missingPermissions = permissions.filter(
        p => !hasEInvoicePermission(userPermissions, p)
      );

      if (missingPermissions.length > 0) {
        logger.warn('[EInvoicePermissions] Access denied (all)', {
          userId,
          missingPermissions,
        });

        return res.status(403).json({
          success: false,
          message: 'Insufficient permissions',
          missingPermissions,
        });
      }

      next();
    } catch (error) {
      logger.error('[EInvoicePermissions] Permission check failed', {
        error: error instanceof Error ? error.message : 'Unknown error',
      });
      return res.status(500).json({
        success: false,
        message: 'Permission check failed',
      });
    }
  };
}

/**
 * Middleware: Validate company access for e-invoice
 * Ensures user can only access e-invoices from their company
 */
export function validateCompanyAccess() {
  return async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const userCompanyId = req.user?.companyId;
      const requestedCompanyId = req.params.companyId || req.query.companyId || req.body?.companyId;

      if (requestedCompanyId && requestedCompanyId !== userCompanyId) {
        logger.warn('[EInvoicePermissions] Cross-company access attempt', {
          userId: req.user?.id,
          userCompanyId,
          requestedCompanyId,
        });

        return res.status(403).json({
          success: false,
          message: 'Cannot access e-invoices from other companies',
        });
      }

      next();
    } catch (error) {
      return res.status(500).json({
        success: false,
        message: 'Company validation failed',
      });
    }
  };
}

/**
 * Gets role bundle permissions for a specific role
 */
export function getRoleBundlePermissions(bundle: EInvoiceRoleBundle): EInvoicePermission[] {
  return [...EINVOICE_ROLE_BUNDLES[bundle]];
}

export {
  EINVOICE_PERMISSIONS,
  EINVOICE_ROLE_BUNDLES,
};
```
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compilation.</verify>
  <done>Permission middleware created with requireEInvoicePermission(), requireAnyEInvoicePermission(), requireAllEInvoicePermissions(), and validateCompanyAccess().</done>
</task>

<task type="auto">
  <name>Task 3: Create E-Invoice Integration Tests</name>
  <files>backend/src/services/einvoice/__tests__/einvoice-integration.test.ts</files>
  <action>
Create comprehensive integration tests:

```typescript
/**
 * E-Invoice Integration Tests
 * Phase: 06-e-invoicing-engine-core
 * Requirements: EINV-01 through EINV-05
 *
 * Tests the complete e-invoice generation workflow including:
 * - XML generation and validation
 * - QR code generation with TLV encoding
 * - Archive creation with hash chain
 * - Integrity verification
 * - Permission enforcement
 */

import { PintAeBuilderService } from '../pint-ae-builder.service';
import { UblValidatorService } from '../ubl-validator.service';
import { QrCodeService } from '../qr-code.service';
import { EInvoiceArchiveService } from '../einvoice-archive.service';
import { EInvoiceService } from '../einvoice.service';
import { decodeTlvFromBase64, validateTlvData } from '../../../utils/tlv-encoder.util';
import { TaxInvoiceData, PINT_AE_CONSTANTS } from '../../../types/einvoice.types';
import { createHash } from 'crypto';

describe('E-Invoice Integration Tests', () => {
  // Services
  let pintAeBuilder: PintAeBuilderService;
  let validator: UblValidatorService;
  let qrCodeService: QrCodeService;

  // Test data
  const createTestInvoice = (): TaxInvoiceData => ({
    invoiceId: 'test-inv-001',
    invoiceNumber: 'INV-2026-0001',
    companyId: 'test-company-001',
    invoiceDate: new Date('2026-01-24'),
    dueDate: new Date('2026-02-23'),
    supplierName: 'Vesla Motors LLC',
    supplierNameArabic: 'شركة فيسلا للسيارات',
    supplierTrn: '100123456789012',
    supplierAddress: 'Dubai Silicon Oasis, Building A1',
    supplierCity: 'Dubai',
    supplierCountry: 'AE',
    recipientName: 'ABC Trading Company',
    recipientNameArabic: 'شركة أ ب ج للتجارة',
    recipientTrn: '100987654321098',
    recipientAddress: 'Business Bay, Tower 5',
    recipientCity: 'Dubai',
    recipientCountry: 'AE',
    subtotal: 10000,
    vatAmount: 500,
    totalAmount: 10500,
    currency: 'AED',
    vatRate: 5,
    isReverseCharge: false,
    lineItems: [
      {
        lineNumber: 1,
        description: 'Toyota Camry Rental - 10 days',
        descriptionArabic: 'استئجار تويوتا كامري - 10 أيام',
        quantity: 10,
        unitCode: 'DAY',
        unitPrice: 500,
        lineTotal: 5000,
        vatRate: 5,
        vatAmount: 250,
      },
      {
        lineNumber: 2,
        description: 'Insurance Premium',
        quantity: 1,
        unitCode: 'EA',
        unitPrice: 5000,
        lineTotal: 5000,
        vatRate: 5,
        vatAmount: 250,
      },
    ],
    createdById: 'test-user-001',
    notes: 'Payment due within 30 days',
  });

  beforeAll(() => {
    pintAeBuilder = new PintAeBuilderService();
    validator = new UblValidatorService();
    qrCodeService = new QrCodeService();
  });

  describe('EINV-01: PINT AE XML Generation', () => {
    it('should generate valid PINT AE XML structure', () => {
      const invoice = createTestInvoice();
      const xml = pintAeBuilder.buildInvoiceXml(invoice);

      // Check XML declaration
      expect(xml).toContain('<?xml version="1.0" encoding="UTF-8"?>');

      // Check PINT AE CustomizationID
      expect(xml).toContain(PINT_AE_CONSTANTS.CUSTOMIZATION_ID);

      // Check ProfileID
      expect(xml).toContain(PINT_AE_CONSTANTS.PROFILE_ID);

      // Check mandatory currency
      expect(xml).toContain('<cbc:DocumentCurrencyCode>AED</cbc:DocumentCurrencyCode>');
    });

    it('should include all 13 FTA mandatory fields', () => {
      const invoice = createTestInvoice();
      const xml = pintAeBuilder.buildInvoiceXml(invoice);

      // IBT-001: Invoice number
      expect(xml).toContain(`<cbc:ID>${invoice.invoiceNumber}</cbc:ID>`);

      // IBT-002: Issue date
      expect(xml).toContain('<cbc:IssueDate>2026-01-24</cbc:IssueDate>');

      // IBT-003: Invoice type code
      expect(xml).toContain('<cbc:InvoiceTypeCode>380</cbc:InvoiceTypeCode>');

      // IBT-027: Seller name
      expect(xml).toContain(`<cbc:Name>${invoice.supplierName}</cbc:Name>`);

      // IBT-031: Seller TRN
      expect(xml).toContain(`<cbc:CompanyID>${invoice.supplierTrn}</cbc:CompanyID>`);

      // IBT-044: Buyer name
      expect(xml).toContain(invoice.recipientName);

      // Check tax totals
      expect(xml).toContain('<cbc:TaxAmount');
      expect(xml).toContain('500.00');

      // Check monetary totals
      expect(xml).toContain('<cbc:PayableAmount');
      expect(xml).toContain('10500.00');
    });

    it('should include all invoice line items', () => {
      const invoice = createTestInvoice();
      const xml = pintAeBuilder.buildInvoiceXml(invoice);

      // Check line count
      const lineMatches = xml.match(/<cac:InvoiceLine>/g);
      expect(lineMatches?.length).toBe(2);

      // Check line details
      expect(xml).toContain('Toyota Camry Rental');
      expect(xml).toContain('Insurance Premium');
    });
  });

  describe('EINV-02: UBL 2.1 Schema Compliance', () => {
    it('should validate correct PINT AE invoice', async () => {
      const invoice = createTestInvoice();
      const xml = pintAeBuilder.buildInvoiceXml(invoice);

      const result = await validator.validateInvoice(xml);

      expect(result.valid).toBe(true);
      expect(result.errors).toHaveLength(0);
    });

    it('should detect missing CustomizationID', async () => {
      const invoice = createTestInvoice();
      let xml = pintAeBuilder.buildInvoiceXml(invoice);
      xml = xml.replace(
        `<cbc:CustomizationID>${PINT_AE_CONSTANTS.CUSTOMIZATION_ID}</cbc:CustomizationID>`,
        '<cbc:CustomizationID>invalid</cbc:CustomizationID>'
      );

      const result = await validator.validateInvoice(xml);

      expect(result.valid).toBe(false);
      expect(result.errors.some(e => e.code === 'PINT-AE-001')).toBe(true);
    });

    it('should detect invalid currency', async () => {
      const invoice = createTestInvoice();
      let xml = pintAeBuilder.buildInvoiceXml(invoice);
      xml = xml.replace(
        '<cbc:DocumentCurrencyCode>AED</cbc:DocumentCurrencyCode>',
        '<cbc:DocumentCurrencyCode>USD</cbc:DocumentCurrencyCode>'
      );

      const result = await validator.validateInvoice(xml);

      expect(result.valid).toBe(false);
      expect(result.errors.some(e => e.code === 'PINT-AE-002')).toBe(true);
    });

    it('should detect invalid TRN format', async () => {
      const invoice = createTestInvoice();
      let xml = pintAeBuilder.buildInvoiceXml(invoice);
      xml = xml.replace(invoice.supplierTrn, '123456789');

      const result = await validator.validateInvoice(xml);

      expect(result.valid).toBe(false);
      expect(result.errors.some(e => e.code === 'PINT-AE-003')).toBe(true);
    });
  });

  describe('EINV-03: QR Code Generation', () => {
    it('should generate QR code with TLV encoding', async () => {
      const invoice = createTestInvoice();
      const xml = pintAeBuilder.buildInvoiceXml(invoice);
      const xmlHash = createHash('sha256').update(xml).digest('hex');

      const qrResult = await qrCodeService.generateQrCode({
        sellerName: invoice.supplierName,
        sellerTrn: invoice.supplierTrn,
        timestamp: invoice.invoiceDate,
        invoiceTotal: invoice.totalAmount.toFixed(2),
        vatTotal: invoice.vatAmount.toFixed(2),
        invoiceHash: xmlHash,
      });

      expect(qrResult.data).toBeTruthy();
      expect(qrResult.tlvBase64).toBeTruthy();
      expect(qrResult.contentSize).toBeGreaterThan(0);
    });

    it('should encode all 5 mandatory TLV fields', async () => {
      const invoice = createTestInvoice();

      const qrResult = await qrCodeService.generateQrCode({
        sellerName: invoice.supplierName,
        sellerTrn: invoice.supplierTrn,
        timestamp: invoice.invoiceDate,
        invoiceTotal: invoice.totalAmount.toFixed(2),
        vatTotal: invoice.vatAmount.toFixed(2),
      });

      // Decode and verify
      const decoded = decodeTlvFromBase64(qrResult.tlvBase64);
      const validation = validateTlvData(decoded);

      expect(validation.valid).toBe(true);
      expect(decoded.sellerName).toBe(invoice.supplierName);
      expect(decoded.sellerTrn).toBe(invoice.supplierTrn);
      expect(decoded.invoiceTotal).toBe('10500.00');
      expect(decoded.vatTotal).toBe('500.00');
    });

    it('should handle Arabic seller names', async () => {
      const invoice = createTestInvoice();
      invoice.supplierName = 'شركة فيسلا للسيارات ذ.م.م';

      const qrResult = await qrCodeService.generateQrCode({
        sellerName: invoice.supplierName,
        sellerTrn: invoice.supplierTrn,
        timestamp: invoice.invoiceDate,
        invoiceTotal: invoice.totalAmount.toFixed(2),
        vatTotal: invoice.vatAmount.toFixed(2),
      });

      const decoded = decodeTlvFromBase64(qrResult.tlvBase64);
      expect(decoded.sellerName).toBe('شركة فيسلا للسيارات ذ.م.م');
    });

    it('should generate scannable QR code formats', async () => {
      const invoice = createTestInvoice();

      // Test different formats
      const base64Result = await qrCodeService.generateQrCode(
        {
          sellerName: invoice.supplierName,
          sellerTrn: invoice.supplierTrn,
          timestamp: invoice.invoiceDate,
          invoiceTotal: invoice.totalAmount.toFixed(2),
          vatTotal: invoice.vatAmount.toFixed(2),
        },
        { format: 'base64' }
      );

      const dataUrlResult = await qrCodeService.generateQrCode(
        {
          sellerName: invoice.supplierName,
          sellerTrn: invoice.supplierTrn,
          timestamp: invoice.invoiceDate,
          invoiceTotal: invoice.totalAmount.toFixed(2),
          vatTotal: invoice.vatAmount.toFixed(2),
        },
        { format: 'dataUrl' }
      );

      expect(typeof base64Result.data).toBe('string');
      expect((dataUrlResult.data as string).startsWith('data:image/png;base64,')).toBe(true);
    });
  });

  describe('EINV-04: Schema Validation Before Transmission', () => {
    it('should block invalid invoices with specific error messages', async () => {
      // Create invalid XML (missing required element)
      const invalidXml = `<?xml version="1.0" encoding="UTF-8"?>
        <Invoice xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2">
          <cbc:CustomizationID>urn:peppol:pint:billing-1@ae-1.0.1</cbc:CustomizationID>
        </Invoice>`;

      const result = await validator.validateInvoice(invalidXml);

      expect(result.valid).toBe(false);
      expect(result.errors.length).toBeGreaterThan(0);
      expect(result.errors[0].code).toBeTruthy();
      expect(result.errors[0].message).toBeTruthy();
    });

    it('should provide element path in error details', async () => {
      const invoice = createTestInvoice();
      let xml = pintAeBuilder.buildInvoiceXml(invoice);
      xml = xml.replace(invoice.supplierTrn, '12345'); // Invalid TRN

      const result = await validator.validateInvoice(xml);

      expect(result.valid).toBe(false);
      const trnError = result.errors.find(e => e.code === 'PINT-AE-003');
      expect(trnError?.element).toContain('CompanyID');
    });
  });

  describe('EINV-05: E-Invoice Archiving', () => {
    it('should calculate correct XML hash', () => {
      const invoice = createTestInvoice();
      const xml = pintAeBuilder.buildInvoiceXml(invoice);

      const expectedHash = createHash('sha256').update(xml).digest('hex');

      // Hash should be consistent
      const hash1 = createHash('sha256').update(xml).digest('hex');
      const hash2 = createHash('sha256').update(xml).digest('hex');

      expect(hash1).toBe(expectedHash);
      expect(hash2).toBe(expectedHash);
    });

    it('should detect XML modification via hash mismatch', () => {
      const invoice = createTestInvoice();
      const xml = pintAeBuilder.buildInvoiceXml(invoice);
      const originalHash = createHash('sha256').update(xml).digest('hex');

      // Modify XML
      const modifiedXml = xml.replace('10500.00', '10000.00');
      const modifiedHash = createHash('sha256').update(modifiedXml).digest('hex');

      expect(modifiedHash).not.toBe(originalHash);
    });

    it('should support 7-year retention calculation', () => {
      const now = new Date();
      const retentionEndDate = new Date();
      retentionEndDate.setFullYear(retentionEndDate.getFullYear() + 7);

      expect(retentionEndDate.getFullYear()).toBe(now.getFullYear() + 7);
    });
  });

  describe('End-to-End E-Invoice Generation', () => {
    it('should complete full e-invoice generation workflow', async () => {
      const invoice = createTestInvoice();

      // Step 1: Generate XML
      const xml = pintAeBuilder.buildInvoiceXml(invoice);
      expect(xml).toContain('<?xml version="1.0"');

      // Step 2: Validate XML
      const validationResult = await validator.validateInvoice(xml);
      expect(validationResult.valid).toBe(true);

      // Step 3: Generate QR code
      const xmlHash = createHash('sha256').update(xml).digest('hex');
      const qrResult = await qrCodeService.generateQrCode({
        sellerName: invoice.supplierName,
        sellerTrn: invoice.supplierTrn,
        timestamp: invoice.invoiceDate,
        invoiceTotal: invoice.totalAmount.toFixed(2),
        vatTotal: invoice.vatAmount.toFixed(2),
        invoiceHash: xmlHash,
      });
      expect(qrResult.tlvBase64).toBeTruthy();

      // Step 4: Verify QR data
      const decoded = decodeTlvFromBase64(qrResult.tlvBase64);
      expect(decoded.invoiceHash).toBe(xmlHash);

      // Workflow complete
      console.log('E-invoice generation workflow completed successfully');
      console.log(`- Invoice: ${invoice.invoiceNumber}`);
      console.log(`- XML size: ${xml.length} bytes`);
      console.log(`- QR size: ${qrResult.contentSize} bytes`);
      console.log(`- Hash: ${xmlHash.substring(0, 16)}...`);
    });

    it('should handle credit note generation', async () => {
      const creditNote = createTestInvoice();
      creditNote.invoiceNumber = 'CN-2026-0001';
      creditNote.totalAmount = -1050; // Negative for credit

      const xml = pintAeBuilder.buildCreditNoteXml(creditNote, 'INV-2026-0001');

      expect(xml).toContain('<CreditNote');
      expect(xml).toContain('<cbc:CreditNoteTypeCode>381</cbc:CreditNoteTypeCode>');
      expect(xml).toContain('INV-2026-0001'); // Original invoice reference
    });
  });

  describe('Error Handling', () => {
    it('should handle missing required fields gracefully', async () => {
      const incompleteInvoice: Partial<TaxInvoiceData> = {
        invoiceNumber: 'TEST-001',
        // Missing most required fields
      };

      // Should not throw, but should fail validation
      expect(() => {
        pintAeBuilder.buildInvoiceXml(incompleteInvoice as TaxInvoiceData);
      }).not.toThrow();
    });

    it('should handle malformed XML in validation', async () => {
      const malformedXml = '<Invoice><NotClosed>';

      const result = await validator.validateInvoice(malformedXml);

      expect(result.valid).toBe(false);
      expect(result.errors[0].code).toBe('XML_MALFORMED');
    });
  });
});
```
  </action>
  <verify>Run `npm test -- --testPathPattern=einvoice-integration.test.ts` - all tests should pass.</verify>
  <done>Integration tests created covering EINV-01 through EINV-05 requirements with 20+ test cases.</done>
</task>

</tasks>

<verification>
1. Integration tests: Cover complete e-invoice lifecycle
2. Permission codes: 21 codes following pattern
3. Role bundles: 4 bundles (Accountant, Finance Manager, CFO, Auditor)
4. Middleware: Validates permissions before operations
5. Tests: All integration tests pass
</verification>

<success_criteria>
1. Integration tests verify XML generation, validation, QR code, and archival
2. Permission codes follow einvoice:action:scope pattern
3. 4 role bundles with appropriate permission sets
4. Permission middleware validates access with audit logging
5. All tests pass demonstrating EINV-01 through EINV-05 compliance
</success_criteria>

<output>
After completion, create `.planning/phases/06-e-invoicing-engine-core/06-07-SUMMARY.md`
</output>
