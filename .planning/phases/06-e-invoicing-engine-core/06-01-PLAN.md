---
phase: 06-e-invoicing-engine-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/prisma/schema.prisma
  - backend/src/types/einvoice.types.ts
  - backend/prisma/migrations/YYYYMMDDHHMMSS_einvoice_archive_schema/migration.sql
autonomous: true

must_haves:
  truths:
    - "E-invoice archives can store XML content with hash verification"
    - "Archive records have sequence numbers for tamper-proof chain"
    - "Retention end date is calculated 7 years from creation"
    - "E-invoice status tracks lifecycle from generation to acceptance"
    - "ASP submission details can be recorded when available"
  artifacts:
    - path: "backend/prisma/schema.prisma"
      provides: "EInvoiceArchive model with hash chain fields"
      contains: "model einvoice_archives"
    - path: "backend/src/types/einvoice.types.ts"
      provides: "TypeScript interfaces for e-invoice generation and validation"
      exports: ["EInvoiceData", "EInvoiceArchiveRecord", "EInvoiceValidationResult", "TlvQrInput"]
  key_links:
    - from: "einvoice.types.ts"
      to: "prisma/schema.prisma"
      via: "Type definitions matching schema enums"
      pattern: "EInvoiceStatus|EInvoiceFormat"
---

<objective>
Create the database schema and TypeScript types for e-invoice archival with tamper-proof storage.

Purpose: EINV-05 requires 7-year retention with integrity verification. This schema foundation provides the storage layer for all e-invoice operations, extending Phase 2's tamper-proof patterns for FTA compliance.

Output:
- einvoice_archives model with hash chain (sequence, previousHash, recordHash)
- EInvoiceStatus enum (GENERATED, VALIDATED, SUBMITTED, ACCEPTED, REJECTED)
- EInvoiceFormat enum (PINT_AE, UBL_21)
- TypeScript interfaces for e-invoice data flow
- Sequence for atomic numbering
- EINVOICE_GENERATE added to AuditAction enum (for audit trail)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-e-invoicing-engine-core/06-RESEARCH.md

# Existing tamper-proof patterns from Phase 2
@backend/src/types/compliance/audit.types.ts
@backend/src/services/compliance/compliance-audit.service.ts

# Existing schema patterns
@backend/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add E-Invoice Enums, AuditAction, and Archive Model to Schema</name>
  <files>backend/prisma/schema.prisma</files>
  <action>
Add the following e-invoice related enums and model to the schema file:

```prisma
// ============================================================================
// E-Invoice Enums (Phase 6)
// ============================================================================

enum EInvoiceStatus {
  GENERATED     // XML created, not yet validated
  VALIDATED     // Passed UBL 2.1 + PINT AE validation
  SUBMITTED     // Sent to ASP
  ACCEPTED      // ASP confirmed acceptance
  REJECTED      // ASP rejected (needs correction)
  CANCELLED     // E-invoice cancelled
  ARCHIVED      // Long-term archival state
}

enum EInvoiceFormat {
  PINT_AE       // PEPPOL PINT AE 1.0.1
  UBL_21        // UBL 2.1 base format
}

// ============================================================================
// E-Invoice Archive Model (Phase 6)
// ============================================================================

model einvoice_archives {
  id                    String          @id @default(uuid())
  companyId             String          @map("company_id")

  // Source invoice reference
  invoiceId             String          @map("invoice_id")
  einvoiceNumber        String          @unique @map("einvoice_number")

  // E-Invoice content
  format                EInvoiceFormat  @default(PINT_AE)
  xmlContent            String          @map("xml_content") @db.Text
  xmlHash               String          @map("xml_hash") @db.VarChar(64)  // SHA-256
  qrCodeData            String?         @map("qr_code_data") @db.Text     // Base64 TLV

  // Status tracking
  status                EInvoiceStatus  @default(GENERATED)

  // Validation results (stored as JSON)
  validationResult      Json?           @map("validation_result")
  validationErrors      Json?           @map("validation_errors")

  // ASP submission details (populated in Phase 7)
  aspSubmissionId       String?         @map("asp_submission_id")
  aspSubmissionDate     DateTime?       @map("asp_submission_date")
  aspResponseCode       String?         @map("asp_response_code")
  aspResponseMessage    String?         @map("asp_response_message")
  tddReference          String?         @map("tdd_reference")  // Tax Data Document
  mlsStatus             String?         @map("mls_status")     // Message Level Status

  // Tamper-proof chain (same pattern as Phase 2 audit_logs)
  sequenceNumber        Int             @unique @map("sequence_number")
  previousHash          String          @map("previous_hash") @db.VarChar(64)
  recordHash            String          @map("record_hash") @db.VarChar(64)

  // Retention management
  retentionEndDate      DateTime        @map("retention_end_date")
  isRetentionExpired    Boolean         @default(false) @map("is_retention_expired")

  // Timestamps
  createdAt             DateTime        @default(now()) @map("created_at")
  updatedAt             DateTime        @updatedAt @map("updated_at")

  // Relations
  company               companies       @relation(fields: [companyId], references: [id])

  // Indexes
  @@index([companyId, createdAt])
  @@index([companyId, status])
  @@index([invoiceId])
  @@index([retentionEndDate])
  @@index([sequenceNumber])

  @@map("einvoice_archives")
}
```

Also add the relation to the companies model:
```prisma
// In companies model, add:
einvoiceArchives      einvoice_archives[]
```

**IMPORTANT:** Add EINVOICE_GENERATE to the AuditAction enum if not already present:
```prisma
// In AuditAction enum, add these if not present:
EINVOICE_GENERATE    // E-invoice generated (Phase 6)
EINVOICE_SUBMIT      // E-invoice submitted to ASP (Phase 7)
EINVOICE_CANCEL      // E-invoice cancelled
```

Create migration file for the sequence:
```sql
-- Create sequence for atomic e-invoice archive numbering
CREATE SEQUENCE IF NOT EXISTS einvoice_archive_seq START 1;

-- Create immutability trigger (same pattern as audit_logs)
CREATE OR REPLACE FUNCTION einvoice_archives_immutable()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'UPDATE' THEN
    -- Allow only status updates and ASP response fields
    IF OLD.xml_content <> NEW.xml_content
       OR OLD.xml_hash <> NEW.xml_hash
       OR OLD.sequence_number <> NEW.sequence_number
       OR OLD.previous_hash <> NEW.previous_hash
       OR OLD.record_hash <> NEW.record_hash THEN
      RAISE EXCEPTION 'E-invoice archive core fields are immutable';
    END IF;
  END IF;
  IF TG_OP = 'DELETE' THEN
    RAISE EXCEPTION 'E-invoice archives cannot be deleted';
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER einvoice_archives_immutable_trigger
  BEFORE UPDATE OR DELETE ON einvoice_archives
  FOR EACH ROW
  EXECUTE FUNCTION einvoice_archives_immutable();
```
  </action>
  <verify>Run `npx prisma validate` - should pass with no errors. Run `npx prisma format` to ensure schema formatting.</verify>
  <done>Schema includes einvoice_archives model with hash chain fields, EInvoiceStatus and EInvoiceFormat enums defined, EINVOICE_GENERATE added to AuditAction enum, migration SQL prepared for sequence and immutability trigger.</done>
</task>

<task type="auto">
  <name>Task 2: Create E-Invoice TypeScript Types</name>
  <files>backend/src/types/einvoice.types.ts</files>
  <action>
Create TypeScript interfaces for e-invoice operations:

```typescript
/**
 * E-Invoice Types
 * Phase: 06-e-invoicing-engine-core
 * Requirements: EINV-01 through EINV-06
 *
 * Types for PEPPOL PINT-AE e-invoice generation, validation, and archival.
 */

/**
 * E-invoice status enum (mirrors Prisma)
 */
export type EInvoiceStatus =
  | 'GENERATED'
  | 'VALIDATED'
  | 'SUBMITTED'
  | 'ACCEPTED'
  | 'REJECTED'
  | 'CANCELLED'
  | 'ARCHIVED';

/**
 * E-invoice format enum
 */
export type EInvoiceFormat = 'PINT_AE' | 'UBL_21';

/**
 * TLV QR code input data
 * Based on ZATCA TLV encoding adapted for UAE
 */
export interface TlvQrInput {
  sellerName: string;
  sellerTrn: string;
  timestamp: Date;
  invoiceTotal: string;  // Decimal string
  vatTotal: string;      // Decimal string
  invoiceHash?: string;  // SHA-256 of XML
}

/**
 * TLV Tag definitions for QR code encoding
 */
export enum TlvTag {
  SELLER_NAME = 1,
  SELLER_TRN = 2,
  INVOICE_TIMESTAMP = 3,
  INVOICE_TOTAL = 4,
  VAT_TOTAL = 5,
  INVOICE_HASH = 6,
  DIGITAL_SIGNATURE = 7,
  PUBLIC_KEY = 8,
}

/**
 * Decoded TLV data from QR code
 */
export interface DecodedTlvData {
  sellerName?: string;
  sellerTrn?: string;
  timestamp?: Date;
  invoiceTotal?: string;
  vatTotal?: string;
  invoiceHash?: string;
}

/**
 * Validation error structure
 */
export interface EInvoiceValidationError {
  code: string;
  message: string;
  line?: number;
  element?: string;
  severity: 'error' | 'warning';
}

/**
 * Validation result from UBL/PINT-AE validation
 */
export interface EInvoiceValidationResult {
  valid: boolean;
  errors: EInvoiceValidationError[];
  warnings: EInvoiceValidationError[];
  validatedAt: Date;
}

/**
 * E-invoice archive record (matches Prisma model)
 */
export interface EInvoiceArchiveRecord {
  id: string;
  companyId: string;
  invoiceId: string;
  einvoiceNumber: string;
  format: EInvoiceFormat;
  xmlContent: string;
  xmlHash: string;
  qrCodeData?: string;
  status: EInvoiceStatus;
  validationResult?: EInvoiceValidationResult;
  validationErrors?: EInvoiceValidationError[];
  aspSubmissionId?: string;
  aspSubmissionDate?: Date;
  aspResponseCode?: string;
  aspResponseMessage?: string;
  tddReference?: string;
  mlsStatus?: string;
  sequenceNumber: number;
  previousHash: string;
  recordHash: string;
  retentionEndDate: Date;
  isRetentionExpired: boolean;
  createdAt: Date;
  updatedAt: Date;
}

/**
 * E-invoice generation result
 */
export interface EInvoiceResult {
  success: boolean;
  errors: EInvoiceValidationError[];
  invoice: {
    id: string;
    einvoiceNumber: string;
    xml: string;
    qrCode: string;
    xmlHash: string;
    status: EInvoiceStatus;
  } | null;
}

/**
 * Source tax invoice data (from Phase 3)
 * This interface maps fields from Phase 3 VatInvoiceService
 */
export interface TaxInvoiceData {
  // Identifiers
  invoiceId: string;
  invoiceNumber: string;
  companyId: string;

  // Dates
  invoiceDate: Date;
  supplyDate?: Date;
  dueDate?: Date;

  // Supplier (Seller) - FTA mandatory fields
  supplierName: string;
  supplierNameArabic?: string;
  supplierTrn: string;
  supplierAddress: string;
  supplierCity?: string;
  supplierCountry: string;  // Default 'AE'

  // Recipient (Buyer)
  recipientName: string;
  recipientNameArabic?: string;
  recipientTrn?: string;
  recipientAddress: string;
  recipientCity?: string;
  recipientCountry?: string;

  // Amounts
  subtotal: number;
  vatAmount: number;
  totalAmount: number;
  currency: string;  // Default 'AED'

  // Foreign currency handling
  originalCurrency?: string;
  exchangeRate?: number;
  originalAmount?: number;

  // VAT specifics
  vatRate: number;  // e.g., 5 for 5%
  isReverseCharge: boolean;
  reverseChargeReason?: string;

  // Line items
  lineItems: TaxInvoiceLineItem[];

  // Metadata
  createdById: string;
  notes?: string;
}

/**
 * Tax invoice line item
 */
export interface TaxInvoiceLineItem {
  lineNumber: number;
  description: string;
  descriptionArabic?: string;
  quantity: number;
  unitCode: string;  // UN/CEFACT unit code (e.g., 'EA', 'HUR')
  unitPrice: number;
  lineTotal: number;
  vatRate: number;
  vatAmount: number;
  itemClassificationCode?: string;
}

/**
 * PINT AE Invoice type codes
 */
export enum PintAeInvoiceTypeCode {
  COMMERCIAL_INVOICE = '380',
  CREDIT_NOTE = '381',
  SELF_BILLING_INVOICE = '389',
  CORRECTED_INVOICE = '384',
}

/**
 * PINT AE document structure (UBL 2.1 based)
 */
export interface PintAeDocument {
  customizationId: string;  // 'urn:peppol:pint:billing-1@ae-1.0.1'
  profileId: string;        // 'urn:peppol:bis:billing'
  id: string;
  issueDate: string;        // YYYY-MM-DD
  invoiceTypeCode: PintAeInvoiceTypeCode;
  documentCurrencyCode: string;  // 'AED'
  taxCurrencyCode?: string;
  supplierParty: PintAeParty;
  buyerParty: PintAeParty;
  taxTotal: PintAeTaxTotal;
  legalMonetaryTotal: PintAeMonetaryTotal;
  invoiceLines: PintAeInvoiceLine[];
}

/**
 * PINT AE Party structure
 */
export interface PintAeParty {
  endpointId: string;
  endpointSchemeId: string;  // 'AEUAE'
  partyIdentificationId: string;
  partyIdentificationSchemeId: string;  // 'AEUAE-TRN'
  partyName: string;
  postalAddress: {
    streetName?: string;
    cityName?: string;
    countryCode: string;  // 'AE'
  };
  partyTaxScheme: {
    companyId: string;  // TRN
    taxSchemeId: string;  // 'VAT'
  };
  partyLegalEntity: {
    registrationName: string;
  };
}

/**
 * PINT AE Tax Total
 */
export interface PintAeTaxTotal {
  taxAmount: number;
  taxSubtotals: {
    taxableAmount: number;
    taxAmount: number;
    taxCategory: {
      id: string;  // 'S' for standard rate
      percent: number;
      taxSchemeId: string;  // 'VAT'
    };
  }[];
}

/**
 * PINT AE Monetary Total
 */
export interface PintAeMonetaryTotal {
  lineExtensionAmount: number;
  taxExclusiveAmount: number;
  taxInclusiveAmount: number;
  payableAmount: number;
}

/**
 * PINT AE Invoice Line
 */
export interface PintAeInvoiceLine {
  id: string;
  invoicedQuantity: number;
  invoicedQuantityUnitCode: string;
  lineExtensionAmount: number;
  item: {
    name: string;
    classifiedTaxCategory: {
      id: string;
      percent: number;
      taxSchemeId: string;
    };
  };
  price: {
    priceAmount: number;
  };
}

/**
 * Genesis hash constant for first record in chain
 */
export const EINVOICE_GENESIS_HASH = 'GENESIS';

/**
 * Hash algorithm for integrity verification
 */
export const EINVOICE_HASH_ALGORITHM = 'sha256';

/**
 * Default retention period in years (FTA requirement)
 */
export const EINVOICE_RETENTION_YEARS = 7;

/**
 * PINT AE specification constants
 */
export const PINT_AE_CONSTANTS = {
  CUSTOMIZATION_ID: 'urn:peppol:pint:billing-1@ae-1.0.1',
  PROFILE_ID: 'urn:peppol:bis:billing',
  DOCUMENT_CURRENCY: 'AED',
  COUNTRY_CODE: 'AE',
  TAX_SCHEME_ID: 'VAT',
  ENDPOINT_SCHEME: 'AEUAE',
  TRN_SCHEME: 'AEUAE-TRN',
  STANDARD_VAT_RATE: 5,
} as const;
```
  </action>
  <verify>Run `npx tsc --noEmit` - should compile with no type errors. Additionally verify constants export: `npx ts-node -e "import { PINT_AE_CONSTANTS } from './backend/src/types/einvoice.types'; console.log(PINT_AE_CONSTANTS.CUSTOMIZATION_ID)"`</verify>
  <done>TypeScript interfaces created for TlvQrInput, EInvoiceValidationResult, EInvoiceArchiveRecord, TaxInvoiceData, PintAeDocument structures. All PINT AE constants defined and verified as importable.</done>
</task>

</tasks>

<verification>
1. Schema validation: `npx prisma validate` passes
2. Type compilation: `npx tsc --noEmit` passes
3. Migration preview: `npx prisma migrate dev --create-only` creates migration file
4. Constants export: `npx ts-node -e "import { PINT_AE_CONSTANTS } from './backend/src/types/einvoice.types'; console.log(PINT_AE_CONSTANTS.CUSTOMIZATION_ID)"` outputs the customization ID
5. EINVOICE_GENERATE exists in AuditAction enum
</verification>

<success_criteria>
1. einvoice_archives model exists with all required fields (hash chain, status, retention)
2. EInvoiceStatus and EInvoiceFormat enums defined in schema
3. EINVOICE_GENERATE added to AuditAction enum for audit trail
4. TypeScript interfaces match schema structure
5. PINT_AE_CONSTANTS exported with correct specification values
6. TLV tag enum defined for QR code encoding
</success_criteria>

<output>
After completion, create `.planning/phases/06-e-invoicing-engine-core/06-01-SUMMARY.md`
</output>
