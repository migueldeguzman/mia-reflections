---
phase: 06-e-invoicing-engine-core
plan: 03
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - backend/src/services/einvoice/pint-ae-builder.service.ts
  - backend/src/services/einvoice/__tests__/pint-ae-builder.service.test.ts
autonomous: true

must_haves:
  truths:
    - "XML output includes correct UBL 2.1 namespace declarations"
    - "CustomizationID contains PINT AE specification identifier"
    - "DocumentCurrencyCode is always AED for UAE invoices"
    - "Supplier TRN uses AEUAE-TRN scheme identifier"
    - "Invoice line items are correctly numbered and calculated"
  artifacts:
    - path: "backend/src/services/einvoice/pint-ae-builder.service.ts"
      provides: "PINT AE XML builder service"
      exports: ["PintAeBuilderService"]
  key_links:
    - from: "pint-ae-builder.service.ts"
      to: "einvoice.types.ts"
      via: "Uses TaxInvoiceData interface"
      pattern: "TaxInvoiceData|PintAeDocument"
---

<objective>
Create the PINT AE XML builder service that transforms Phase 3 TaxInvoiceData into PEPPOL PINT-AE compliant UBL 2.1 XML.

Purpose: EINV-01 requires generating invoices in PINT AE format (XML structure). This service maps the 13 FTA-mandatory fields from TaxInvoiceData to the corresponding PINT AE XML elements with correct namespaces and structure.

Output:
- PintAeBuilderService with buildInvoiceXml() method
- Correct UBL 2.1 namespace handling
- Support for standard invoice (380) and credit note (381)
- Unit tests for XML structure validation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-e-invoicing-engine-core/06-RESEARCH.md

# Types from 06-01
@backend/src/types/einvoice.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PINT AE Builder Service</name>
  <files>backend/src/services/einvoice/pint-ae-builder.service.ts</files>
  <action>
Create the PINT AE XML builder service using fast-xml-parser:

```typescript
/**
 * PINT AE Builder Service
 * Phase: 06-e-invoicing-engine-core
 * Requirement: EINV-01 (PINT AE XML generation)
 *
 * Transforms TaxInvoiceData into PEPPOL PINT-AE compliant UBL 2.1 XML.
 * Reference: OpenPeppol PINT AE v1.0.1 specification
 */

import { XMLBuilder } from 'fast-xml-parser';
import { injectable } from 'inversify';
import {
  TaxInvoiceData,
  TaxInvoiceLineItem,
  PintAeInvoiceTypeCode,
  PINT_AE_CONSTANTS,
} from '../../types/einvoice.types';
import logger from '../logger.service';

/**
 * UBL 2.1 Namespace URIs
 */
const UBL_NAMESPACES = {
  INVOICE: 'urn:oasis:names:specification:ubl:schema:xsd:Invoice-2',
  CREDIT_NOTE: 'urn:oasis:names:specification:ubl:schema:xsd:CreditNote-2',
  CAC: 'urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2',
  CBC: 'urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2',
} as const;

/**
 * UN/CEFACT Unit Codes mapping
 */
const DEFAULT_UNIT_CODE = 'EA'; // Each

/**
 * Tax category codes
 */
const TAX_CATEGORIES = {
  STANDARD: 'S',      // Standard rate (5%)
  ZERO: 'Z',          // Zero rate
  EXEMPT: 'E',        // Exempt
  REVERSE_CHARGE: 'AE', // Reverse charge (VAT due by buyer)
} as const;

@injectable()
export class PintAeBuilderService {
  private readonly xmlBuilder: XMLBuilder;

  constructor() {
    this.xmlBuilder = new XMLBuilder({
      ignoreAttributes: false,
      attributeNamePrefix: '@_',
      format: true,
      indentBy: '  ',
      suppressEmptyNode: true,
      suppressBooleanAttributes: false,
    });
  }

  /**
   * Builds PINT AE compliant UBL 2.1 Invoice XML
   *
   * @param invoice - Source tax invoice data from Phase 3
   * @returns Complete XML string with declaration
   *
   * @example
   * const xml = pintAeBuilder.buildInvoiceXml(taxInvoice);
   * // Returns: <?xml version="1.0" encoding="UTF-8"?>
   * //          <Invoice xmlns="urn:oasis:names:...">...</Invoice>
   */
  buildInvoiceXml(invoice: TaxInvoiceData): string {
    logger.info('[PintAeBuilder] Building PINT AE invoice XML', {
      invoiceNumber: invoice.invoiceNumber,
      companyId: invoice.companyId,
    });

    const ublInvoice = this.buildInvoiceObject(invoice);
    const xmlBody = this.xmlBuilder.build(ublInvoice);

    return '<?xml version="1.0" encoding="UTF-8"?>\n' + xmlBody;
  }

  /**
   * Builds PINT AE compliant UBL 2.1 Credit Note XML
   *
   * @param creditNote - Source credit note data
   * @param originalInvoiceNumber - Reference to original invoice
   * @returns Complete XML string with declaration
   */
  buildCreditNoteXml(
    creditNote: TaxInvoiceData,
    originalInvoiceNumber: string
  ): string {
    logger.info('[PintAeBuilder] Building PINT AE credit note XML', {
      creditNoteNumber: creditNote.invoiceNumber,
      originalInvoice: originalInvoiceNumber,
    });

    const ublCreditNote = this.buildCreditNoteObject(creditNote, originalInvoiceNumber);
    const xmlBody = this.xmlBuilder.build(ublCreditNote);

    return '<?xml version="1.0" encoding="UTF-8"?>\n' + xmlBody;
  }

  /**
   * Builds the invoice object structure for XML builder
   */
  private buildInvoiceObject(invoice: TaxInvoiceData): object {
    return {
      Invoice: {
        '@_xmlns': UBL_NAMESPACES.INVOICE,
        '@_xmlns:cac': UBL_NAMESPACES.CAC,
        '@_xmlns:cbc': UBL_NAMESPACES.CBC,

        // IBT-024: Specification identifier (MANDATORY)
        'cbc:CustomizationID': PINT_AE_CONSTANTS.CUSTOMIZATION_ID,

        // IBT-023: Business process type
        'cbc:ProfileID': PINT_AE_CONSTANTS.PROFILE_ID,

        // IBT-001: Invoice number (MANDATORY)
        'cbc:ID': invoice.invoiceNumber,

        // IBT-002: Invoice issue date (MANDATORY)
        'cbc:IssueDate': this.formatDate(invoice.invoiceDate),

        // IBT-009: Due date (optional but recommended)
        ...(invoice.dueDate && {
          'cbc:DueDate': this.formatDate(invoice.dueDate),
        }),

        // IBT-003: Invoice type code (MANDATORY)
        'cbc:InvoiceTypeCode': this.getInvoiceTypeCode(invoice),

        // IBT-022: Notes (optional)
        ...(invoice.notes && {
          'cbc:Note': invoice.notes,
        }),

        // IBT-005: Invoice currency code (MANDATORY - must be AED for UAE)
        'cbc:DocumentCurrencyCode': PINT_AE_CONSTANTS.DOCUMENT_CURRENCY,

        // IBT-006: Tax currency code (if different from document currency)
        ...(invoice.originalCurrency &&
          invoice.originalCurrency !== PINT_AE_CONSTANTS.DOCUMENT_CURRENCY && {
            'cbc:TaxCurrencyCode': PINT_AE_CONSTANTS.DOCUMENT_CURRENCY,
          }),

        // IBG-04: Seller/Supplier (MANDATORY)
        'cac:AccountingSupplierParty': this.buildSupplierParty(invoice),

        // IBG-07: Buyer/Customer (MANDATORY)
        'cac:AccountingCustomerParty': this.buildBuyerParty(invoice),

        // IBG-22: Tax total (MANDATORY)
        'cac:TaxTotal': this.buildTaxTotal(invoice),

        // IBG-23: Document totals (MANDATORY)
        'cac:LegalMonetaryTotal': this.buildMonetaryTotal(invoice),

        // IBG-25: Invoice lines (MANDATORY - at least one)
        'cac:InvoiceLine': invoice.lineItems.map((item, index) =>
          this.buildInvoiceLine(item, index + 1)
        ),
      },
    };
  }

  /**
   * Builds credit note object structure
   */
  private buildCreditNoteObject(
    creditNote: TaxInvoiceData,
    originalInvoiceNumber: string
  ): object {
    return {
      CreditNote: {
        '@_xmlns': UBL_NAMESPACES.CREDIT_NOTE,
        '@_xmlns:cac': UBL_NAMESPACES.CAC,
        '@_xmlns:cbc': UBL_NAMESPACES.CBC,

        'cbc:CustomizationID': PINT_AE_CONSTANTS.CUSTOMIZATION_ID,
        'cbc:ProfileID': PINT_AE_CONSTANTS.PROFILE_ID,
        'cbc:ID': creditNote.invoiceNumber,
        'cbc:IssueDate': this.formatDate(creditNote.invoiceDate),
        'cbc:CreditNoteTypeCode': PintAeInvoiceTypeCode.CREDIT_NOTE,
        'cbc:DocumentCurrencyCode': PINT_AE_CONSTANTS.DOCUMENT_CURRENCY,

        // Reference to original invoice
        'cac:BillingReference': {
          'cac:InvoiceDocumentReference': {
            'cbc:ID': originalInvoiceNumber,
          },
        },

        'cac:AccountingSupplierParty': this.buildSupplierParty(creditNote),
        'cac:AccountingCustomerParty': this.buildBuyerParty(creditNote),
        'cac:TaxTotal': this.buildTaxTotal(creditNote),
        'cac:LegalMonetaryTotal': this.buildMonetaryTotal(creditNote),

        'cac:CreditNoteLine': creditNote.lineItems.map((item, index) =>
          this.buildCreditNoteLine(item, index + 1)
        ),
      },
    };
  }

  /**
   * Builds supplier/seller party (IBG-04)
   */
  private buildSupplierParty(invoice: TaxInvoiceData): object {
    return {
      'cac:Party': {
        // IBT-034: Seller electronic address
        'cbc:EndpointID': {
          '@_schemeID': PINT_AE_CONSTANTS.ENDPOINT_SCHEME,
          '#text': invoice.supplierTrn,
        },

        // IBT-029: Seller identifier
        'cac:PartyIdentification': {
          'cbc:ID': {
            '@_schemeID': PINT_AE_CONSTANTS.TRN_SCHEME,
            '#text': invoice.supplierTrn,
          },
        },

        // IBT-027: Seller name
        'cac:PartyName': {
          'cbc:Name': invoice.supplierName,
        },

        // IBG-05: Seller postal address
        'cac:PostalAddress': {
          ...(invoice.supplierAddress && {
            'cbc:StreetName': invoice.supplierAddress,
          }),
          ...(invoice.supplierCity && {
            'cbc:CityName': invoice.supplierCity,
          }),
          'cac:Country': {
            'cbc:IdentificationCode': invoice.supplierCountry || PINT_AE_CONSTANTS.COUNTRY_CODE,
          },
        },

        // IBG-06: Seller tax registration
        'cac:PartyTaxScheme': {
          // IBT-031: Seller VAT identifier (TRN)
          'cbc:CompanyID': invoice.supplierTrn,
          'cac:TaxScheme': {
            'cbc:ID': PINT_AE_CONSTANTS.TAX_SCHEME_ID,
          },
        },

        // IBG-06: Seller legal registration
        'cac:PartyLegalEntity': {
          // IBT-027: Seller trading name
          'cbc:RegistrationName': invoice.supplierName,
        },
      },
    };
  }

  /**
   * Builds buyer/customer party (IBG-07)
   */
  private buildBuyerParty(invoice: TaxInvoiceData): object {
    return {
      'cac:Party': {
        // IBT-049: Buyer electronic address
        ...(invoice.recipientTrn && {
          'cbc:EndpointID': {
            '@_schemeID': PINT_AE_CONSTANTS.ENDPOINT_SCHEME,
            '#text': invoice.recipientTrn,
          },
        }),

        // IBT-046: Buyer identifier
        ...(invoice.recipientTrn && {
          'cac:PartyIdentification': {
            'cbc:ID': {
              '@_schemeID': PINT_AE_CONSTANTS.TRN_SCHEME,
              '#text': invoice.recipientTrn,
            },
          },
        }),

        // IBT-044: Buyer name
        'cac:PartyName': {
          'cbc:Name': invoice.recipientName,
        },

        // IBG-08: Buyer postal address
        'cac:PostalAddress': {
          ...(invoice.recipientAddress && {
            'cbc:StreetName': invoice.recipientAddress,
          }),
          ...(invoice.recipientCity && {
            'cbc:CityName': invoice.recipientCity,
          }),
          'cac:Country': {
            'cbc:IdentificationCode': invoice.recipientCountry || PINT_AE_CONSTANTS.COUNTRY_CODE,
          },
        },

        // IBG-09: Buyer tax registration (if TRN provided)
        ...(invoice.recipientTrn && {
          'cac:PartyTaxScheme': {
            'cbc:CompanyID': invoice.recipientTrn,
            'cac:TaxScheme': {
              'cbc:ID': PINT_AE_CONSTANTS.TAX_SCHEME_ID,
            },
          },
        }),

        // Buyer legal entity
        'cac:PartyLegalEntity': {
          'cbc:RegistrationName': invoice.recipientName,
        },
      },
    };
  }

  /**
   * Builds tax total section (IBG-22)
   */
  private buildTaxTotal(invoice: TaxInvoiceData): object {
    const taxCategory = this.getTaxCategory(invoice);

    return {
      // IBT-110: Tax total amount
      'cbc:TaxAmount': {
        '@_currencyID': PINT_AE_CONSTANTS.DOCUMENT_CURRENCY,
        '#text': this.formatAmount(invoice.vatAmount),
      },

      // IBG-23: Tax subtotal
      'cac:TaxSubtotal': {
        // IBT-116: Tax subtotal taxable amount
        'cbc:TaxableAmount': {
          '@_currencyID': PINT_AE_CONSTANTS.DOCUMENT_CURRENCY,
          '#text': this.formatAmount(invoice.subtotal),
        },

        // IBT-117: Tax subtotal tax amount
        'cbc:TaxAmount': {
          '@_currencyID': PINT_AE_CONSTANTS.DOCUMENT_CURRENCY,
          '#text': this.formatAmount(invoice.vatAmount),
        },

        // IBG-23: Tax category
        'cac:TaxCategory': {
          // IBT-118: Tax category code
          'cbc:ID': taxCategory,

          // IBT-119: Tax category rate
          'cbc:Percent': invoice.vatRate,

          'cac:TaxScheme': {
            'cbc:ID': PINT_AE_CONSTANTS.TAX_SCHEME_ID,
          },
        },
      },
    };
  }

  /**
   * Builds monetary totals section (IBG-22)
   */
  private buildMonetaryTotal(invoice: TaxInvoiceData): object {
    return {
      // IBT-106: Sum of Invoice line net amount
      'cbc:LineExtensionAmount': {
        '@_currencyID': PINT_AE_CONSTANTS.DOCUMENT_CURRENCY,
        '#text': this.formatAmount(invoice.subtotal),
      },

      // IBT-109: Invoice total amount without VAT
      'cbc:TaxExclusiveAmount': {
        '@_currencyID': PINT_AE_CONSTANTS.DOCUMENT_CURRENCY,
        '#text': this.formatAmount(invoice.subtotal),
      },

      // IBT-112: Invoice total amount with VAT
      'cbc:TaxInclusiveAmount': {
        '@_currencyID': PINT_AE_CONSTANTS.DOCUMENT_CURRENCY,
        '#text': this.formatAmount(invoice.totalAmount),
      },

      // IBT-115: Amount due for payment
      'cbc:PayableAmount': {
        '@_currencyID': PINT_AE_CONSTANTS.DOCUMENT_CURRENCY,
        '#text': this.formatAmount(invoice.totalAmount),
      },
    };
  }

  /**
   * Builds invoice line (IBG-25)
   */
  private buildInvoiceLine(item: TaxInvoiceLineItem, lineId: number): object {
    const taxCategory = item.vatRate > 0 ? TAX_CATEGORIES.STANDARD : TAX_CATEGORIES.ZERO;

    return {
      // IBT-126: Invoice line identifier
      'cbc:ID': lineId.toString(),

      // IBT-129: Invoiced quantity
      'cbc:InvoicedQuantity': {
        '@_unitCode': item.unitCode || DEFAULT_UNIT_CODE,
        '#text': item.quantity.toString(),
      },

      // IBT-131: Invoice line net amount
      'cbc:LineExtensionAmount': {
        '@_currencyID': PINT_AE_CONSTANTS.DOCUMENT_CURRENCY,
        '#text': this.formatAmount(item.lineTotal),
      },

      // IBG-27: Invoice line VAT information
      'cac:Item': {
        // IBT-153: Item name
        'cbc:Name': item.description,

        // IBT-151: Item classification code (optional)
        ...(item.itemClassificationCode && {
          'cac:CommodityClassification': {
            'cbc:ItemClassificationCode': {
              '@_listID': 'UNSPSC',
              '#text': item.itemClassificationCode,
            },
          },
        }),

        // IBG-30: Line VAT information
        'cac:ClassifiedTaxCategory': {
          'cbc:ID': taxCategory,
          'cbc:Percent': item.vatRate,
          'cac:TaxScheme': {
            'cbc:ID': PINT_AE_CONSTANTS.TAX_SCHEME_ID,
          },
        },
      },

      // IBG-29: Price details
      'cac:Price': {
        // IBT-146: Item net price
        'cbc:PriceAmount': {
          '@_currencyID': PINT_AE_CONSTANTS.DOCUMENT_CURRENCY,
          '#text': this.formatAmount(item.unitPrice),
        },
      },
    };
  }

  /**
   * Builds credit note line
   */
  private buildCreditNoteLine(item: TaxInvoiceLineItem, lineId: number): object {
    const taxCategory = item.vatRate > 0 ? TAX_CATEGORIES.STANDARD : TAX_CATEGORIES.ZERO;

    return {
      'cbc:ID': lineId.toString(),

      'cbc:CreditedQuantity': {
        '@_unitCode': item.unitCode || DEFAULT_UNIT_CODE,
        '#text': item.quantity.toString(),
      },

      'cbc:LineExtensionAmount': {
        '@_currencyID': PINT_AE_CONSTANTS.DOCUMENT_CURRENCY,
        '#text': this.formatAmount(item.lineTotal),
      },

      'cac:Item': {
        'cbc:Name': item.description,

        'cac:ClassifiedTaxCategory': {
          'cbc:ID': taxCategory,
          'cbc:Percent': item.vatRate,
          'cac:TaxScheme': {
            'cbc:ID': PINT_AE_CONSTANTS.TAX_SCHEME_ID,
          },
        },
      },

      'cac:Price': {
        'cbc:PriceAmount': {
          '@_currencyID': PINT_AE_CONSTANTS.DOCUMENT_CURRENCY,
          '#text': this.formatAmount(item.unitPrice),
        },
      },
    };
  }

  /**
   * Determines invoice type code
   */
  private getInvoiceTypeCode(invoice: TaxInvoiceData): string {
    // Standard commercial invoice
    return PintAeInvoiceTypeCode.COMMERCIAL_INVOICE;
  }

  /**
   * Determines tax category based on invoice properties
   */
  private getTaxCategory(invoice: TaxInvoiceData): string {
    if (invoice.isReverseCharge) {
      return TAX_CATEGORIES.REVERSE_CHARGE;
    }
    if (invoice.vatRate === 0) {
      return TAX_CATEGORIES.ZERO;
    }
    return TAX_CATEGORIES.STANDARD;
  }

  /**
   * Formats date to YYYY-MM-DD (ISO 8601)
   */
  private formatDate(date: Date): string {
    return date.toISOString().split('T')[0];
  }

  /**
   * Formats amount to 2 decimal places
   */
  private formatAmount(amount: number): string {
    return amount.toFixed(2);
  }
}

export default PintAeBuilderService;
```

Update the index file:

```typescript
// backend/src/services/einvoice/index.ts
export * from './qr-code.service';
export * from './pint-ae-builder.service';
```
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compilation.</verify>
  <done>PintAeBuilderService created with buildInvoiceXml() and buildCreditNoteXml() methods. Handles all PINT AE mandatory fields with correct namespaces.</done>
</task>

<task type="auto">
  <name>Task 2: Create PINT AE Builder Unit Tests</name>
  <files>backend/src/services/einvoice/__tests__/pint-ae-builder.service.test.ts</files>
  <action>
Create unit tests for XML structure validation:

```typescript
/**
 * PINT AE Builder Service Tests
 * Phase: 06-e-invoicing-engine-core
 * Requirement: EINV-01 (PINT AE XML generation)
 */

import { PintAeBuilderService } from '../pint-ae-builder.service';
import {
  TaxInvoiceData,
  TaxInvoiceLineItem,
  PINT_AE_CONSTANTS,
} from '../../../types/einvoice.types';
import { XMLParser } from 'fast-xml-parser';

describe('PintAeBuilderService', () => {
  let service: PintAeBuilderService;
  let parser: XMLParser;

  const createValidInvoice = (): TaxInvoiceData => ({
    invoiceId: 'inv-001',
    invoiceNumber: 'INV-2026-0001',
    companyId: 'company-001',
    invoiceDate: new Date('2026-01-24'),
    dueDate: new Date('2026-02-23'),
    supplierName: 'Vesla Motors LLC',
    supplierNameArabic: 'شركة فيسلا للسيارات',
    supplierTrn: '100123456789012',
    supplierAddress: 'Dubai Silicon Oasis',
    supplierCity: 'Dubai',
    supplierCountry: 'AE',
    recipientName: 'ABC Trading Co',
    recipientTrn: '100987654321098',
    recipientAddress: 'Business Bay',
    recipientCity: 'Dubai',
    recipientCountry: 'AE',
    subtotal: 1000,
    vatAmount: 50,
    totalAmount: 1050,
    currency: 'AED',
    vatRate: 5,
    isReverseCharge: false,
    lineItems: [
      {
        lineNumber: 1,
        description: 'Vehicle rental - Toyota Camry',
        quantity: 5,
        unitCode: 'DAY',
        unitPrice: 200,
        lineTotal: 1000,
        vatRate: 5,
        vatAmount: 50,
      },
    ],
    createdById: 'user-001',
  });

  beforeEach(() => {
    service = new PintAeBuilderService();
    parser = new XMLParser({
      ignoreAttributes: false,
      attributeNamePrefix: '@_',
    });
  });

  describe('buildInvoiceXml', () => {
    it('should generate valid XML with declaration', () => {
      const invoice = createValidInvoice();
      const xml = service.buildInvoiceXml(invoice);

      expect(xml.startsWith('<?xml version="1.0" encoding="UTF-8"?>')).toBe(true);
    });

    it('should include correct namespace declarations', () => {
      const invoice = createValidInvoice();
      const xml = service.buildInvoiceXml(invoice);

      expect(xml).toContain('xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"');
      expect(xml).toContain('xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"');
      expect(xml).toContain('xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"');
    });

    it('should include PINT AE CustomizationID (IBT-024)', () => {
      const invoice = createValidInvoice();
      const xml = service.buildInvoiceXml(invoice);

      expect(xml).toContain(PINT_AE_CONSTANTS.CUSTOMIZATION_ID);
      expect(xml).toContain('urn:peppol:pint:billing-1@ae-1.0.1');
    });

    it('should include ProfileID (IBT-023)', () => {
      const invoice = createValidInvoice();
      const xml = service.buildInvoiceXml(invoice);

      expect(xml).toContain(PINT_AE_CONSTANTS.PROFILE_ID);
    });

    it('should include invoice number (IBT-001)', () => {
      const invoice = createValidInvoice();
      const xml = service.buildInvoiceXml(invoice);

      expect(xml).toContain('<cbc:ID>INV-2026-0001</cbc:ID>');
    });

    it('should format issue date as YYYY-MM-DD (IBT-002)', () => {
      const invoice = createValidInvoice();
      const xml = service.buildInvoiceXml(invoice);

      expect(xml).toContain('<cbc:IssueDate>2026-01-24</cbc:IssueDate>');
    });

    it('should include due date when provided (IBT-009)', () => {
      const invoice = createValidInvoice();
      const xml = service.buildInvoiceXml(invoice);

      expect(xml).toContain('<cbc:DueDate>2026-02-23</cbc:DueDate>');
    });

    it('should use invoice type code 380 for standard invoice (IBT-003)', () => {
      const invoice = createValidInvoice();
      const xml = service.buildInvoiceXml(invoice);

      expect(xml).toContain('<cbc:InvoiceTypeCode>380</cbc:InvoiceTypeCode>');
    });

    it('should always use AED as document currency (IBT-005)', () => {
      const invoice = createValidInvoice();
      const xml = service.buildInvoiceXml(invoice);

      expect(xml).toContain('<cbc:DocumentCurrencyCode>AED</cbc:DocumentCurrencyCode>');
    });

    it('should include supplier TRN with AEUAE-TRN scheme (IBT-031)', () => {
      const invoice = createValidInvoice();
      const xml = service.buildInvoiceXml(invoice);

      expect(xml).toContain('schemeID="AEUAE-TRN"');
      expect(xml).toContain(invoice.supplierTrn);
    });

    it('should include supplier name (IBT-027)', () => {
      const invoice = createValidInvoice();
      const xml = service.buildInvoiceXml(invoice);

      expect(xml).toContain('<cbc:Name>Vesla Motors LLC</cbc:Name>');
    });

    it('should include buyer information', () => {
      const invoice = createValidInvoice();
      const xml = service.buildInvoiceXml(invoice);

      expect(xml).toContain('ABC Trading Co');
      expect(xml).toContain(invoice.recipientTrn);
    });

    it('should include tax total with correct amounts (IBG-22)', () => {
      const invoice = createValidInvoice();
      const xml = service.buildInvoiceXml(invoice);

      expect(xml).toContain('<cbc:TaxAmount');
      expect(xml).toContain('50.00');
    });

    it('should include monetary totals (IBG-23)', () => {
      const invoice = createValidInvoice();
      const xml = service.buildInvoiceXml(invoice);

      // Line extension (subtotal)
      expect(xml).toContain('<cbc:LineExtensionAmount');
      expect(xml).toContain('1000.00');

      // Tax inclusive (total)
      expect(xml).toContain('<cbc:TaxInclusiveAmount');
      expect(xml).toContain('1050.00');

      // Payable amount
      expect(xml).toContain('<cbc:PayableAmount');
    });

    it('should include all invoice lines (IBG-25)', () => {
      const invoice = createValidInvoice();
      invoice.lineItems.push({
        lineNumber: 2,
        description: 'Insurance premium',
        quantity: 1,
        unitCode: 'EA',
        unitPrice: 100,
        lineTotal: 100,
        vatRate: 5,
        vatAmount: 5,
      });

      const xml = service.buildInvoiceXml(invoice);

      // Should have 2 invoice lines
      const matches = xml.match(/<cac:InvoiceLine>/g);
      expect(matches?.length).toBe(2);
    });

    it('should include line item details', () => {
      const invoice = createValidInvoice();
      const xml = service.buildInvoiceXml(invoice);

      // Line ID
      expect(xml).toContain('<cbc:ID>1</cbc:ID>');

      // Quantity with unit code
      expect(xml).toContain('unitCode="DAY"');
      expect(xml).toContain('>5<');

      // Item name
      expect(xml).toContain('<cbc:Name>Vehicle rental - Toyota Camry</cbc:Name>');

      // Price
      expect(xml).toContain('<cbc:PriceAmount');
      expect(xml).toContain('200.00');
    });

    it('should include tax category for standard rate', () => {
      const invoice = createValidInvoice();
      const xml = service.buildInvoiceXml(invoice);

      expect(xml).toContain('<cbc:ID>S</cbc:ID>');
      expect(xml).toContain('<cbc:Percent>5</cbc:Percent>');
    });

    it('should handle zero-rate VAT', () => {
      const invoice = createValidInvoice();
      invoice.vatRate = 0;
      invoice.vatAmount = 0;
      invoice.lineItems[0].vatRate = 0;
      invoice.lineItems[0].vatAmount = 0;

      const xml = service.buildInvoiceXml(invoice);

      expect(xml).toContain('<cbc:ID>Z</cbc:ID>');
    });

    it('should handle reverse charge', () => {
      const invoice = createValidInvoice();
      invoice.isReverseCharge = true;

      const xml = service.buildInvoiceXml(invoice);

      expect(xml).toContain('<cbc:ID>AE</cbc:ID>');
    });

    it('should parse back to valid structure', () => {
      const invoice = createValidInvoice();
      const xml = service.buildInvoiceXml(invoice);

      const parsed = parser.parse(xml);

      expect(parsed.Invoice).toBeDefined();
      expect(parsed.Invoice['cbc:ID']).toBe(invoice.invoiceNumber);
      expect(parsed.Invoice['cbc:DocumentCurrencyCode']).toBe('AED');
    });

    it('should handle buyer without TRN', () => {
      const invoice = createValidInvoice();
      delete (invoice as any).recipientTrn;

      const xml = service.buildInvoiceXml(invoice);

      // Should not include buyer TRN elements
      expect(xml).not.toContain('100987654321098');
      // Should still include buyer name
      expect(xml).toContain('ABC Trading Co');
    });

    it('should include notes when provided', () => {
      const invoice = createValidInvoice();
      invoice.notes = 'Payment due within 30 days';

      const xml = service.buildInvoiceXml(invoice);

      expect(xml).toContain('<cbc:Note>Payment due within 30 days</cbc:Note>');
    });
  });

  describe('buildCreditNoteXml', () => {
    it('should generate valid credit note XML', () => {
      const creditNote = createValidInvoice();
      creditNote.invoiceNumber = 'CN-2026-0001';

      const xml = service.buildCreditNoteXml(creditNote, 'INV-2026-0001');

      expect(xml).toContain('<CreditNote');
      expect(xml).toContain('xmlns="urn:oasis:names:specification:ubl:schema:xsd:CreditNote-2"');
    });

    it('should include reference to original invoice', () => {
      const creditNote = createValidInvoice();
      creditNote.invoiceNumber = 'CN-2026-0001';

      const xml = service.buildCreditNoteXml(creditNote, 'INV-2026-0001');

      expect(xml).toContain('<cac:BillingReference>');
      expect(xml).toContain('<cac:InvoiceDocumentReference>');
      expect(xml).toContain('INV-2026-0001');
    });

    it('should use credit note type code 381', () => {
      const creditNote = createValidInvoice();
      creditNote.invoiceNumber = 'CN-2026-0001';

      const xml = service.buildCreditNoteXml(creditNote, 'INV-2026-0001');

      expect(xml).toContain('<cbc:CreditNoteTypeCode>381</cbc:CreditNoteTypeCode>');
    });

    it('should use CreditedQuantity instead of InvoicedQuantity', () => {
      const creditNote = createValidInvoice();
      creditNote.invoiceNumber = 'CN-2026-0001';

      const xml = service.buildCreditNoteXml(creditNote, 'INV-2026-0001');

      expect(xml).toContain('<cbc:CreditedQuantity');
      expect(xml).not.toContain('<cbc:InvoicedQuantity');
    });
  });

  describe('XML validation patterns', () => {
    it('should produce well-formed XML', () => {
      const invoice = createValidInvoice();
      const xml = service.buildInvoiceXml(invoice);

      // Should not throw when parsing
      expect(() => parser.parse(xml)).not.toThrow();
    });

    it('should not contain undefined or null values', () => {
      const invoice = createValidInvoice();
      const xml = service.buildInvoiceXml(invoice);

      expect(xml).not.toContain('undefined');
      expect(xml).not.toContain('null');
    });

    it('should properly escape special characters', () => {
      const invoice = createValidInvoice();
      invoice.notes = 'Terms & Conditions apply <see contract>';

      const xml = service.buildInvoiceXml(invoice);

      // fast-xml-parser should handle escaping
      expect(() => parser.parse(xml)).not.toThrow();
    });
  });
});
```
  </action>
  <verify>Run `npm test -- --testPathPattern=pint-ae-builder.service.test.ts` - all tests should pass.</verify>
  <done>Unit tests created covering XML structure, namespace declarations, mandatory fields (IBT-xxx), credit note generation, and XML well-formedness.</done>
</task>

</tasks>

<verification>
1. XML validation: Generated XML can be parsed without errors
2. Namespace check: All three UBL 2.1 namespaces present
3. Mandatory fields: CustomizationID, ProfileID, ID, IssueDate, InvoiceTypeCode, DocumentCurrencyCode present
4. TRN format: Supplier TRN uses AEUAE-TRN scheme identifier
5. Tests: All unit tests pass
</verification>

<success_criteria>
1. buildInvoiceXml() produces valid PINT AE XML structure
2. buildCreditNoteXml() produces valid credit note with original reference
3. All UBL 2.1 namespace declarations correct
4. CustomizationID contains PINT AE specification identifier
5. DocumentCurrencyCode always AED
6. Unit tests cover all mandatory PINT AE fields
</success_criteria>

<output>
After completion, create `.planning/phases/06-e-invoicing-engine-core/06-03-SUMMARY.md`
</output>
