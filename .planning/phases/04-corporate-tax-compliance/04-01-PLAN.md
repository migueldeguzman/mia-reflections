---
phase: 04-corporate-tax-compliance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/prisma/schema.prisma
  - backend/src/types/corporate-tax.types.ts
  - backend/prisma/migrations/YYYYMMDDHHMMSS_corporate_tax_schema/migration.sql
autonomous: true

must_haves:
  truths:
    - "Tax losses can be tracked with amount, usage, and remaining balance"
    - "Related party transactions can be recorded with arm's length pricing"
    - "Tax groups can be created with 95%+ ownership requirement"
    - "CT enums cover all expense and income classifications"
    - "Fiscal year tax periods can be managed for CT filing"
  artifacts:
    - path: "backend/prisma/schema.prisma"
      provides: "CT-related models (taxLoss, relatedPartyTransaction, taxGroup, taxGroupMember, ctTaxPeriod)"
      contains: "model taxLoss"
    - path: "backend/src/types/corporate-tax.types.ts"
      provides: "TypeScript interfaces for CT calculations and adjustments"
      exports: ["CtCalculationResult", "CtAdjustmentSummary", "TaxableIncomeSchedule", "CtExpenseClassification"]
  key_links:
    - from: "corporate-tax.types.ts"
      to: "prisma/schema.prisma"
      via: "Type definitions matching schema enums"
      pattern: "CtExpenseClassification|CtIncomeClassification"
---

<objective>
Create the Corporate Tax schema foundation including tax losses tracking, related party transactions, and tax group models.

Purpose: UAE Corporate Tax (9% on profits exceeding AED 375,000) requires tracking non-deductible expenses, exempt income, tax losses, related party transactions for transfer pricing, and group consolidation. This schema foundation enables all CT-01 through CT-09 requirements.

Output:
- CT enums for expense/income classification
- taxLoss model for loss carry-forward tracking
- relatedPartyTransaction model for transfer pricing
- taxGroup and taxGroupMember models for consolidation
- ctTaxPeriod model for CT filing periods
- TypeScript types for CT calculations
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-corporate-tax-compliance/04-RESEARCH.md

# Existing codebase patterns
@backend/prisma/schema.prisma
@backend/src/utils/decimal-math.util.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Corporate Tax Enums to Schema</name>
  <files>backend/prisma/schema.prisma</files>
  <action>
Add the following CT-related enums to the schema file:

```prisma
// ============================================================================
// Corporate Tax Enums (Phase 4)
// ============================================================================

enum CtAccountCategory {
  // Revenue categories
  TRADING_INCOME           // Normal business income
  INVESTMENT_INCOME        // Interest, royalties
  DIVIDEND_INCOME          // Dividends received
  CAPITAL_GAINS            // Gains on asset disposal
  OTHER_INCOME             // Miscellaneous income

  // Expense categories
  COST_OF_SALES            // Direct costs
  STAFF_COSTS              // Salaries, benefits
  ADMIN_EXPENSES           // General admin
  ENTERTAINMENT            // 50% deductible
  DEPRECIATION             // Asset depreciation
  FINANCE_COSTS            // Interest expense
  FINES_PENALTIES          // 0% deductible
  DONATIONS                // To qualifying public benefit entities
  RELATED_PARTY_EXPENSE    // Intercompany expenses

  // Balance sheet categories (for CT adjustments)
  FIXED_ASSETS             // PPE
  INVESTMENTS              // Investment holdings
  RELATED_PARTY_RECEIVABLES
  RELATED_PARTY_PAYABLES

  // Not CT relevant
  NOT_APPLICABLE
}

enum CtExpenseClassification {
  FULLY_DEDUCTIBLE         // 100% deductible for CT
  NON_DEDUCTIBLE           // 0% deductible (fines, penalties, bribes)
  ENTERTAINMENT_50_PCT     // 50% deductible (entertainment)
  RELATED_PARTY            // Subject to arm's length test
  OWNER_WITHDRAWAL         // Not deductible
  PERSONAL_EXPENSE         // Not deductible
}

enum CtIncomeClassification {
  TAXABLE                  // Subject to 9% CT
  EXEMPT_DIVIDEND          // Participation exemption
  EXEMPT_CAPITAL_GAIN      // Participation exemption
  EXEMPT_FOREIGN_PE        // Foreign PE election
  QUALIFYING_INCOME        // QFZP qualifying income (0%)
  NON_QUALIFYING_INCOME    // QFZP non-qualifying (9%)
}

enum TaxGroupStatus {
  PENDING                  // Application submitted
  ACTIVE                   // FTA approved, active
  DISSOLVED                // Group dissolved
  REJECTED                 // FTA rejected
}

enum CtTaxPeriodStatus {
  OPEN                     // Transactions can be recorded
  CLOSED                   // Period closed, preparing return
  FILED                    // CT return filed
  ASSESSED                 // FTA assessment received
  AMENDED                  // Return amended
}

enum RelationshipType {
  SUBSIDIARY               // >50% owned
  PARENT                   // Owns >50%
  SISTER                   // Common parent
  ASSOCIATE                // 20-50% owned
  COMMON_OWNER             // Same beneficial owner
  KEY_MANAGEMENT           // Directors, officers
}

enum TransferPricingMethod {
  CUP                      // Comparable Uncontrolled Price
  RESALE_MINUS             // Resale Price Method
  COST_PLUS                // Cost Plus Method
  TNMM                     // Transactional Net Margin Method
  PROFIT_SPLIT             // Profit Split Method
}
```

These enums support:
- CT-02: Non-deductible expense classification
- CT-03: Exempt income classification
- CT-04: Chart of accounts CT mapping
- CT-07: Transfer pricing methods
- CT-09: Tax group status tracking
  </action>
  <verify>
Run `npx prisma validate` to ensure schema is valid.
  </verify>
  <done>
Schema contains all CT enums:
- CtAccountCategory (15 categories)
- CtExpenseClassification (6 types)
- CtIncomeClassification (6 types)
- TaxGroupStatus, CtTaxPeriodStatus
- RelationshipType, TransferPricingMethod
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Corporate Tax Models to Schema</name>
  <files>backend/prisma/schema.prisma</files>
  <action>
Add the following CT-related models to the schema file:

```prisma
// ============================================================================
// Corporate Tax Models (Phase 4)
// ============================================================================

/// Tax loss carry-forward tracking (CT-01)
/// UAE CT allows indefinite loss carry-forward with 75% utilization cap
model taxLoss {
  id              String   @id @default(uuid())
  companyId       String   @map("company_id")
  fiscalYearId    String   @map("fiscal_year_id")

  // Loss details
  lossType        String   @map("loss_type") // TRADING, CAPITAL
  lossAmount      Decimal  @map("loss_amount") @db.Decimal(15,2)
  usedAmount      Decimal  @default(0) @map("used_amount") @db.Decimal(15,2)
  remainingAmount Decimal  @map("remaining_amount") @db.Decimal(15,2)

  // Period info
  periodStart     DateTime @map("period_start")
  periodEnd       DateTime @map("period_end")

  // Audit
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  createdById     String   @map("created_by_id")

  company         Company  @relation(fields: [companyId], references: [id])
  createdBy       User     @relation(fields: [createdById], references: [id])
  usages          taxLossUsage[]

  @@index([companyId, fiscalYearId])
  @@map("tax_losses")
}

/// Tax loss usage tracking
model taxLossUsage {
  id              String   @id @default(uuid())
  taxLossId       String   @map("tax_loss_id")
  appliedInPeriod String   @map("applied_in_period")
  amountUsed      Decimal  @map("amount_used") @db.Decimal(15,2)

  // Before/after balances for audit
  balanceBefore   Decimal  @map("balance_before") @db.Decimal(15,2)
  balanceAfter    Decimal  @map("balance_after") @db.Decimal(15,2)

  createdAt       DateTime @default(now()) @map("created_at")
  createdById     String   @map("created_by_id")

  taxLoss         taxLoss  @relation(fields: [taxLossId], references: [id])

  @@map("tax_loss_usages")
}

/// Related party transactions for transfer pricing (CT-07)
model relatedPartyTransaction {
  id                  String   @id @default(uuid())
  companyId           String   @map("company_id")

  // Related party details
  relatedPartyId      String   @map("related_party_id")
  relatedPartyName    String   @map("related_party_name")
  relatedPartyTrn     String?  @map("related_party_trn")
  relationshipType    RelationshipType @map("relationship_type")

  // Transaction details
  transactionDate     DateTime @map("transaction_date")
  transactionType     String   @map("transaction_type") // SALE, PURCHASE, SERVICE, LOAN, IP_LICENSE
  description         String
  transactionAmount   Decimal  @map("transaction_amount") @db.Decimal(15,2)
  currency            String   @default("AED") @db.VarChar(3)

  // Transfer pricing
  armLengthPrice      Decimal? @map("arm_length_price") @db.Decimal(15,2)
  pricingMethod       TransferPricingMethod? @map("pricing_method")
  adjustmentRequired  Boolean  @default(false) @map("adjustment_required")
  adjustmentAmount    Decimal? @map("adjustment_amount") @db.Decimal(15,2)

  // Documentation (CT-07 requirement)
  hasLocalFile        Boolean  @default(false) @map("has_local_file")
  hasMasterFile       Boolean  @default(false) @map("has_master_file")
  benchmarkingDone    Boolean  @default(false) @map("benchmarking_done")
  documentationPath   String?  @map("documentation_path")
  notes               String?  @db.Text

  // Link to accounting
  journalEntryId      String?  @map("journal_entry_id")

  // Audit
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  createdById         String   @map("created_by_id")

  company             Company  @relation(fields: [companyId], references: [id])
  createdBy           User     @relation(fields: [createdById], references: [id])

  @@index([companyId, transactionDate])
  @@index([companyId, relatedPartyId])
  @@map("related_party_transactions")
}

/// Tax group for CT consolidation (CT-09)
/// Requires 95%+ ownership of share capital, voting rights, and profit entitlement
model taxGroup {
  id              String          @id @default(uuid())
  parentCompanyId String          @map("parent_company_id")
  groupName       String          @map("group_name")

  // FTA registration
  ftaGroupNumber  String?         @map("fta_group_number")
  effectiveDate   DateTime        @map("effective_date")
  applicationDate DateTime?       @map("application_date")
  approvalDate    DateTime?       @map("approval_date")

  // Status
  status          TaxGroupStatus  @default(PENDING)
  dissolutionDate DateTime?       @map("dissolution_date")

  // Audit
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  createdById     String          @map("created_by_id")

  parentCompany   Company         @relation("TaxGroupParent", fields: [parentCompanyId], references: [id])
  createdBy       User            @relation(fields: [createdById], references: [id])
  members         taxGroupMember[]

  @@unique([parentCompanyId, groupName])
  @@map("tax_groups")
}

/// Tax group members (95%+ owned subsidiaries)
model taxGroupMember {
  id                  String   @id @default(uuid())
  taxGroupId          String   @map("tax_group_id")
  companyId           String   @map("company_id")

  // Ownership verification (must be 95%+ for all three)
  shareCapitalPct     Decimal  @map("share_capital_pct") @db.Decimal(5,2)
  votingRightsPct     Decimal  @map("voting_rights_pct") @db.Decimal(5,2)
  profitEntitlementPct Decimal @map("profit_entitlement_pct") @db.Decimal(5,2)

  // Dates
  joinDate            DateTime @map("join_date")
  leaveDate           DateTime? @map("leave_date")

  // Verification
  verifiedAt          DateTime? @map("verified_at")
  verifiedById        String?   @map("verified_by_id")

  // Audit
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  taxGroup            taxGroup @relation(fields: [taxGroupId], references: [id])
  company             Company  @relation(fields: [companyId], references: [id])

  @@unique([taxGroupId, companyId])
  @@map("tax_group_members")
}

/// CT tax period for filing (CT-01)
model ctTaxPeriod {
  id              String            @id @default(uuid())
  companyId       String            @map("company_id")

  // Period details
  periodNumber    String            @map("period_number") // e.g., "FY2026"
  startDate       DateTime          @map("start_date")
  endDate         DateTime          @map("end_date")

  // Filing info
  filingDeadline  DateTime          @map("filing_deadline") // 9 months after period end
  status          CtTaxPeriodStatus @default(OPEN)

  // Cached calculation results
  accountingIncome    Decimal?      @map("accounting_income") @db.Decimal(15,2)
  taxableIncome       Decimal?      @map("taxable_income") @db.Decimal(15,2)
  ctPayable           Decimal?      @map("ct_payable") @db.Decimal(15,2)

  // Filing
  filedAt         DateTime?         @map("filed_at")
  filedById       String?           @map("filed_by_id")
  ftaReferenceNumber String?        @map("fta_reference_number")

  // For tax groups
  taxGroupId      String?           @map("tax_group_id")
  isConsolidated  Boolean           @default(false) @map("is_consolidated")

  // Audit
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  lockedAt        DateTime?         @map("locked_at")
  lockedById      String?           @map("locked_by_id")

  company         Company           @relation(fields: [companyId], references: [id])
  filedBy         User?             @relation("CtPeriodFiledBy", fields: [filedById], references: [id])
  lockedBy        User?             @relation("CtPeriodLockedBy", fields: [lockedById], references: [id])

  @@unique([companyId, periodNumber])
  @@map("ct_tax_periods")
}
```

Add the following fields to the existing chartOfAccounts model (if it exists) or to chart_of_accounts:

```prisma
// Add to chart_of_accounts model
ctCategory          CtAccountCategory?       @map("ct_category")
ctExpenseClass      CtExpenseClassification? @map("ct_expense_class")
ctIncomeClass       CtIncomeClassification?  @map("ct_income_class")
isQualifyingPBE     Boolean                  @default(false) @map("is_qualifying_pbe")
```

Add relation arrays to Company and User models for the new CT models.
  </action>
  <verify>
Run `npx prisma validate` to ensure schema is valid.
Run `npx prisma format` to format the schema file.
  </verify>
  <done>
Schema contains all CT models:
- taxLoss with lossAmount, usedAmount, remainingAmount
- taxLossUsage for tracking loss utilization
- relatedPartyTransaction with transfer pricing fields
- taxGroup with FTA registration fields
- taxGroupMember with 95%+ ownership verification
- ctTaxPeriod with filing status
- chartOfAccounts extended with CT mapping fields
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Corporate Tax TypeScript Types</name>
  <files>backend/src/types/corporate-tax.types.ts</files>
  <action>
Create comprehensive TypeScript types for Corporate Tax operations:

```typescript
import { Decimal } from '@prisma/client/runtime/library';

// ============================================================================
// CT Classification Types (from schema enums)
// ============================================================================

export type CtAccountCategory =
  | 'TRADING_INCOME'
  | 'INVESTMENT_INCOME'
  | 'DIVIDEND_INCOME'
  | 'CAPITAL_GAINS'
  | 'OTHER_INCOME'
  | 'COST_OF_SALES'
  | 'STAFF_COSTS'
  | 'ADMIN_EXPENSES'
  | 'ENTERTAINMENT'
  | 'DEPRECIATION'
  | 'FINANCE_COSTS'
  | 'FINES_PENALTIES'
  | 'DONATIONS'
  | 'RELATED_PARTY_EXPENSE'
  | 'FIXED_ASSETS'
  | 'INVESTMENTS'
  | 'RELATED_PARTY_RECEIVABLES'
  | 'RELATED_PARTY_PAYABLES'
  | 'NOT_APPLICABLE';

export type CtExpenseClassification =
  | 'FULLY_DEDUCTIBLE'
  | 'NON_DEDUCTIBLE'
  | 'ENTERTAINMENT_50_PCT'
  | 'RELATED_PARTY'
  | 'OWNER_WITHDRAWAL'
  | 'PERSONAL_EXPENSE';

export type CtIncomeClassification =
  | 'TAXABLE'
  | 'EXEMPT_DIVIDEND'
  | 'EXEMPT_CAPITAL_GAIN'
  | 'EXEMPT_FOREIGN_PE'
  | 'QUALIFYING_INCOME'
  | 'NON_QUALIFYING_INCOME';

export type RelationshipType =
  | 'SUBSIDIARY'
  | 'PARENT'
  | 'SISTER'
  | 'ASSOCIATE'
  | 'COMMON_OWNER'
  | 'KEY_MANAGEMENT';

export type TransferPricingMethod =
  | 'CUP'
  | 'RESALE_MINUS'
  | 'COST_PLUS'
  | 'TNMM'
  | 'PROFIT_SPLIT';

// ============================================================================
// CT Calculation Types (CT-01)
// ============================================================================

/** UAE Corporate Tax constants */
export const CT_CONSTANTS = {
  /** Small business threshold - 0% rate up to this amount */
  THRESHOLD: new Decimal('375000'),
  /** Standard CT rate (9%) */
  RATE: new Decimal('0.09'),
  /** Maximum loss offset percentage (75%) */
  MAX_LOSS_OFFSET: new Decimal('0.75'),
  /** Small Business Relief revenue threshold */
  SBR_THRESHOLD: new Decimal('3000000'),
  /** Minimum ownership for participation exemption */
  PARTICIPATION_OWNERSHIP_MIN: new Decimal('5'),
  /** Alternative cost threshold for participation (AED) */
  PARTICIPATION_COST_THRESHOLD: new Decimal('4000000'),
  /** Minimum holding period for participation (months) */
  PARTICIPATION_HOLDING_MONTHS: 12,
  /** Minimum foreign tax rate for participation exemption */
  PARTICIPATION_TAX_RATE_MIN: new Decimal('9'),
  /** Tax group minimum ownership percentage */
  TAX_GROUP_OWNERSHIP_MIN: new Decimal('95'),
} as const;

/** Input for CT calculation */
export interface CtCalculationInput {
  companyId: string;
  fiscalYearId: string;
  startDate: Date;
  endDate: Date;
  isQfzp?: boolean;
}

/** Complete CT calculation result */
export interface CtCalculationResult {
  // Source data
  companyId: string;
  periodStart: Date;
  periodEnd: Date;

  // Starting point
  accountingIncome: Decimal;

  // Adjustments
  exemptIncome: ExemptIncomeSummary;
  nonDeductibleExpenses: NonDeductibleSummary;
  otherAdjustments: OtherAdjustmentsSummary;

  // Taxable income
  taxableIncomeBeforeLosses: Decimal;
  availableLosses: Decimal;
  lossesApplied: Decimal;  // Capped at 75% of taxable income
  taxableIncome: Decimal;

  // CT calculation
  taxFreeAmount: Decimal;      // Up to AED 375,000
  taxableAmount: Decimal;      // Amount above threshold
  ctRate: Decimal;             // 0.09 (9%)
  ctPayable: Decimal;

  // QFZP (if applicable)
  isQfzp: boolean;
  qualifyingIncome?: Decimal;
  nonQualifyingIncome?: Decimal;

  // Small Business Relief check
  eligibleForSbr: boolean;
  sbrApplied: boolean;
}

/** Taxable income calculation schedule */
export interface TaxableIncomeSchedule {
  line1_accountingIncome: Decimal;
  line2_exemptIncome: Decimal;
  line3_nonDeductibleExpenses: Decimal;
  line4_otherAdditions: Decimal;
  line5_otherDeductions: Decimal;
  line6_taxableIncomeBeforeLosses: Decimal;
  line7_lossRelief: Decimal;
  line8_taxableIncome: Decimal;
}

// ============================================================================
// Exempt Income Types (CT-03)
// ============================================================================

export interface ExemptIncomeSummary {
  dividends: DividendExemptionDetail;
  capitalGains: CapitalGainExemptionDetail;
  foreignPeIncome: Decimal;
  intraGroupReorganization: Decimal;
  total: Decimal;
}

export interface DividendExemptionDetail {
  domesticDividends: Decimal;
  foreignDividends: Decimal;
  total: Decimal;
  details: ParticipationDetail[];
}

export interface CapitalGainExemptionDetail {
  qualifyingGains: Decimal;
  nonQualifyingGains: Decimal;
  total: Decimal;
  details: ParticipationDetail[];
}

export interface ParticipationDetail {
  investmentId: string;
  entityName: string;
  ownershipPercent: Decimal;
  acquisitionDate: Date;
  acquisitionCost: Decimal;
  foreignTaxRate?: Decimal;
  qualifiesForExemption: boolean;
  exemptionReason?: string;
  amount: Decimal;
}

// ============================================================================
// Non-Deductible Expense Types (CT-02)
// ============================================================================

export interface NonDeductibleSummary {
  finesAndPenalties: Decimal;
  entertainmentDisallowed: Decimal;  // 50% of entertainment
  donationsDisallowed: Decimal;       // Non-QPBE donations
  ownerWithdrawals: Decimal;
  personalExpenses: Decimal;
  relatedPartyExcess: Decimal;        // Non-arm's length portion
  recoverableInputVat: Decimal;
  illicitPayments: Decimal;
  total: Decimal;
}

export interface NonDeductibleDetail {
  accountId: string;
  accountName: string;
  totalExpense: Decimal;
  deductiblePortion: Decimal;
  nonDeductiblePortion: Decimal;
  classification: CtExpenseClassification;
  reason: string;
}

// ============================================================================
// Other Adjustments Types
// ============================================================================

export interface OtherAdjustmentsSummary {
  unrealizedGainsLosses: Decimal;
  transitionalAdjustments: Decimal;
  interestLimitation: Decimal;  // If applicable
  total: Decimal;
}

// ============================================================================
// Transfer Pricing Types (CT-07)
// ============================================================================

export interface TransferPricingThresholds {
  totalRelatedPartyValue: Decimal;
  exceedsAed40M: boolean;
  requiresDisclosureForm: boolean;

  byCategory: TransferPricingCategoryBreakdown[];

  connectedPersonPayments: Decimal;
  exceedsAed500K: boolean;

  groupRevenue: Decimal;
  requiresMasterLocalFile: boolean;  // > AED 200M
  requiresCbcr: boolean;             // > AED 3.15B
}

export interface TransferPricingCategoryBreakdown {
  transactionType: string;
  totalAmount: Decimal;
  transactionCount: number;
  exceedsAed4M: boolean;
}

export interface RelatedPartyTransactionInput {
  companyId: string;
  relatedPartyId: string;
  relatedPartyName: string;
  relatedPartyTrn?: string;
  relationshipType: RelationshipType;
  transactionDate: Date;
  transactionType: 'SALE' | 'PURCHASE' | 'SERVICE' | 'LOAN' | 'IP_LICENSE';
  description: string;
  transactionAmount: Decimal;
  currency?: string;
  armLengthPrice?: Decimal;
  pricingMethod?: TransferPricingMethod;
  createdById: string;
}

export interface ArmLengthTestResult {
  transactionId: string;
  transactionAmount: Decimal;
  armLengthPrice: Decimal;
  difference: Decimal;
  differencePercent: Decimal;
  withinRange: boolean;
  adjustmentRequired: boolean;
  adjustmentAmount: Decimal;
  pricingMethod: TransferPricingMethod;
}

// ============================================================================
// Tax Group Types (CT-09)
// ============================================================================

export interface TaxGroupEligibility {
  eligible: boolean;
  reason?: string;
  parentCompanyId: string;
  potentialMembers: TaxGroupMemberEligibility[];
}

export interface TaxGroupMemberEligibility {
  companyId: string;
  companyName: string;
  shareCapitalPct: Decimal;
  votingRightsPct: Decimal;
  profitEntitlementPct: Decimal;
  meetsOwnershipTest: boolean;  // All three >= 95%
  sameAccountingStandards: boolean;
  sameFiscalYear: boolean;
  isUaeResident: boolean;
  isExemptPerson: boolean;
  isQfzp: boolean;
  eligible: boolean;
  ineligibilityReason?: string;
}

export interface ConsolidatedCtReturn {
  taxGroupId: string;
  periodId: string;
  periodNumber: string;

  // Per-member breakdown
  memberResults: TaxGroupMemberResult[];

  // Eliminations
  intercompanyEliminations: IntercompanyElimination[];
  totalEliminationAmount: Decimal;

  // Consolidated figures
  consolidatedAccountingIncome: Decimal;
  consolidatedAdjustments: Decimal;
  consolidatedTaxableIncome: Decimal;
  consolidatedCtPayable: Decimal;

  // Filing
  filedBy: string;
  filedAt?: Date;
}

export interface TaxGroupMemberResult {
  companyId: string;
  companyName: string;
  accountingIncome: Decimal;
  adjustments: Decimal;
  taxableIncome: Decimal;
  lossesGenerated: Decimal;
  lossesUtilized: Decimal;
}

export interface IntercompanyElimination {
  sellingMemberId: string;
  buyingMemberId: string;
  transactionType: string;
  amount: Decimal;
  eliminated: boolean;
}

// ============================================================================
// Tax Loss Types
// ============================================================================

export interface TaxLossRecord {
  id: string;
  companyId: string;
  fiscalYearId: string;
  lossType: 'TRADING' | 'CAPITAL';
  lossAmount: Decimal;
  usedAmount: Decimal;
  remainingAmount: Decimal;
  periodStart: Date;
  periodEnd: Date;
}

export interface LossOffsetCalculation {
  taxableIncomeBeforeLosses: Decimal;
  maxOffsetAmount: Decimal;  // 75% of taxable income
  availableLosses: TaxLossRecord[];
  totalAvailable: Decimal;
  amountToOffset: Decimal;
  taxableIncomeAfterLosses: Decimal;
  lossesRemaining: Decimal;
}

// ============================================================================
// CT-Adjusted Financial Statement Types (CT-05, CT-06)
// ============================================================================

export interface CtAdjustedProfitAndLoss {
  companyId: string;
  periodStart: Date;
  periodEnd: Date;

  // Standard P&L
  revenue: CtAdjustedSection;
  costOfSales: CtAdjustedSection;
  grossProfit: CtAdjustedLine;
  operatingExpenses: CtAdjustedSection;
  operatingProfit: CtAdjustedLine;
  otherIncome: CtAdjustedSection;
  otherExpenses: CtAdjustedSection;
  netAccountingIncome: CtAdjustedLine;

  // CT Adjustments summary
  ctAdjustments: {
    exemptIncomeDeductions: Decimal;
    nonDeductibleAdditions: Decimal;
    otherAdjustments: Decimal;
    netAdjustment: Decimal;
  };

  // Taxable Income
  taxableIncome: Decimal;
  ctPayable: Decimal;
}

export interface CtAdjustedSection {
  accounts: CtAdjustedAccountLine[];
  total: CtAdjustedLine;
}

export interface CtAdjustedAccountLine {
  accountId: string;
  accountCode: string;
  accountName: string;
  ctCategory: CtAccountCategory;

  // Standard accounting
  accountingAmount: Decimal;

  // CT adjustments
  exemptAmount: Decimal;
  nonDeductibleAmount: Decimal;

  // CT taxable
  taxableAmount: Decimal;
}

export interface CtAdjustedLine {
  accountingAmount: Decimal;
  adjustment: Decimal;
  taxableAmount: Decimal;
}

export interface CtAdjustedBalanceSheet {
  companyId: string;
  asOfDate: Date;

  assets: CtAdjustedSection;
  liabilities: CtAdjustedSection;
  equity: CtAdjustedSection;

  // Tax-specific items
  deferredTaxAsset: Decimal;
  deferredTaxLiability: Decimal;
  currentTaxPayable: Decimal;
}

// ============================================================================
// Small Business Relief Types
// ============================================================================

export interface SmallBusinessReliefCheck {
  eligible: boolean;
  reason?: string;
  currentPeriodRevenue: Decimal;
  previousPeriodRevenue: Decimal;
  thresholdAmount: Decimal;
  reliefEndDate: Date;
  isQfzp: boolean;
}

// ============================================================================
// Filing Types
// ============================================================================

export interface CtReturnData {
  companyId: string;
  periodId: string;
  periodNumber: string;

  // Company info
  trn: string;
  companyName: string;

  // Calculation summary
  calculationResult: CtCalculationResult;

  // Schedules
  taxableIncomeSchedule: TaxableIncomeSchedule;
  exemptIncomeSchedule: ExemptIncomeSummary;
  nonDeductibleSchedule: NonDeductibleSummary;

  // Transfer pricing (if applicable)
  tpDisclosure?: TransferPricingThresholds;

  // For consolidated returns
  isConsolidated: boolean;
  consolidatedData?: ConsolidatedCtReturn;

  // Status
  preparedAt: Date;
  preparedById: string;
}
```

Create the file at `backend/src/types/corporate-tax.types.ts`.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles without errors.
Check that all exported types are accessible.
  </verify>
  <done>
corporate-tax.types.ts exports:
- CT_CONSTANTS with threshold (375,000), rate (9%), loss offset (75%)
- CtCalculationResult for full CT computation
- TaxableIncomeSchedule for form layout
- ExemptIncomeSummary for CT-03
- NonDeductibleSummary for CT-02
- TransferPricingThresholds for CT-07
- TaxGroupEligibility and ConsolidatedCtReturn for CT-09
- CtAdjustedProfitAndLoss and CtAdjustedBalanceSheet for CT-05/06
- SmallBusinessReliefCheck
  </done>
</task>

</tasks>

<verification>
1. Run `npx prisma validate` - should pass
2. Run `npx tsc --noEmit` - should compile
3. Verify corporate-tax.types.ts exports via `grep -c "export" backend/src/types/corporate-tax.types.ts`
4. Verify schema has taxLoss, relatedPartyTransaction, taxGroup, taxGroupMember, ctTaxPeriod models
</verification>

<success_criteria>
- Schema contains all CT enums (CtAccountCategory, CtExpenseClassification, CtIncomeClassification, etc.)
- taxLoss model tracks losses with 75% offset cap support
- relatedPartyTransaction model has transfer pricing fields
- taxGroup model has 95% ownership verification
- ctTaxPeriod model enables CT filing workflow
- chartOfAccounts has CT mapping fields
- TypeScript types provide strong typing for CT operations
- CT_CONSTANTS has AED 375,000 threshold and 9% rate
</success_criteria>

<output>
After completion, create `.planning/phases/04-corporate-tax-compliance/04-01-SUMMARY.md`
</output>
