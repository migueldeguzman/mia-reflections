---
phase: 02-internal-controls-audit
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - web-erp-app/backend/prisma/seeds/workflows/fta-approval-workflows.seed.ts
  - web-erp-app/backend/prisma/tenant-schema.prisma
autonomous: true
user_setup: []

must_haves:
  truths:
    - "VAT submission requires multi-level approval before processing"
    - "Payroll approval follows HR then Finance manager workflow"
    - "TRN configuration changes require compliance officer and CEO approval"
    - "Approval workflows are configurable per tenant"
  artifacts:
    - path: "web-erp-app/backend/prisma/seeds/workflows/fta-approval-workflows.seed.ts"
      provides: "Seed data for FTA compliance approval workflows"
      exports: ["seedFtaApprovalWorkflows"]
    - path: "web-erp-app/backend/prisma/tenant-schema.prisma"
      provides: "Extended ApprovalDocumentType enum"
      contains: "VAT_RETURN"
  key_links:
    - from: "fta-approval-workflows.seed.ts"
      to: "approval_workflows table"
      via: "Prisma upsert operations"
      pattern: "prisma\\.approval_workflows\\.upsert"
    - from: "approval_workflow_levels table"
      to: "approval_workflows table"
      via: "workflowId foreign key"
      pattern: "workflowId.*references.*approval_workflows"
---

<objective>
Create FTA compliance approval workflow seed configurations for VAT submission, payroll approval, and TRN configuration changes.

Purpose: Satisfy CTRL-04 (approval workflows for sensitive operations) by providing pre-configured approval workflows for FTA-critical operations. These workflows ensure that VAT returns, payroll processing, and compliance configuration changes go through proper authorization chains.

Output: Approval workflow seed script with configurations for VAT_RETURN, PAYROLL, and COMPLIANCE_CONFIG document types, plus schema updates for new document types.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-internal-controls-audit/02-RESEARCH.md
@web-erp-app/backend/prisma/tenant-schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ApprovalDocumentType enum for FTA workflows</name>
  <files>
    web-erp-app/backend/prisma/tenant-schema.prisma
  </files>
  <action>
First, check if ApprovalDocumentType enum exists in tenant-schema.prisma. If it exists, add new FTA document types. If not, create it.

Search for existing approval workflow models:
```bash
grep -n "ApprovalDocumentType\|approval_workflow" web-erp-app/backend/prisma/tenant-schema.prisma
```

Add or extend the ApprovalDocumentType enum to include FTA compliance document types:

```prisma
// Approval workflow document types
// Used to categorize workflows by document type
enum ApprovalDocumentType {
  // Existing document types (keep if already present)
  BILL
  CREDIT_NOTE
  DEBIT_NOTE
  RECEIPT_VOUCHER
  PAYMENT_VOUCHER
  JOURNAL_VOUCHER
  INVOICE

  // FTA Compliance document types (NEW)
  VAT_RETURN           // VAT return submission to FTA
  CT_RETURN            // Corporate Tax return
  PAYROLL              // WPS payroll processing
  COMPLIANCE_CONFIG    // TRN and compliance configuration changes
  EINVOICE_BATCH       // E-invoice batch submission
}
```

If approval_workflows and approval_workflow_levels models don't exist, create them:

```prisma
// Approval workflow configuration
// Defines multi-level approval chains for sensitive operations
model approval_workflows {
  id                     String                 @id @default(uuid())
  documentType           ApprovalDocumentType
  workflowName           String
  description            String?
  isActive               Boolean                @default(true)
  requireAllLevels       Boolean                @default(true) // All levels must approve
  allowSelfApproval      Boolean                @default(false)
  autoPostOnFinalApproval Boolean               @default(false) // Auto-post after final approval
  escalationDays         Int?                   @default(3) // Days before escalation
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt

  // Relations
  levels                 approval_workflow_levels[]

  @@unique([documentType]) // One active workflow per document type
  @@index([isActive])
}

// Approval workflow levels
// Defines each step in the approval chain
model approval_workflow_levels {
  id              String                @id @default(uuid())
  workflowId      String
  levelNumber     Int                   // Order of approval (1, 2, 3...)
  levelName       String                // Display name ("Finance Manager Review")
  approverType    ApproverType          // How approver is determined
  roleId          String?               // If approverType = ROLE
  specificUserId  String?               // If approverType = SPECIFIC_USER
  minAmount       Decimal?              @db.Decimal(15, 2) // Amount threshold (optional)
  maxAmount       Decimal?              @db.Decimal(15, 2) // Amount threshold (optional)
  isActive        Boolean               @default(true)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  // Relations
  workflow        approval_workflows    @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([workflowId, levelNumber])
  @@index([workflowId, isActive])
}

// Approver type for workflow levels
enum ApproverType {
  ROLE            // Any user with specified role
  SPECIFIC_USER   // Specific user ID
  ANY_APPROVER    // Any user with approval permission
}
```

NOTE: If these models already exist (check existing schema), only add the new enum values to ApprovalDocumentType.
  </action>
  <verify>
1. Run `npx prisma format --schema=web-erp-app/backend/prisma/tenant-schema.prisma`
2. Verify ApprovalDocumentType enum includes VAT_RETURN, CT_RETURN, PAYROLL, COMPLIANCE_CONFIG, EINVOICE_BATCH
3. If models were created, verify approval_workflows and approval_workflow_levels compile
  </verify>
  <done>
ApprovalDocumentType enum extended with 5 FTA compliance document types. If approval workflow models didn't exist, they are now created with full configuration options including multi-level approval, escalation, and amount thresholds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FTA approval workflow seed script</name>
  <files>
    web-erp-app/backend/prisma/seeds/workflows/fta-approval-workflows.seed.ts
  </files>
  <action>
Create a seed script that provisions FTA compliance approval workflows:

```typescript
/**
 * FTA Approval Workflows Seed
 * Phase: 02-internal-controls-audit
 * Requirement: CTRL-04 (approval workflows for key financial transactions)
 *
 * Creates pre-configured approval workflows for FTA-sensitive operations:
 * - VAT Return Submission: Accountant -> Finance Manager -> CFO
 * - Payroll Approval: HR Manager -> Finance Manager
 * - TRN Configuration Change: Compliance Officer -> CEO
 * - E-Invoice Batch: Accountant -> Finance Manager
 * - Corporate Tax Return: Accountant -> Finance Manager -> CFO
 */

import { PrismaClient, ApprovalDocumentType, ApproverType } from '@prisma/client';
import { randomUUID } from 'crypto';

const prisma = new PrismaClient();

/**
 * FTA Compliance Workflow Templates
 * These workflows ensure proper authorization for sensitive operations
 */
const FTA_WORKFLOW_TEMPLATES = [
  {
    documentType: 'VAT_RETURN' as ApprovalDocumentType,
    workflowName: 'VAT Return Submission Approval',
    description: 'Multi-level approval required before VAT return submission to FTA. Ensures accuracy and compliance.',
    requireAllLevels: true,
    allowSelfApproval: false,
    autoPostOnFinalApproval: false, // Manual submission to FTA
    escalationDays: 3,
    levels: [
      {
        levelNumber: 1,
        levelName: 'Accountant Preparation',
        approverType: 'ROLE' as ApproverType,
        roleName: 'ACCOUNTANT', // Will need to map to actual role ID
        description: 'Accountant verifies VAT calculations and data accuracy',
      },
      {
        levelNumber: 2,
        levelName: 'Finance Manager Review',
        approverType: 'ROLE' as ApproverType,
        roleName: 'FINANCE_MANAGER',
        description: 'Finance Manager reviews and validates VAT return',
      },
      {
        levelNumber: 3,
        levelName: 'CFO Final Approval',
        approverType: 'ROLE' as ApproverType,
        roleName: 'CFO',
        description: 'CFO gives final approval before FTA submission',
      },
    ],
  },
  {
    documentType: 'PAYROLL' as ApprovalDocumentType,
    workflowName: 'WPS Payroll Approval',
    description: 'Approval workflow for WPS salary payments. Ensures HR verification before finance processing.',
    requireAllLevels: true,
    allowSelfApproval: false,
    autoPostOnFinalApproval: true, // Auto-generate SIF after approval
    escalationDays: 2, // Tighter timeline for payroll
    levels: [
      {
        levelNumber: 1,
        levelName: 'HR Verification',
        approverType: 'ROLE' as ApproverType,
        roleName: 'HR_MANAGER',
        description: 'HR Manager verifies employee data and salary calculations',
      },
      {
        levelNumber: 2,
        levelName: 'Finance Approval',
        approverType: 'ROLE' as ApproverType,
        roleName: 'FINANCE_MANAGER',
        description: 'Finance Manager approves payroll funding',
      },
    ],
  },
  {
    documentType: 'COMPLIANCE_CONFIG' as ApprovalDocumentType,
    workflowName: 'TRN Configuration Change Approval',
    description: 'High-security approval for TRN and compliance configuration changes. Requires executive approval.',
    requireAllLevels: true,
    allowSelfApproval: false,
    autoPostOnFinalApproval: false,
    escalationDays: 5, // Longer timeline for compliance changes
    levels: [
      {
        levelNumber: 1,
        levelName: 'Compliance Officer Review',
        approverType: 'ROLE' as ApproverType,
        roleName: 'COMPLIANCE_OFFICER',
        description: 'Compliance Officer verifies regulatory requirements',
      },
      {
        levelNumber: 2,
        levelName: 'CEO Approval',
        approverType: 'ROLE' as ApproverType,
        roleName: 'CEO',
        description: 'CEO gives final approval for compliance configuration changes',
      },
    ],
  },
  {
    documentType: 'EINVOICE_BATCH' as ApprovalDocumentType,
    workflowName: 'E-Invoice Batch Submission',
    description: 'Approval for batch e-invoice transmission to DCTCE/ASP. Ensures data quality before submission.',
    requireAllLevels: true,
    allowSelfApproval: false,
    autoPostOnFinalApproval: true, // Auto-submit to ASP after approval
    escalationDays: 1, // Quick turnaround for e-invoicing
    levels: [
      {
        levelNumber: 1,
        levelName: 'Accountant Review',
        approverType: 'ROLE' as ApproverType,
        roleName: 'ACCOUNTANT',
        description: 'Accountant verifies invoice data and XML validation',
      },
      {
        levelNumber: 2,
        levelName: 'Finance Manager Approval',
        approverType: 'ROLE' as ApproverType,
        roleName: 'FINANCE_MANAGER',
        description: 'Finance Manager approves batch for transmission',
      },
    ],
  },
  {
    documentType: 'CT_RETURN' as ApprovalDocumentType,
    workflowName: 'Corporate Tax Return Approval',
    description: 'Multi-level approval for Corporate Tax return filing. Similar to VAT but annual frequency.',
    requireAllLevels: true,
    allowSelfApproval: false,
    autoPostOnFinalApproval: false,
    escalationDays: 5, // CT returns have more time
    levels: [
      {
        levelNumber: 1,
        levelName: 'Accountant Preparation',
        approverType: 'ROLE' as ApproverType,
        roleName: 'ACCOUNTANT',
        description: 'Accountant prepares CT calculations and adjustments',
      },
      {
        levelNumber: 2,
        levelName: 'Finance Manager Review',
        approverType: 'ROLE' as ApproverType,
        roleName: 'FINANCE_MANAGER',
        description: 'Finance Manager reviews taxable income and deductions',
      },
      {
        levelNumber: 3,
        levelName: 'CFO Final Approval',
        approverType: 'ROLE' as ApproverType,
        roleName: 'CFO',
        description: 'CFO approves CT return before filing',
      },
    ],
  },
];

/**
 * Role name to role ID mapping
 * In production, this would query the roles table
 * For seeding, we create placeholder UUIDs
 */
const ROLE_PLACEHOLDERS: Record<string, string> = {
  ACCOUNTANT: 'role-accountant-placeholder',
  FINANCE_MANAGER: 'role-finance-manager-placeholder',
  CFO: 'role-cfo-placeholder',
  HR_MANAGER: 'role-hr-manager-placeholder',
  COMPLIANCE_OFFICER: 'role-compliance-officer-placeholder',
  CEO: 'role-ceo-placeholder',
};

/**
 * Seeds FTA approval workflows for a tenant
 * Idempotent - can be run multiple times safely
 *
 * @param tenantPrisma - Prisma client connected to tenant database
 * @param roleMapping - Optional mapping of role names to actual role IDs
 */
export async function seedFtaApprovalWorkflows(
  tenantPrisma: PrismaClient = prisma,
  roleMapping?: Record<string, string>
): Promise<{
  workflowsCreated: number;
  levelsCreated: number;
  skipped: string[];
}> {
  const effectiveRoleMapping = roleMapping || ROLE_PLACEHOLDERS;
  const results = {
    workflowsCreated: 0,
    levelsCreated: 0,
    skipped: [] as string[],
  };

  console.log('[FTA Workflows] Starting seed...');

  for (const template of FTA_WORKFLOW_TEMPLATES) {
    try {
      // Check if workflow already exists
      const existing = await tenantPrisma.approval_workflows.findFirst({
        where: { documentType: template.documentType },
      });

      if (existing) {
        console.log(`[FTA Workflows] Skipping ${template.documentType} - already exists`);
        results.skipped.push(template.documentType);
        continue;
      }

      // Create workflow
      const workflowId = randomUUID();
      await tenantPrisma.approval_workflows.create({
        data: {
          id: workflowId,
          documentType: template.documentType,
          workflowName: template.workflowName,
          description: template.description,
          isActive: true,
          requireAllLevels: template.requireAllLevels,
          allowSelfApproval: template.allowSelfApproval,
          autoPostOnFinalApproval: template.autoPostOnFinalApproval,
          escalationDays: template.escalationDays,
        },
      });
      results.workflowsCreated++;

      // Create levels
      for (const level of template.levels) {
        const roleId = effectiveRoleMapping[level.roleName] || null;

        await tenantPrisma.approval_workflow_levels.create({
          data: {
            id: randomUUID(),
            workflowId,
            levelNumber: level.levelNumber,
            levelName: level.levelName,
            approverType: level.approverType,
            roleId,
            isActive: true,
          },
        });
        results.levelsCreated++;
      }

      console.log(`[FTA Workflows] Created ${template.documentType} with ${template.levels.length} levels`);
    } catch (error) {
      console.error(`[FTA Workflows] Failed to create ${template.documentType}:`, error);
      throw error;
    }
  }

  console.log('[FTA Workflows] Seed complete:', results);
  return results;
}

/**
 * Gets all FTA approval workflow templates
 * Useful for documentation and configuration UI
 */
export function getFtaWorkflowTemplates() {
  return FTA_WORKFLOW_TEMPLATES;
}

/**
 * Main function for standalone execution
 */
async function main() {
  console.log('='.repeat(60));
  console.log('FTA Approval Workflows Seed');
  console.log('Phase: 02-internal-controls-audit');
  console.log('Requirement: CTRL-04');
  console.log('='.repeat(60));

  try {
    const results = await seedFtaApprovalWorkflows();
    console.log('\nResults:');
    console.log(`  Workflows created: ${results.workflowsCreated}`);
    console.log(`  Levels created: ${results.levelsCreated}`);
    console.log(`  Skipped (existing): ${results.skipped.join(', ') || 'none'}`);
  } catch (error) {
    console.error('Seed failed:', error);
    process.exit(1);
  } finally {
    await prisma.$disconnect();
  }
}

// Run if executed directly
if (require.main === module) {
  main();
}
```

IMPORTANT: Create the directory first:
```bash
mkdir -p web-erp-app/backend/prisma/seeds/workflows
```
  </action>
  <verify>
1. File exists at prisma/seeds/workflows/fta-approval-workflows.seed.ts
2. TypeScript compiles: `npx tsc --noEmit prisma/seeds/workflows/fta-approval-workflows.seed.ts`
3. Exports seedFtaApprovalWorkflows function
4. Contains all 5 FTA workflow templates
  </verify>
  <done>
fta-approval-workflows.seed.ts created with 5 workflow templates: VAT_RETURN (3 levels), CT_RETURN (3 levels), PAYROLL (2 levels), COMPLIANCE_CONFIG (2 levels), EINVOICE_BATCH (2 levels). Total of 12 approval levels across all workflows. Script is idempotent and can be run multiple times safely.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add seed script to package.json and create index export</name>
  <files>
    web-erp-app/backend/package.json
    web-erp-app/backend/prisma/seeds/workflows/index.ts
  </files>
  <action>
1. Create an index file for the workflows seed directory:

```typescript
// web-erp-app/backend/prisma/seeds/workflows/index.ts
/**
 * Workflow Seeds Index
 * Exports all workflow seed functions
 */

export { seedFtaApprovalWorkflows, getFtaWorkflowTemplates } from './fta-approval-workflows.seed';
```

2. Add a script to package.json for running the seed (read package.json first, then add):

```json
{
  "scripts": {
    "seed:fta-workflows": "ts-node prisma/seeds/workflows/fta-approval-workflows.seed.ts"
  }
}
```

Add this script to the existing scripts section in package.json.
  </action>
  <verify>
1. Index file exists and exports seedFtaApprovalWorkflows
2. package.json contains seed:fta-workflows script
3. Can run: `npm run seed:fta-workflows --help` (or at least validate the script path)
  </verify>
  <done>
Seed script registered in package.json as `npm run seed:fta-workflows`. Index file exports all workflow seed functions for easy importing.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Schema validation:**
   ```bash
   cd web-erp-app/backend
   npx prisma format --schema=prisma/tenant-schema.prisma
   npx prisma validate --schema=prisma/tenant-schema.prisma
   ```

2. **Seed file compilation:**
   ```bash
   npx tsc --noEmit prisma/seeds/workflows/fta-approval-workflows.seed.ts
   ```

3. **Verify workflow templates:**
   - VAT_RETURN: 3 levels (Accountant -> Finance Manager -> CFO)
   - PAYROLL: 2 levels (HR Manager -> Finance Manager)
   - COMPLIANCE_CONFIG: 2 levels (Compliance Officer -> CEO)
   - CT_RETURN: 3 levels (Accountant -> Finance Manager -> CFO)
   - EINVOICE_BATCH: 2 levels (Accountant -> Finance Manager)

4. **Verify enum values:**
   ```bash
   grep -A10 "enum ApprovalDocumentType" prisma/tenant-schema.prisma
   ```
</verification>

<success_criteria>
1. ApprovalDocumentType enum includes 5 FTA document types
2. Seed script creates 5 workflow templates with appropriate approval levels
3. Workflows enforce proper authorization chains (no self-approval, multi-level)
4. Seed script is idempotent (safe to run multiple times)
5. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-internal-controls-audit/02-03-SUMMARY.md`

Include:
- Enum values added
- Workflows created (document type, levels, approvers)
- Seed script usage
- Any deviations from plan
</output>
