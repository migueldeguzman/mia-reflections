---
phase: 05-wps-payroll-compliance
plan: 04
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - web-erp-app/backend/src/services/payroll/wps-sif.service.ts
  - web-erp-app/backend/package.json
autonomous: true

must_haves:
  truths:
    - "SIF file contains EDR records for each employee"
    - "SIF file ends with SCR summary record"
    - "File name follows MOHRE format (13-digit employer ID + timestamp)"
    - "Amount format is exactly 2 decimal places without commas"
    - "Person codes are 14 digits with leading zero padding"
  artifacts:
    - path: "web-erp-app/backend/src/services/payroll/wps-sif.service.ts"
      provides: "SIF file generation service"
      exports: ["WpsSifService", "generateSifFile", "validateSifData"]
    - path: "web-erp-app/backend/package.json"
      provides: "csv-stringify dependency"
      contains: "csv-stringify"
  key_links:
    - from: "wps-sif.service.ts"
      to: "EmployeeSalaryRecord"
      via: "Prisma query"
      pattern: "employeeSalaryRecord"
    - from: "wps-sif.service.ts"
      to: "BankRoutingService"
      via: "DI injection"
      pattern: "TYPES\\.BankRoutingService"
---

<objective>
Create WPS SIF (Salary Information File) generation service that produces MOHRE-compliant CSV files with EDR (Employee Detail Records) and SCR (Salary Control Record).

Purpose: WPS-01 (SIF file generation) - Generate salary information files that pass MOHRE validation for WPS processing.

Output: WpsSifService with full SIF file generation capability.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-wps-payroll-compliance/05-RESEARCH.md
@.planning/phases/05-wps-payroll-compliance/05-01-SUMMARY.md
@.planning/phases/05-wps-payroll-compliance/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install csv-stringify dependency</name>
  <files>web-erp-app/backend/package.json</files>
  <action>
Install csv-stringify for SIF file generation:

```bash
cd web-erp-app/backend
npm install csv-stringify
```

The library provides:
- Streaming CSV generation
- Proper escaping of special characters
- Configurable delimiters and line endings

Note: csv-stringify is TypeScript-native in v6.x.
  </action>
  <verify>
    - `npm list csv-stringify` shows version 6.x
    - `import { stringify } from 'csv-stringify/sync'` resolves
  </verify>
  <done>csv-stringify installed for SIF file generation</done>
</task>

<task type="auto">
  <name>Task 2: Create WPS SIF service</name>
  <files>web-erp-app/backend/src/services/payroll/wps-sif.service.ts</files>
  <action>
Create WpsSifService for SIF file generation:

```typescript
/**
 * WPS SIF (Salary Information File) Service
 *
 * Generates MOHRE-compliant Salary Information Files for WPS processing.
 *
 * SIF Format:
 * - Multiple EDR (Employee Detail Record) rows
 * - One SCR (Salary Control Record) row at the end
 * - CSV format with comma delimiter
 * - File naming: EEEEEEEEEEEEEYYMMDDHHMMSS.SIF
 *
 * References:
 * - MOHRE WPS specifications
 * - NOW Money SIF Guide
 * - Bayzat SIF Guide
 *
 * @module WpsSifService
 */

import { PrismaClient } from '@prisma/client';
import { Decimal } from '@prisma/client/runtime/library';
import { injectable, inject } from 'inversify';
import { TYPES } from '../../config/types';
import { stringify } from 'csv-stringify/sync';
import logger from '../logger.service';
import { BankRoutingService } from './bank-routing.service';
import {
  PayrollCycleStatus,
  EdrRecord,
  ScrRecord,
  SifGenerationResult,
  SifValidationError,
  EMPLOYER_ID_LENGTH,
  PERSON_CODE_LENGTH,
  ROUTING_CODE_LENGTH,
} from '../../types/payroll/wps.types';

// ============================================
// CONSTANTS
// ============================================

const SIF_DATE_FORMAT = 'YYYY-MM-DD';
const SIF_MONTH_FORMAT = 'MMYYYY';
const SIF_CURRENCY = 'AED';

// ============================================
// TYPES
// ============================================

export interface SifEmployeeData {
  personCode: string;
  employeeName: string;
  iban: string;
  bankRoutingCode: string;
  basicSalary: Decimal;
  housingAllowance: Decimal;
  transportAllowance: Decimal;
  otherAllowances: Decimal;
  overtime: Decimal;
  deductions: Decimal;
  netSalary: Decimal;
  totalDays: number;
  leaveDays: number;
}

export interface SifEmployerData {
  molEstablishmentId: string;  // 13-digit MOL establishment ID
  employerRoutingCode: string; // 9-digit employer bank routing code
  employerReference?: string;  // Optional reference for this file
}

export interface SifContext {
  companyId: string;
  userId: string;
}

// ============================================
// SERVICE
// ============================================

@injectable()
export class WpsSifService {
  constructor(
    @inject(TYPES.PrismaClient) private prisma: PrismaClient,
    @inject(TYPES.BankRoutingService) private bankRoutingService: BankRoutingService
  ) {}

  /**
   * Generate SIF file for a payroll cycle
   *
   * @param context - User context for audit
   * @param payrollCycleId - ID of payroll cycle to generate SIF for
   * @returns SIF file content and metadata
   */
  async generateSifFile(
    context: SifContext,
    payrollCycleId: string
  ): Promise<SifGenerationResult> {
    // Load payroll cycle with salary records
    const cycle = await this.prisma.payrollCycle.findUnique({
      where: { id: payrollCycleId },
      include: {
        salaryRecords: {
          where: { isActive: true },
          orderBy: { personCode: 'asc' },
        },
      },
    });

    if (!cycle) {
      throw new Error('Payroll cycle not found');
    }

    if (cycle.companyId !== context.companyId) {
      throw new Error('Access denied: Cannot access payroll from other companies');
    }

    if (cycle.salaryRecords.length === 0) {
      throw new Error('No active salary records in payroll cycle');
    }

    // Load employer WPS config
    const complianceConfig = await this.prisma.$queryRaw<any[]>`
      SELECT "molEstablishmentId", "wpsAgentId"
      FROM tenant_compliance_config
      LIMIT 1
    `;

    if (!complianceConfig.length || !complianceConfig[0].molEstablishmentId) {
      throw new Error('Company WPS configuration incomplete. Set MOL Establishment ID.');
    }

    const molEstablishmentId = complianceConfig[0].molEstablishmentId;
    const wpsAgentId = complianceConfig[0].wpsAgentId;

    // Get employer routing code
    let employerRoutingCode = '000000000'; // Default placeholder
    if (wpsAgentId) {
      const agent = await this.bankRoutingService.getWpsAgentByBankCode(wpsAgentId);
      if (agent) {
        employerRoutingCode = agent.routingCode;
      }
    }

    // Generate timestamp for file name and SCR
    const timestamp = new Date();
    const fileName = this.generateFileName(molEstablishmentId, timestamp);

    // Convert salary records to EDR records
    const edrRecords: string[] = [];
    let totalAmount = new Decimal(0);

    for (const record of cycle.salaryRecords) {
      const edr = this.formatEdrRecord({
        personCode: record.personCode,
        employeeName: record.employeeName,
        iban: record.iban,
        bankRoutingCode: record.bankRoutingCode,
        basicSalary: record.basicSalary,
        housingAllowance: record.housingAllowance,
        transportAllowance: record.transportAllowance,
        otherAllowances: record.otherAllowances,
        overtime: record.overtime,
        deductions: record.deductions,
        netSalary: record.netSalary,
        totalDays: record.totalDays,
        leaveDays: record.leaveDays,
      }, cycle.payPeriodStart, cycle.payPeriodEnd);

      edrRecords.push(edr);
      totalAmount = totalAmount.add(record.netSalary);
    }

    // Generate SCR record
    const scr = this.formatScrRecord({
      molEstablishmentId,
      employerRoutingCode,
      employerReference: `SAL-${cycle.cycleNumber}`,
    }, timestamp, cycle.salaryMonth, cycle.salaryRecords.length, totalAmount);

    // Combine into SIF content
    const content = [...edrRecords, scr].join('\n');

    // Update payroll cycle with SIF info
    await this.prisma.payrollCycle.update({
      where: { id: payrollCycleId },
      data: {
        sifFileName: fileName,
        sifGeneratedAt: timestamp,
        employeeCount: cycle.salaryRecords.length,
        totalAmount,
        status: PayrollCycleStatus.READY,
        updatedAt: new Date(),
      },
    });

    logger.audit('[WPS-SIF] SIF file generated', {
      userId: context.userId,
      companyId: context.companyId,
      payrollCycleId,
      fileName,
      employeeCount: cycle.salaryRecords.length,
      totalAmount: totalAmount.toFixed(2),
    });

    return {
      fileName,
      content,
      employeeCount: cycle.salaryRecords.length,
      totalAmount,
      createdAt: timestamp,
    };
  }

  /**
   * Generate SIF file name per MOHRE format
   *
   * Format: EEEEEEEEEEEEEYYMMDDHHMMSS.SIF
   * - E = Employer Unique ID (13 digits, left-padded with zeros)
   * - YY = Year (2 digits)
   * - MM = Month
   * - DD = Day
   * - HH = Hour (24-hour)
   * - MM = Minute
   * - SS = Second
   *
   * @param employerId - MOL establishment ID
   * @param timestamp - File creation timestamp
   * @returns File name in MOHRE format
   */
  generateFileName(employerId: string, timestamp: Date): string {
    const paddedId = employerId.padStart(EMPLOYER_ID_LENGTH, '0');
    const year = timestamp.getFullYear().toString().slice(-2);
    const month = (timestamp.getMonth() + 1).toString().padStart(2, '0');
    const day = timestamp.getDate().toString().padStart(2, '0');
    const hour = timestamp.getHours().toString().padStart(2, '0');
    const minute = timestamp.getMinutes().toString().padStart(2, '0');
    const second = timestamp.getSeconds().toString().padStart(2, '0');

    return `${paddedId}${year}${month}${day}${hour}${minute}${second}.SIF`;
  }

  /**
   * Format EDR (Employee Detail Record)
   *
   * EDR fields:
   * 1. Record Type: "EDR"
   * 2. Person Code: 14-digit MOHRE employee ID
   * 3. Agent ID: 9-digit bank routing code
   * 4. IBAN: 23-digit UAE IBAN
   * 5. Pay Start Date: YYYY-MM-DD
   * 6. Pay End Date: YYYY-MM-DD
   * 7. Total Days: Days in period
   * 8. Fixed Salary: Basic + allowances (no commas, 2 decimals)
   * 9. Variable Salary: Overtime - deductions (no commas, 2 decimals)
   * 10. Leave Days: Days on leave
   *
   * @param employee - Employee salary data
   * @param payStart - Pay period start date
   * @param payEnd - Pay period end date
   * @returns Formatted EDR CSV row
   */
  formatEdrRecord(
    employee: SifEmployeeData,
    payStart: Date,
    payEnd: Date
  ): string {
    // Calculate fixed salary (basic + allowances)
    const fixedSalary = new Decimal(employee.basicSalary)
      .add(employee.housingAllowance)
      .add(employee.transportAllowance)
      .add(employee.otherAllowances);

    // Calculate variable salary (overtime - deductions)
    const variableSalary = new Decimal(employee.overtime)
      .sub(employee.deductions);

    const fields = [
      'EDR',
      employee.personCode.padStart(PERSON_CODE_LENGTH, '0'),
      employee.bankRoutingCode.padStart(ROUTING_CODE_LENGTH, '0'),
      employee.iban,
      this.formatDate(payStart),
      this.formatDate(payEnd),
      employee.totalDays.toString(),
      this.formatAmount(fixedSalary),
      this.formatAmount(variableSalary),
      employee.leaveDays.toString(),
    ];

    return fields.join(',');
  }

  /**
   * Format SCR (Salary Control Record)
   *
   * SCR fields:
   * 1. Record Type: "SCR"
   * 2. Employer Unique ID: 13-digit MOL establishment ID
   * 3. Agent ID: 9-digit employer bank routing code
   * 4. File Creation Date: YYYY-MM-DD
   * 5. File Creation Time: HHMM
   * 6. Salary Month: MMYYYY
   * 7. Record Count: Number of EDR records (2 digits)
   * 8. Total Amount: Sum of all salaries (no commas, 2 decimals)
   * 9. Currency: AED
   * 10. Employer Reference: Optional reference
   *
   * @param employer - Employer WPS config
   * @param timestamp - File creation timestamp
   * @param salaryMonth - Salary month in MMYYYY format
   * @param recordCount - Number of EDR records
   * @param totalAmount - Total salary amount
   * @returns Formatted SCR CSV row
   */
  formatScrRecord(
    employer: SifEmployerData,
    timestamp: Date,
    salaryMonth: string,
    recordCount: number,
    totalAmount: Decimal
  ): string {
    const fields = [
      'SCR',
      employer.molEstablishmentId.padStart(EMPLOYER_ID_LENGTH, '0'),
      employer.employerRoutingCode.padStart(ROUTING_CODE_LENGTH, '0'),
      this.formatDate(timestamp),
      this.formatTime(timestamp),
      salaryMonth,
      recordCount.toString().padStart(2, '0'),
      this.formatAmount(totalAmount),
      SIF_CURRENCY,
      employer.employerReference || '',
    ];

    return fields.join(',');
  }

  /**
   * Format date as YYYY-MM-DD
   */
  private formatDate(date: Date): string {
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  /**
   * Format time as HHMM (24-hour)
   */
  private formatTime(date: Date): string {
    const hour = date.getHours().toString().padStart(2, '0');
    const minute = date.getMinutes().toString().padStart(2, '0');
    return `${hour}${minute}`;
  }

  /**
   * Format amount for SIF (no commas, exactly 2 decimal places)
   */
  private formatAmount(amount: Decimal): string {
    return amount.toFixed(2);
  }

  /**
   * Validate salary record data before SIF generation
   *
   * Checks:
   * - Person code is 14 digits
   * - IBAN is valid UAE format
   * - Routing code is 9 digits
   * - Amounts are positive
   *
   * @param employees - Employee salary data
   * @returns Array of validation errors
   */
  validateSifData(employees: SifEmployeeData[]): SifValidationError[] {
    const errors: SifValidationError[] = [];

    for (const emp of employees) {
      // Person code validation
      if (!emp.personCode || emp.personCode.replace(/\D/g, '').length > PERSON_CODE_LENGTH) {
        errors.push({
          field: 'personCode',
          employeeId: emp.personCode,
          message: `Person code must be up to ${PERSON_CODE_LENGTH} digits`,
          severity: 'ERROR',
        });
      }

      // IBAN validation
      if (!emp.iban || emp.iban.length !== 23 || !emp.iban.startsWith('AE')) {
        errors.push({
          field: 'iban',
          employeeId: emp.personCode,
          message: 'Invalid UAE IBAN (must be 23 characters starting with AE)',
          severity: 'ERROR',
        });
      }

      // Routing code validation
      if (!emp.bankRoutingCode || emp.bankRoutingCode.length !== ROUTING_CODE_LENGTH) {
        errors.push({
          field: 'bankRoutingCode',
          employeeId: emp.personCode,
          message: `Bank routing code must be ${ROUTING_CODE_LENGTH} digits`,
          severity: 'ERROR',
        });
      }

      // Net salary validation
      if (emp.netSalary.lessThanOrEqualTo(0)) {
        errors.push({
          field: 'netSalary',
          employeeId: emp.personCode,
          message: 'Net salary must be greater than zero',
          severity: 'ERROR',
        });
      }
    }

    return errors;
  }

  /**
   * Parse SIF file content for validation
   *
   * @param content - SIF file content
   * @returns Parsed EDR and SCR records
   */
  parseSifContent(content: string): {
    edrRecords: Partial<EdrRecord>[];
    scrRecord: Partial<ScrRecord> | null;
  } {
    const lines = content.split('\n').filter(line => line.trim());
    const edrRecords: Partial<EdrRecord>[] = [];
    let scrRecord: Partial<ScrRecord> | null = null;

    for (const line of lines) {
      const fields = line.split(',');

      if (fields[0] === 'EDR') {
        edrRecords.push({
          recordType: 'EDR',
          personCode: fields[1],
          agentId: fields[2],
          iban: fields[3],
          payStartDate: fields[4],
          payEndDate: fields[5],
          totalDays: parseInt(fields[6], 10),
          fixedSalary: fields[7],
          variableSalary: fields[8],
          leaveDays: parseInt(fields[9], 10),
        });
      } else if (fields[0] === 'SCR') {
        scrRecord = {
          recordType: 'SCR',
          employerUniqueId: fields[1],
          agentId: fields[2],
          fileCreationDate: fields[3],
          fileCreationTime: fields[4],
          salaryMonth: fields[5],
          recordCount: parseInt(fields[6], 10),
          totalAmount: fields[7],
          currency: fields[8] as 'AED',
          employerRef: fields[9],
        };
      }
    }

    return { edrRecords, scrRecord };
  }

  /**
   * Verify SIF file integrity
   *
   * Checks:
   * - SCR record count matches EDR count
   * - SCR total matches sum of EDR salaries
   * - File name timestamp matches SCR timestamp
   *
   * @param content - SIF file content
   * @param fileName - SIF file name
   * @returns Validation result
   */
  verifySifIntegrity(content: string, fileName: string): {
    isValid: boolean;
    errors: string[];
  } {
    const errors: string[] = [];
    const { edrRecords, scrRecord } = this.parseSifContent(content);

    if (!scrRecord) {
      errors.push('Missing SCR (Salary Control Record)');
      return { isValid: false, errors };
    }

    // Check record count
    if (scrRecord.recordCount !== edrRecords.length) {
      errors.push(
        `SCR record count (${scrRecord.recordCount}) does not match EDR count (${edrRecords.length})`
      );
    }

    // Check total amount
    const calculatedTotal = edrRecords.reduce((sum, edr) => {
      const fixed = parseFloat(edr.fixedSalary || '0');
      const variable = parseFloat(edr.variableSalary || '0');
      return sum + fixed + variable;
    }, 0);

    const scrTotal = parseFloat(scrRecord.totalAmount || '0');
    if (Math.abs(calculatedTotal - scrTotal) > 0.01) {
      errors.push(
        `SCR total (${scrTotal}) does not match calculated total (${calculatedTotal})`
      );
    }

    return { isValid: errors.length === 0, errors };
  }
}
```
  </action>
  <verify>
    - `npx tsc --noEmit` compiles successfully
    - generateFileName produces correct format
    - formatEdrRecord produces valid CSV row
    - formatScrRecord produces valid CSV row
  </verify>
  <done>WpsSifService created with full SIF file generation capability</done>
</task>

<task type="auto">
  <name>Task 3: Add WpsSifService to DI container</name>
  <files>web-erp-app/backend/src/config/types.ts, web-erp-app/backend/src/config/container.ts</files>
  <action>
1. Add WpsSifService symbol to types.ts:
   ```typescript
   WpsSifService: Symbol.for('WpsSifService'),
   ```

2. Register in container.ts:
   ```typescript
   import { WpsSifService } from '../services/payroll/wps-sif.service';

   container.bind<WpsSifService>(TYPES.WpsSifService)
     .to(WpsSifService)
     .inSingletonScope();
   ```
  </action>
  <verify>
    - Service resolves from container
    - Dependencies (PrismaClient, BankRoutingService) inject correctly
  </verify>
  <done>WpsSifService registered in DI container</done>
</task>

</tasks>

<verification>
1. csv-stringify installed: `npm list csv-stringify`
2. Service compiles: `npx tsc --noEmit`
3. File name format: `generateFileName('330000', new Date())` returns `0000000330000YYMMDDHHMMSS.SIF`
4. EDR format: Person code padded to 14 digits, amounts with 2 decimals
5. SCR format: Employer ID padded to 13 digits, totals match
6. Validation catches invalid data: Person code > 14 digits, invalid IBAN
</verification>

<success_criteria>
1. SIF file contains EDR records for each active employee in payroll cycle
2. SIF file ends with single SCR summary record
3. File name follows MOHRE format (EEEEEEEEEEEEEYYMMDDHHMMSS.SIF)
4. Amount format is exactly 2 decimal places without commas (1234.56, not 1,234.56)
5. Person codes padded to 14 digits with leading zeros
6. Routing codes are 9 digits
7. validateSifData catches common errors before file generation
8. verifySifIntegrity can validate generated files
</success_criteria>

<output>
After completion, create `.planning/phases/05-wps-payroll-compliance/05-04-SUMMARY.md`
</output>
