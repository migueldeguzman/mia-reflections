---
phase: 05-wps-payroll-compliance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web-erp-app/backend/prisma/schema.prisma
  - web-erp-app/backend/src/types/payroll/wps.types.ts
autonomous: true

must_haves:
  truths:
    - "WPS schema supports complete SIF file generation workflow"
    - "Employee salary records track MOHRE Person Code and IBAN"
    - "Salary cycles have state machine status tracking"
    - "WPS agents reference table stores bank routing codes"
    - "WPS submission history maintains audit trail"
  artifacts:
    - path: "web-erp-app/backend/prisma/schema.prisma"
      provides: "WPS models (PayrollCycle, EmployeeSalaryRecord, WpsAgent, WpsSubmission, WpsError)"
      contains: "model PayrollCycle"
    - path: "web-erp-app/backend/src/types/payroll/wps.types.ts"
      provides: "TypeScript interfaces for WPS domain"
      exports: ["PayrollCycleStatus", "SifRecord", "EdrRecord", "ScrRecord"]
  key_links:
    - from: "PayrollCycle"
      to: "EmployeeSalaryRecord"
      via: "one-to-many relation"
      pattern: "payrollCycleId.*PayrollCycle"
    - from: "WpsSubmission"
      to: "PayrollCycle"
      via: "submission tracking"
      pattern: "payrollCycleId"
---

<objective>
Create the WPS payroll schema foundation with models for salary cycles, employee salary records, WPS agents (bank routing codes), submissions, and error tracking.

Purpose: Establish database structure for WPS-compliant payroll processing including MOHRE Person Code, IBAN storage, and salary cycle state machine.

Output: Prisma schema extensions and TypeScript type definitions for WPS domain.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-wps-payroll-compliance/05-RESEARCH.md
@web-erp-app/backend/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WPS TypeScript types</name>
  <files>web-erp-app/backend/src/types/payroll/wps.types.ts</files>
  <action>
Create TypeScript types for WPS domain:

1. **Enums:**
   - `PayrollCycleStatus`: DRAFT, PROCESSING, READY, SUBMITTED, ACCEPTED, REJECTED, COMPLETED, CANCELLED
   - `WpsRecordType`: EDR (Employee Detail Record), SCR (Salary Control Record)
   - `WpsErrorSeverity`: ERROR, WARNING, INFO

2. **Interfaces:**
   - `EdrRecord`: Person code (14 digits), agent ID (9 digits), IBAN (23 chars), pay dates, amounts
   - `ScrRecord`: Employer unique ID (13 digits), file creation timestamp, salary month, totals
   - `SifGenerationResult`: fileName, content, employeeCount, totalAmount, createdAt
   - `WpsValidationError`: errorCode, field, message, severity
   - `EmployeeSalaryInput`: employeeId, basicSalary, variableSalary, deductions, etc.

3. **State machine transitions:**
   ```typescript
   const CYCLE_TRANSITIONS: Record<PayrollCycleStatus, PayrollCycleStatus[]> = {
     DRAFT: ['PROCESSING', 'CANCELLED'],
     PROCESSING: ['READY', 'DRAFT'],
     READY: ['SUBMITTED', 'DRAFT'],
     SUBMITTED: ['ACCEPTED', 'REJECTED'],
     REJECTED: ['DRAFT'],
     ACCEPTED: ['COMPLETED'],
     COMPLETED: [],
     CANCELLED: []
   };
   ```

4. **SIF format constants:**
   - EMPLOYER_ID_LENGTH = 13
   - PERSON_CODE_LENGTH = 14
   - ROUTING_CODE_LENGTH = 9
   - UAE_IBAN_LENGTH = 23

Follow existing types pattern in `src/types/compliance/uae-compliance.types.ts`.
  </action>
  <verify>File compiles without errors: `npx tsc --noEmit`</verify>
  <done>WPS TypeScript types exported and usable by services</done>
</task>

<task type="auto">
  <name>Task 2: Add WPS schema models to Prisma</name>
  <files>web-erp-app/backend/prisma/schema.prisma</files>
  <action>
Add WPS-related models to the Prisma schema:

1. **PayrollCycle model:**
   ```prisma
   model PayrollCycle {
     id                String   @id @default(uuid())
     companyId         String   @map("company_id")
     cycleNumber       String   @map("cycle_number")        // e.g., "2026-01"
     salaryMonth       String   @map("salary_month")        // MMYYYY format
     payPeriodStart    DateTime @map("pay_period_start")
     payPeriodEnd      DateTime @map("pay_period_end")
     status            String   @default("DRAFT")           // PayrollCycleStatus enum
     employeeCount     Int      @default(0) @map("employee_count")
     totalAmount       Decimal  @default(0) @db.Decimal(15, 2) @map("total_amount")
     sifFileName       String?  @map("sif_file_name")
     sifGeneratedAt    DateTime? @map("sif_generated_at")
     submittedAt       DateTime? @map("submitted_at")
     acceptedAt        DateTime? @map("accepted_at")
     rejectedAt        DateTime? @map("rejected_at")
     completedAt       DateTime? @map("completed_at")
     notes             String?
     createdById       String   @map("created_by_id")
     createdAt         DateTime @default(now()) @map("created_at")
     updatedAt         DateTime @updatedAt @map("updated_at")

     salaryRecords     EmployeeSalaryRecord[]
     submissions       WpsSubmission[]

     @@unique([companyId, cycleNumber])
     @@index([companyId, status])
     @@map("payroll_cycles")
   }
   ```

2. **EmployeeSalaryRecord model:**
   ```prisma
   model EmployeeSalaryRecord {
     id                String   @id @default(uuid())
     payrollCycleId    String   @map("payroll_cycle_id")
     employeeId        String   @map("employee_id")
     personCode        String   @map("person_code")         // 14-digit MOHRE ID
     employeeName      String   @map("employee_name")
     iban              String                               // 23-char UAE IBAN
     bankRoutingCode   String   @map("bank_routing_code")   // 9-digit routing code
     basicSalary       Decimal  @db.Decimal(15, 2) @map("basic_salary")
     housingAllowance  Decimal  @default(0) @db.Decimal(15, 2) @map("housing_allowance")
     transportAllowance Decimal @default(0) @db.Decimal(15, 2) @map("transport_allowance")
     otherAllowances   Decimal  @default(0) @db.Decimal(15, 2) @map("other_allowances")
     overtime          Decimal  @default(0) @db.Decimal(15, 2)
     deductions        Decimal  @default(0) @db.Decimal(15, 2)
     netSalary         Decimal  @db.Decimal(15, 2) @map("net_salary")
     totalDays         Int      @default(30) @map("total_days")
     leaveDays         Int      @default(0) @map("leave_days")
     unpaidLeaveDays   Int      @default(0) @map("unpaid_leave_days")
     isActive          Boolean  @default(true) @map("is_active")
     validationErrors  Json?    @map("validation_errors")
     createdAt         DateTime @default(now()) @map("created_at")
     updatedAt         DateTime @updatedAt @map("updated_at")

     payrollCycle      PayrollCycle @relation(fields: [payrollCycleId], references: [id])

     @@unique([payrollCycleId, employeeId])
     @@index([payrollCycleId])
     @@index([personCode])
     @@map("employee_salary_records")
   }
   ```

3. **WpsAgent model (reference table):**
   ```prisma
   model WpsAgent {
     id              String   @id @default(uuid())
     bankCode        String   @unique @map("bank_code")     // 3-digit bank identifier
     routingCode     String   @unique @map("routing_code")  // 9-digit WPS routing code
     bankName        String   @map("bank_name")
     bankNameArabic  String?  @map("bank_name_arabic")
     swiftCode       String?  @map("swift_code")
     isActive        Boolean  @default(true) @map("is_active")
     effectiveFrom   DateTime @default(now()) @map("effective_from")
     effectiveTo     DateTime? @map("effective_to")
     createdAt       DateTime @default(now()) @map("created_at")
     updatedAt       DateTime @updatedAt @map("updated_at")

     @@index([isActive])
     @@map("wps_agents")
   }
   ```

4. **WpsSubmission model:**
   ```prisma
   model WpsSubmission {
     id                String   @id @default(uuid())
     payrollCycleId    String   @map("payroll_cycle_id")
     companyId         String   @map("company_id")
     sifFileName       String   @map("sif_file_name")
     sifContent        String?  @map("sif_content")         // Store for audit
     employeeCount     Int      @map("employee_count")
     totalAmount       Decimal  @db.Decimal(15, 2) @map("total_amount")
     submittedAt       DateTime @map("submitted_at")
     submittedById     String   @map("submitted_by_id")
     status            String   @default("PENDING")         // PENDING, ACCEPTED, REJECTED
     mohreResponse     Json?    @map("mohre_response")
     acceptedAt        DateTime? @map("accepted_at")
     rejectedAt        DateTime? @map("rejected_at")
     rejectionReason   String?  @map("rejection_reason")
     createdAt         DateTime @default(now()) @map("created_at")

     payrollCycle      PayrollCycle @relation(fields: [payrollCycleId], references: [id])
     errors            WpsError[]

     @@index([companyId, submittedAt])
     @@map("wps_submissions")
   }
   ```

5. **WpsError model:**
   ```prisma
   model WpsError {
     id              String   @id @default(uuid())
     submissionId    String   @map("submission_id")
     errorCode       String   @map("error_code")
     errorMessage    String   @map("error_message")
     field           String?
     employeeId      String?  @map("employee_id")
     personCode      String?  @map("person_code")
     severity        String   @default("ERROR")            // ERROR, WARNING, INFO
     isResolved      Boolean  @default(false) @map("is_resolved")
     resolvedAt      DateTime? @map("resolved_at")
     resolvedById    String?  @map("resolved_by_id")
     resolution      String?
     createdAt       DateTime @default(now()) @map("created_at")

     submission      WpsSubmission @relation(fields: [submissionId], references: [id])

     @@index([submissionId])
     @@index([errorCode])
     @@index([isResolved])
     @@map("wps_errors")
   }
   ```

Ensure models follow existing Prisma schema conventions with @map for snake_case column names.
  </action>
  <verify>
    - `npx prisma validate` passes
    - `npx prisma generate` succeeds
  </verify>
  <done>WPS schema models added to Prisma, ready for migration</done>
</task>

<task type="auto">
  <name>Task 3: Create WPS schema migration</name>
  <files>web-erp-app/backend/prisma/migrations/</files>
  <action>
Generate and review the Prisma migration for WPS tables:

1. Run migration command:
   ```bash
   npx prisma migrate dev --name add_wps_payroll_schema --create-only
   ```

2. Review generated migration SQL:
   - Verify table names use snake_case
   - Verify foreign key constraints
   - Verify unique constraints (companyId + cycleNumber)
   - Verify indexes for common queries

3. Add WPS_AGENTS seed data to the migration (or create separate seed):
   - Major UAE banks with WPS routing codes
   - At least 10 common banks (ENBD, ADCB, FAB, Mashreq, DIB, RAK Bank, etc.)

4. Apply migration:
   ```bash
   npx prisma migrate dev
   ```

5. Regenerate Prisma client:
   ```bash
   npx prisma generate
   ```
  </action>
  <verify>
    - Migration applies successfully
    - `npx prisma db pull` shows new tables
    - Prisma client regenerated with new models
  </verify>
  <done>WPS schema migration created and applied</done>
</task>

</tasks>

<verification>
1. TypeScript types compile: `npx tsc --noEmit`
2. Prisma schema valid: `npx prisma validate`
3. Migration applied: Tables exist in database
4. Types importable: Can import from `@/types/payroll/wps.types`
</verification>

<success_criteria>
1. PayrollCycle, EmployeeSalaryRecord, WpsAgent, WpsSubmission, WpsError models exist in schema
2. TypeScript interfaces match Prisma models for type safety
3. State machine transitions defined for PayrollCycleStatus
4. SIF format constants defined (field lengths, formats)
5. Database migration applied successfully
</success_criteria>

<output>
After completion, create `.planning/phases/05-wps-payroll-compliance/05-01-SUMMARY.md`
</output>
