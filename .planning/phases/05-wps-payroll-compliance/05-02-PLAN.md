---
phase: 05-wps-payroll-compliance
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - web-erp-app/backend/src/utils/iban-validation.util.ts
  - web-erp-app/backend/package.json
autonomous: true

must_haves:
  truths:
    - "IBAN validation uses ibantools library for MOD-97 checksum"
    - "UAE IBAN format enforced (AE prefix, 23 characters)"
    - "Bank code extracted from valid IBAN"
    - "Detailed validation errors returned for invalid IBANs"
  artifacts:
    - path: "web-erp-app/backend/src/utils/iban-validation.util.ts"
      provides: "UAE IBAN validation utility"
      exports: ["validateUaeIban", "formatIban", "extractBankCode", "IbanValidationResult"]
    - path: "web-erp-app/backend/package.json"
      provides: "ibantools dependency"
      contains: "ibantools"
  key_links:
    - from: "iban-validation.util.ts"
      to: "ibantools"
      via: "library import"
      pattern: "from 'ibantools'"
---

<objective>
Create IBAN validation utility for UAE bank accounts using the ibantools library. This utility validates UAE IBAN format (AE prefix, 23 characters, MOD-97 checksum) and extracts bank codes.

Purpose: Ensure all employee IBANs are valid before SIF file generation, preventing MOHRE rejections due to invalid bank account numbers.

Output: IBAN validation utility with comprehensive error reporting.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-wps-payroll-compliance/05-RESEARCH.md
@web-erp-app/backend/src/utils/decimal-math.util.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install ibantools dependency</name>
  <files>web-erp-app/backend/package.json</files>
  <action>
Install the ibantools library for IBAN validation:

```bash
cd web-erp-app/backend
npm install ibantools
```

The library provides:
- `validateIBAN()` - Full IBAN validation with MOD-97 checksum
- `electronicFormatIBAN()` - Removes spaces, converts to uppercase
- `ValidationErrorsIBAN` - Enum of validation error codes

Note: ibantools is TypeScript-native, no @types needed.
  </action>
  <verify>
    - `npm list ibantools` shows version 4.x or 5.x
    - `import { validateIBAN } from 'ibantools'` resolves
  </verify>
  <done>ibantools installed and available for import</done>
</task>

<task type="auto">
  <name>Task 2: Create IBAN validation utility</name>
  <files>web-erp-app/backend/src/utils/iban-validation.util.ts</files>
  <action>
Create IBAN validation utility with UAE-specific rules:

```typescript
/**
 * UAE IBAN Validation Utility
 *
 * Validates UAE bank IBANs for WPS compliance.
 *
 * UAE IBAN Format:
 * - Total length: 23 characters
 * - Country code: AE (positions 1-2)
 * - Check digits: 2 digits (positions 3-4)
 * - Bank code: 3 digits (positions 5-7)
 * - Account number: 16 digits (positions 8-23)
 *
 * Example: AE070331234567890123456
 *
 * @module iban-validation.util
 */

import {
  validateIBAN,
  electronicFormatIBAN,
  ValidationErrorsIBAN,
} from 'ibantools';

// ============================================
// CONSTANTS
// ============================================

export const UAE_COUNTRY_CODE = 'AE';
export const UAE_IBAN_LENGTH = 23;
export const UAE_BANK_CODE_START = 4;  // 0-indexed
export const UAE_BANK_CODE_LENGTH = 3;

// ============================================
// TYPES
// ============================================

export interface IbanValidationResult {
  isValid: boolean;
  iban: string;          // Electronic format (no spaces)
  ibanFormatted: string; // Pretty format with spaces (AE07 0331 2345 6789 0123 456)
  bankCode: string | null;
  errors: IbanValidationError[];
}

export interface IbanValidationError {
  code: string;
  message: string;
}

// ============================================
// VALIDATION FUNCTIONS
// ============================================

/**
 * Validate a UAE IBAN
 *
 * Performs the following validations:
 * 1. Format check (remove spaces, uppercase)
 * 2. Country code check (must be AE)
 * 3. Length check (must be 23 characters)
 * 4. MOD-97 checksum validation
 *
 * @param rawIban - IBAN string (may include spaces)
 * @returns Validation result with cleaned IBAN and any errors
 */
export function validateUaeIban(rawIban: string): IbanValidationResult {
  const errors: IbanValidationError[] = [];

  // Step 1: Clean and format IBAN
  const iban = electronicFormatIBAN(rawIban) || '';

  // Step 2: Check if empty
  if (!iban) {
    return {
      isValid: false,
      iban: '',
      ibanFormatted: '',
      bankCode: null,
      errors: [{ code: 'EMPTY_IBAN', message: 'IBAN is required' }],
    };
  }

  // Step 3: Check UAE country code
  if (!iban.startsWith(UAE_COUNTRY_CODE)) {
    errors.push({
      code: 'INVALID_COUNTRY',
      message: `IBAN must be UAE (AE prefix). Got: ${iban.substring(0, 2)}`,
    });
  }

  // Step 4: Check length
  if (iban.length !== UAE_IBAN_LENGTH) {
    errors.push({
      code: 'INVALID_LENGTH',
      message: `UAE IBAN must be ${UAE_IBAN_LENGTH} characters. Got: ${iban.length}`,
    });
  }

  // Step 5: Full IBAN validation (MOD-97 checksum)
  const validationResult = validateIBAN(iban);

  if (!validationResult.valid && validationResult.errorCodes) {
    for (const errorCode of validationResult.errorCodes) {
      const errorMessage = mapIbanErrorCode(errorCode);
      // Avoid duplicate errors
      if (!errors.some(e => e.message === errorMessage)) {
        errors.push({
          code: ValidationErrorsIBAN[errorCode] || 'UNKNOWN_ERROR',
          message: errorMessage,
        });
      }
    }
  }

  // Step 6: Extract bank code if valid so far
  const bankCode = iban.length >= 7
    ? iban.substring(UAE_BANK_CODE_START, UAE_BANK_CODE_START + UAE_BANK_CODE_LENGTH)
    : null;

  const isValid = errors.length === 0;

  return {
    isValid,
    iban,
    ibanFormatted: formatIbanForDisplay(iban),
    bankCode,
    errors,
  };
}

/**
 * Format IBAN for display with spaces
 *
 * @param iban - Electronic format IBAN
 * @returns Formatted IBAN (e.g., "AE07 0331 2345 6789 0123 456")
 */
export function formatIbanForDisplay(iban: string): string {
  if (!iban) return '';

  // Group into chunks of 4, with last chunk potentially shorter
  const chunks: string[] = [];
  for (let i = 0; i < iban.length; i += 4) {
    chunks.push(iban.substring(i, Math.min(i + 4, iban.length)));
  }

  return chunks.join(' ');
}

/**
 * Extract bank code from IBAN
 *
 * @param iban - Electronic format IBAN
 * @returns 3-digit bank code or null if invalid
 */
export function extractBankCode(iban: string): string | null {
  const cleaned = electronicFormatIBAN(iban) || '';

  if (cleaned.length < UAE_BANK_CODE_START + UAE_BANK_CODE_LENGTH) {
    return null;
  }

  if (!cleaned.startsWith(UAE_COUNTRY_CODE)) {
    return null;
  }

  return cleaned.substring(
    UAE_BANK_CODE_START,
    UAE_BANK_CODE_START + UAE_BANK_CODE_LENGTH
  );
}

/**
 * Format IBAN to electronic format (no spaces, uppercase)
 *
 * @param rawIban - Input IBAN with potential spaces/lowercase
 * @returns Electronic format IBAN
 */
export function formatIban(rawIban: string): string {
  return electronicFormatIBAN(rawIban) || '';
}

/**
 * Batch validate multiple IBANs
 *
 * @param ibans - Array of IBANs to validate
 * @returns Array of validation results
 */
export function validateIbans(ibans: string[]): IbanValidationResult[] {
  return ibans.map(iban => validateUaeIban(iban));
}

/**
 * Check if IBAN belongs to a specific bank
 *
 * @param iban - Electronic format IBAN
 * @param bankCode - 3-digit bank code to check
 * @returns true if IBAN belongs to the bank
 */
export function isIbanFromBank(iban: string, bankCode: string): boolean {
  const extracted = extractBankCode(iban);
  return extracted === bankCode;
}

// ============================================
// HELPER FUNCTIONS
// ============================================

/**
 * Map ibantools error codes to human-readable messages
 */
function mapIbanErrorCode(errorCode: number): string {
  switch (errorCode) {
    case ValidationErrorsIBAN.NoIBANProvided:
      return 'IBAN is required';
    case ValidationErrorsIBAN.NoIBANCountry:
      return 'Invalid country code';
    case ValidationErrorsIBAN.WrongBBANLength:
      return 'Invalid account number length';
    case ValidationErrorsIBAN.WrongBBANFormat:
      return 'Invalid account number format';
    case ValidationErrorsIBAN.ChecksumNotNumber:
      return 'Check digits must be numeric';
    case ValidationErrorsIBAN.WrongIBANChecksum:
      return 'Invalid IBAN checksum (MOD-97 validation failed)';
    case ValidationErrorsIBAN.WrongAccountBankBranchChecksum:
      return 'Invalid bank/branch checksum';
    default:
      return 'Invalid IBAN format';
  }
}

// ============================================
// UAE BANK CODES REFERENCE
// ============================================

/**
 * Common UAE bank codes for reference
 * These are the 3-digit codes that appear in positions 5-7 of UAE IBANs
 */
export const UAE_BANK_CODES: Record<string, string> = {
  '033': 'Emirates NBD',
  '002': 'Abu Dhabi Commercial Bank (ADCB)',
  '035': 'First Abu Dhabi Bank (FAB)',
  '046': 'Mashreq Bank',
  '038': 'Dubai Islamic Bank (DIB)',
  '400': 'RAK Bank',
  '031': 'Commercial Bank of Dubai (CBD)',
  '013': 'Abu Dhabi Islamic Bank (ADIB)',
  '019': 'National Bank of Fujairah',
  '026': 'Emirates Islamic Bank',
  '044': 'Sharjah Islamic Bank',
  '042': 'United Arab Bank',
  '005': 'Bank of Baroda',
  '007': 'Habib Bank AG Zurich',
  '011': 'HSBC',
  '015': 'Citibank',
  '017': 'Standard Chartered',
};

/**
 * Get bank name from bank code
 *
 * @param bankCode - 3-digit bank code
 * @returns Bank name or 'Unknown Bank'
 */
export function getBankNameFromCode(bankCode: string): string {
  return UAE_BANK_CODES[bankCode] || 'Unknown Bank';
}
```

Follow existing utils pattern (decimal-math.util.ts) for consistent structure and documentation.
  </action>
  <verify>
    - `npx tsc --noEmit` compiles successfully
    - `validateUaeIban('AE070331234567890123456')` returns valid result
    - `validateUaeIban('AE12345')` returns invalid with length error
    - `validateUaeIban('GB82WEST12345698765432')` returns invalid with country error
  </verify>
  <done>IBAN validation utility with UAE-specific rules and bank code extraction</done>
</task>

</tasks>

<verification>
1. ibantools installed: `npm list ibantools`
2. TypeScript compiles: `npx tsc --noEmit`
3. Valid IBAN passes: `validateUaeIban('AE070331234567890123456').isValid === true`
4. Invalid country rejected: Non-AE IBAN returns country error
5. Invalid length rejected: Short/long IBAN returns length error
6. MOD-97 validation works: Checksum errors detected
</verification>

<success_criteria>
1. ibantools v4.x or v5.x installed as production dependency
2. validateUaeIban function returns IbanValidationResult with isValid, iban, bankCode, errors
3. UAE-specific validation (AE prefix, 23 characters) enforced before MOD-97
4. Bank code extraction works (positions 5-7)
5. Human-readable error messages for all validation failures
6. formatIbanForDisplay formats with spaces (AE07 0331 2345...)
</success_criteria>

<output>
After completion, create `.planning/phases/05-wps-payroll-compliance/05-02-SUMMARY.md`
</output>
