---
phase: 05-wps-payroll-compliance
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - web-erp-app/backend/src/services/payroll/bank-routing.service.ts
  - web-erp-app/backend/prisma/seeds/wps-agents.seed.ts
autonomous: true

must_haves:
  truths:
    - "WPS agents reference table stores UAE bank routing codes"
    - "Routing codes are 9 digits as per CBUAE specification"
    - "Bank lookup returns routing code for IBAN bank code"
    - "Reference data can be updated when CBUAE changes routing codes"
  artifacts:
    - path: "web-erp-app/backend/src/services/payroll/bank-routing.service.ts"
      provides: "WPS bank routing code service"
      exports: ["BankRoutingService", "getRoutingCodeForIban", "getWpsAgentByBankCode"]
    - path: "web-erp-app/backend/prisma/seeds/wps-agents.seed.ts"
      provides: "Seed data for UAE WPS agents (banks)"
      exports: ["seedWpsAgents"]
  key_links:
    - from: "bank-routing.service.ts"
      to: "WpsAgent model"
      via: "Prisma query"
      pattern: "prisma\\.wpsAgent\\."
---

<objective>
Create bank routing code service and seed data for UAE WPS agents. This enables mapping between employee IBAN bank codes and WPS routing codes required for SIF file generation.

Purpose: WPS-02 (Bank routing code configuration) - Allow configuration and lookup of WPS agent routing codes for salary transfers.

Output: BankRoutingService with routing code lookup and seed data for major UAE banks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-wps-payroll-compliance/05-RESEARCH.md
@.planning/phases/05-wps-payroll-compliance/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WPS agents seed data</name>
  <files>web-erp-app/backend/prisma/seeds/wps-agents.seed.ts</files>
  <action>
Create seed script for UAE WPS agents (banks with routing codes):

```typescript
/**
 * WPS Agents Seed Data
 *
 * Seeds the wps_agents table with UAE bank WPS routing codes.
 * These codes are assigned by CBUAE and used in SIF files for salary transfers.
 *
 * Sources:
 * - Central Bank of UAE (CBUAE) routing code list
 * - WPS agent documentation from various banks
 *
 * Note: Routing codes may change; update this seed when CBUAE publishes updates.
 *
 * @module wps-agents.seed
 */

import { PrismaClient } from '@prisma/client';
import { randomUUID } from 'crypto';

export interface WpsAgentSeedData {
  bankCode: string;       // 3-digit IBAN bank code
  routingCode: string;    // 9-digit WPS routing code
  bankName: string;
  bankNameArabic?: string;
  swiftCode?: string;
}

/**
 * UAE WPS Agent reference data
 *
 * Format:
 * - bankCode: 3 digits (from IBAN positions 5-7)
 * - routingCode: 9 digits (WPS agent routing code)
 */
export const WPS_AGENTS_DATA: WpsAgentSeedData[] = [
  {
    bankCode: '033',
    routingCode: '201000036',
    bankName: 'Emirates NBD',
    bankNameArabic: 'بنك الإمارات دبي الوطني',
    swiftCode: 'EABORAEADXB',
  },
  {
    bankCode: '002',
    routingCode: '200000023',
    bankName: 'Abu Dhabi Commercial Bank (ADCB)',
    bankNameArabic: 'بنك أبوظبي التجاري',
    swiftCode: 'ADCBAEAA',
  },
  {
    bankCode: '035',
    routingCode: '201000082',
    bankName: 'First Abu Dhabi Bank (FAB)',
    bankNameArabic: 'بنك أبوظبي الأول',
    swiftCode: 'NBABOREA',
  },
  {
    bankCode: '046',
    routingCode: '201000033',
    bankName: 'Mashreq Bank',
    bankNameArabic: 'بنك المشرق',
    swiftCode: 'BOMLAEAD',
  },
  {
    bankCode: '038',
    routingCode: '201000065',
    bankName: 'Dubai Islamic Bank (DIB)',
    bankNameArabic: 'بنك دبي الإسلامي',
    swiftCode: 'DUIBAEAD',
  },
  {
    bankCode: '400',
    routingCode: '203526101',
    bankName: 'RAK Bank',
    bankNameArabic: 'بنك رأس الخيمة الوطني',
    swiftCode: 'NABORAEA',
  },
  {
    bankCode: '031',
    routingCode: '201000030',
    bankName: 'Commercial Bank of Dubai (CBD)',
    bankNameArabic: 'بنك دبي التجاري',
    swiftCode: 'CBDUAEAD',
  },
  {
    bankCode: '013',
    routingCode: '200000070',
    bankName: 'Abu Dhabi Islamic Bank (ADIB)',
    bankNameArabic: 'مصرف أبوظبي الإسلامي',
    swiftCode: 'ABDIAEAD',
  },
  {
    bankCode: '019',
    routingCode: '200000090',
    bankName: 'National Bank of Fujairah',
    bankNameArabic: 'بنك الفجيرة الوطني',
    swiftCode: 'NBFOAEAD',
  },
  {
    bankCode: '026',
    routingCode: '201000058',
    bankName: 'Emirates Islamic Bank',
    bankNameArabic: 'مصرف الإمارات الإسلامي',
    swiftCode: 'MABORAEA',
  },
  {
    bankCode: '044',
    routingCode: '201000044',
    bankName: 'Sharjah Islamic Bank',
    bankNameArabic: 'مصرف الشارقة الإسلامي',
    swiftCode: 'NBSHAEAS',
  },
  {
    bankCode: '042',
    routingCode: '201000041',
    bankName: 'United Arab Bank',
    bankNameArabic: 'البنك العربي المتحد',
    swiftCode: 'UABORAEA',
  },
  {
    bankCode: '011',
    routingCode: '200000050',
    bankName: 'HSBC Middle East',
    bankNameArabic: 'إتش إس بي سي الشرق الأوسط',
    swiftCode: 'BBABORAD',
  },
  {
    bankCode: '017',
    routingCode: '200000060',
    bankName: 'Standard Chartered Bank',
    bankNameArabic: 'بنك ستاندرد تشارترد',
    swiftCode: 'SCBLUEAD',
  },
  {
    bankCode: '015',
    routingCode: '200000055',
    bankName: 'Citibank N.A.',
    bankNameArabic: 'سيتي بنك',
    swiftCode: 'CITIAEAD',
  },
  {
    bankCode: '029',
    routingCode: '201000025',
    bankName: 'Al Hilal Bank',
    bankNameArabic: 'مصرف الهلال',
    swiftCode: 'HLALAEADXXX',
  },
  {
    bankCode: '024',
    routingCode: '200000085',
    bankName: 'National Bank of Ras Al Khaimah (RAKBANK)',
    bankNameArabic: 'البنك الوطني لرأس الخيمة',
    swiftCode: 'NABORAEA',
  },
  {
    bankCode: '023',
    routingCode: '200000080',
    bankName: 'Bank of Sharjah',
    bankNameArabic: 'بنك الشارقة',
    swiftCode: 'BOSAAEAC',
  },
  {
    bankCode: '020',
    routingCode: '200000075',
    bankName: 'National Bank of Umm Al Qaiwain',
    bankNameArabic: 'بنك أم القيوين الوطني',
    swiftCode: 'NBUQAEAUUAQ',
  },
  {
    bankCode: '027',
    routingCode: '201000027',
    bankName: 'Ajman Bank',
    bankNameArabic: 'مصرف عجمان',
    swiftCode: 'AJMNAEAA',
  },
];

/**
 * Seed WPS agents (banks with routing codes)
 *
 * Uses upsert pattern for idempotency - safe to run multiple times.
 *
 * @param prisma - Prisma client instance
 * @returns Number of agents seeded
 */
export async function seedWpsAgents(prisma: PrismaClient): Promise<number> {
  console.log('[WPS Seed] Starting WPS agents seeding...');

  let count = 0;

  for (const agent of WPS_AGENTS_DATA) {
    await prisma.wpsAgent.upsert({
      where: { bankCode: agent.bankCode },
      update: {
        routingCode: agent.routingCode,
        bankName: agent.bankName,
        bankNameArabic: agent.bankNameArabic,
        swiftCode: agent.swiftCode,
        isActive: true,
        updatedAt: new Date(),
      },
      create: {
        id: randomUUID(),
        bankCode: agent.bankCode,
        routingCode: agent.routingCode,
        bankName: agent.bankName,
        bankNameArabic: agent.bankNameArabic,
        swiftCode: agent.swiftCode,
        isActive: true,
        effectiveFrom: new Date(),
      },
    });
    count++;
  }

  console.log(`[WPS Seed] Seeded ${count} WPS agents`);
  return count;
}

// Direct execution for CLI: npx ts-node prisma/seeds/wps-agents.seed.ts
if (require.main === module) {
  const prisma = new PrismaClient();
  seedWpsAgents(prisma)
    .then((count) => {
      console.log(`Successfully seeded ${count} WPS agents`);
      process.exit(0);
    })
    .catch((error) => {
      console.error('Failed to seed WPS agents:', error);
      process.exit(1);
    })
    .finally(() => prisma.$disconnect());
}
```

Note: Routing codes are examples; verify against CBUAE official list before production use.
  </action>
  <verify>
    - `npx ts-node prisma/seeds/wps-agents.seed.ts` runs successfully
    - `SELECT COUNT(*) FROM wps_agents` returns 20
  </verify>
  <done>WPS agents seed data created with major UAE banks</done>
</task>

<task type="auto">
  <name>Task 2: Create bank routing service</name>
  <files>web-erp-app/backend/src/services/payroll/bank-routing.service.ts</files>
  <action>
Create BankRoutingService for WPS routing code management:

```typescript
/**
 * Bank Routing Service
 *
 * Manages WPS bank routing codes for payroll processing.
 * Maps IBAN bank codes to WPS routing codes required for SIF files.
 *
 * WPS-02: Bank routing code configuration
 *
 * @module BankRoutingService
 */

import { PrismaClient } from '@prisma/client';
import { injectable, inject } from 'inversify';
import { TYPES } from '../../config/types';
import logger from '../logger.service';
import { extractBankCode, validateUaeIban } from '../../utils/iban-validation.util';

// ============================================
// TYPES
// ============================================

export interface WpsAgentInfo {
  id: string;
  bankCode: string;
  routingCode: string;
  bankName: string;
  bankNameArabic: string | null;
  swiftCode: string | null;
  isActive: boolean;
}

export interface RoutingCodeLookupResult {
  found: boolean;
  routingCode: string | null;
  bankName: string | null;
  error?: string;
}

export interface BankRoutingContext {
  companyId: string;
  userId: string;
}

// ============================================
// SERVICE
// ============================================

@injectable()
export class BankRoutingService {
  constructor(
    @inject(TYPES.PrismaClient) private prisma: PrismaClient
  ) {}

  /**
   * Get WPS routing code for an IBAN
   *
   * Extracts bank code from IBAN and looks up the corresponding WPS routing code.
   *
   * @param iban - UAE IBAN (23 characters)
   * @returns Routing code lookup result
   */
  async getRoutingCodeForIban(iban: string): Promise<RoutingCodeLookupResult> {
    // Validate IBAN first
    const validation = validateUaeIban(iban);
    if (!validation.isValid) {
      return {
        found: false,
        routingCode: null,
        bankName: null,
        error: validation.errors[0]?.message || 'Invalid IBAN',
      };
    }

    // Extract bank code
    const bankCode = validation.bankCode;
    if (!bankCode) {
      return {
        found: false,
        routingCode: null,
        bankName: null,
        error: 'Could not extract bank code from IBAN',
      };
    }

    // Look up WPS agent
    const agent = await this.getWpsAgentByBankCode(bankCode);
    if (!agent) {
      return {
        found: false,
        routingCode: null,
        bankName: null,
        error: `No WPS agent found for bank code ${bankCode}. Bank may not be registered with WPS.`,
      };
    }

    return {
      found: true,
      routingCode: agent.routingCode,
      bankName: agent.bankName,
    };
  }

  /**
   * Get WPS agent by bank code
   *
   * @param bankCode - 3-digit IBAN bank code
   * @returns WPS agent info or null
   */
  async getWpsAgentByBankCode(bankCode: string): Promise<WpsAgentInfo | null> {
    try {
      const agent = await this.prisma.wpsAgent.findFirst({
        where: {
          bankCode,
          isActive: true,
        },
      });

      if (!agent) {
        return null;
      }

      return {
        id: agent.id,
        bankCode: agent.bankCode,
        routingCode: agent.routingCode,
        bankName: agent.bankName,
        bankNameArabic: agent.bankNameArabic,
        swiftCode: agent.swiftCode,
        isActive: agent.isActive,
      };
    } catch (error) {
      logger.error('[BankRouting] Error fetching WPS agent:', error);
      throw new Error('Failed to fetch WPS agent');
    }
  }

  /**
   * Get WPS agent by routing code
   *
   * @param routingCode - 9-digit WPS routing code
   * @returns WPS agent info or null
   */
  async getWpsAgentByRoutingCode(routingCode: string): Promise<WpsAgentInfo | null> {
    try {
      const agent = await this.prisma.wpsAgent.findFirst({
        where: {
          routingCode,
          isActive: true,
        },
      });

      if (!agent) {
        return null;
      }

      return {
        id: agent.id,
        bankCode: agent.bankCode,
        routingCode: agent.routingCode,
        bankName: agent.bankName,
        bankNameArabic: agent.bankNameArabic,
        swiftCode: agent.swiftCode,
        isActive: agent.isActive,
      };
    } catch (error) {
      logger.error('[BankRouting] Error fetching WPS agent by routing code:', error);
      throw new Error('Failed to fetch WPS agent');
    }
  }

  /**
   * Get all active WPS agents
   *
   * @returns List of all active WPS agents
   */
  async getAllActiveWpsAgents(): Promise<WpsAgentInfo[]> {
    try {
      const agents = await this.prisma.wpsAgent.findMany({
        where: { isActive: true },
        orderBy: { bankName: 'asc' },
      });

      return agents.map(agent => ({
        id: agent.id,
        bankCode: agent.bankCode,
        routingCode: agent.routingCode,
        bankName: agent.bankName,
        bankNameArabic: agent.bankNameArabic,
        swiftCode: agent.swiftCode,
        isActive: agent.isActive,
      }));
    } catch (error) {
      logger.error('[BankRouting] Error fetching WPS agents:', error);
      throw new Error('Failed to fetch WPS agents');
    }
  }

  /**
   * Add or update a WPS agent
   *
   * Used by admin to update routing codes when CBUAE changes them.
   *
   * @param context - User context for audit
   * @param agent - WPS agent data
   * @returns Created/updated agent
   */
  async upsertWpsAgent(
    context: BankRoutingContext,
    agent: Omit<WpsAgentInfo, 'id' | 'isActive'>
  ): Promise<WpsAgentInfo> {
    try {
      const result = await this.prisma.wpsAgent.upsert({
        where: { bankCode: agent.bankCode },
        update: {
          routingCode: agent.routingCode,
          bankName: agent.bankName,
          bankNameArabic: agent.bankNameArabic,
          swiftCode: agent.swiftCode,
          isActive: true,
          updatedAt: new Date(),
        },
        create: {
          bankCode: agent.bankCode,
          routingCode: agent.routingCode,
          bankName: agent.bankName,
          bankNameArabic: agent.bankNameArabic,
          swiftCode: agent.swiftCode,
          isActive: true,
          effectiveFrom: new Date(),
        },
      });

      logger.audit('[BankRouting] WPS agent upserted', {
        userId: context.userId,
        companyId: context.companyId,
        bankCode: agent.bankCode,
        routingCode: agent.routingCode,
      });

      return {
        id: result.id,
        bankCode: result.bankCode,
        routingCode: result.routingCode,
        bankName: result.bankName,
        bankNameArabic: result.bankNameArabic,
        swiftCode: result.swiftCode,
        isActive: result.isActive,
      };
    } catch (error) {
      logger.error('[BankRouting] Error upserting WPS agent:', error);
      throw new Error('Failed to upsert WPS agent');
    }
  }

  /**
   * Deactivate a WPS agent
   *
   * Soft delete - marks agent as inactive rather than deleting.
   *
   * @param context - User context for audit
   * @param bankCode - Bank code to deactivate
   * @returns true if deactivated
   */
  async deactivateWpsAgent(
    context: BankRoutingContext,
    bankCode: string
  ): Promise<boolean> {
    try {
      await this.prisma.wpsAgent.update({
        where: { bankCode },
        data: {
          isActive: false,
          effectiveTo: new Date(),
          updatedAt: new Date(),
        },
      });

      logger.audit('[BankRouting] WPS agent deactivated', {
        userId: context.userId,
        companyId: context.companyId,
        bankCode,
      });

      return true;
    } catch (error) {
      logger.error('[BankRouting] Error deactivating WPS agent:', error);
      throw new Error('Failed to deactivate WPS agent');
    }
  }

  /**
   * Validate routing code format
   *
   * WPS routing codes are 9 digits.
   *
   * @param routingCode - Routing code to validate
   * @returns true if valid format
   */
  validateRoutingCode(routingCode: string): boolean {
    return /^\d{9}$/.test(routingCode);
  }

  /**
   * Get routing codes for multiple IBANs
   *
   * Batch lookup for payroll processing efficiency.
   *
   * @param ibans - Array of IBANs
   * @returns Map of IBAN to routing code lookup result
   */
  async getRoutingCodesForIbans(
    ibans: string[]
  ): Promise<Map<string, RoutingCodeLookupResult>> {
    const results = new Map<string, RoutingCodeLookupResult>();

    // Extract unique bank codes
    const bankCodesSet = new Set<string>();
    const ibanToBankCode = new Map<string, string>();

    for (const iban of ibans) {
      const bankCode = extractBankCode(iban);
      if (bankCode) {
        bankCodesSet.add(bankCode);
        ibanToBankCode.set(iban, bankCode);
      } else {
        results.set(iban, {
          found: false,
          routingCode: null,
          bankName: null,
          error: 'Invalid IBAN format',
        });
      }
    }

    // Batch fetch agents
    const agents = await this.prisma.wpsAgent.findMany({
      where: {
        bankCode: { in: Array.from(bankCodesSet) },
        isActive: true,
      },
    });

    const agentMap = new Map(agents.map(a => [a.bankCode, a]));

    // Map results
    for (const iban of ibans) {
      if (results.has(iban)) continue; // Already has error

      const bankCode = ibanToBankCode.get(iban);
      if (!bankCode) continue;

      const agent = agentMap.get(bankCode);
      if (agent) {
        results.set(iban, {
          found: true,
          routingCode: agent.routingCode,
          bankName: agent.bankName,
        });
      } else {
        results.set(iban, {
          found: false,
          routingCode: null,
          bankName: null,
          error: `No WPS agent for bank code ${bankCode}`,
        });
      }
    }

    return results;
  }
}
```

Add to DI container in types.ts:
```typescript
TYPES.BankRoutingService: Symbol.for('BankRoutingService')
```
  </action>
  <verify>
    - `npx tsc --noEmit` compiles successfully
    - Service can be instantiated with Prisma client
    - getRoutingCodeForIban returns correct routing code for valid IBAN
  </verify>
  <done>BankRoutingService created with IBAN-to-routing lookup and batch processing</done>
</task>

<task type="auto">
  <name>Task 3: Add BankRoutingService to DI container</name>
  <files>web-erp-app/backend/src/config/types.ts, web-erp-app/backend/src/config/container.ts</files>
  <action>
1. Add BankRoutingService symbol to types.ts:
   ```typescript
   BankRoutingService: Symbol.for('BankRoutingService'),
   ```

2. Register in container.ts:
   ```typescript
   import { BankRoutingService } from '../services/payroll/bank-routing.service';

   container.bind<BankRoutingService>(TYPES.BankRoutingService)
     .to(BankRoutingService)
     .inSingletonScope();
   ```

3. Run WPS agents seed if not already:
   ```bash
   npx ts-node prisma/seeds/wps-agents.seed.ts
   ```
  </action>
  <verify>
    - Service resolves from container: `container.get<BankRoutingService>(TYPES.BankRoutingService)`
    - No circular dependency errors
  </verify>
  <done>BankRoutingService registered in DI container</done>
</task>

</tasks>

<verification>
1. WPS agents seeded: `SELECT COUNT(*) FROM wps_agents` returns 20
2. Service compiles: `npx tsc --noEmit`
3. Routing lookup works: getRoutingCodeForIban('AE070331234567890123456') returns '201000036'
4. DI container resolves: BankRoutingService instantiates correctly
5. Batch lookup efficient: getRoutingCodesForIbans handles multiple IBANs
</verification>

<success_criteria>
1. wps_agents table populated with 20+ UAE bank routing codes
2. BankRoutingService.getRoutingCodeForIban validates IBAN and returns routing code
3. Routing codes are 9 digits as per WPS specification
4. Bank names available in Arabic for bilingual support
5. Service registered in DI container for dependency injection
6. Batch lookup method for efficient payroll processing
</success_criteria>

<output>
After completion, create `.planning/phases/05-wps-payroll-compliance/05-03-SUMMARY.md`
</output>
